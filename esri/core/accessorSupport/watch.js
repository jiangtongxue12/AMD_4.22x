// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../ArrayPool ../lang ../ReentrantObjectPool ../scheduling ../SetUtils ../uid ./get ./trackingUtils ./utils".split(" "),function(k,E,w,F,G,H,x,z,q,r){function t(b){h.delete(b);h.add(b);u||(u=G.schedule(A))}function B(b){if(!b.removed){var d=b.oldValue,c=b.getValue();b.equals(d,c)||(b.oldValue=c,b.notify(c,d))}}function A(){let b=10;for(;u&&b--;){u=null;const d=I(),c=v.acquire();for(const a of d){const e=a.uid;B(a);e===a.uid&&a.removed&&c.push(a)}for(const a of h)a.removed&&(c.push(a),
h.delete(a));for(const a of c)n.pool.release(a);v.release(c);v.release(d);y.forEach(a=>a())}}function I(){const b=v.acquire();b.length=h.size;let d=0;for(const c of h)b[d]=c,++d;h.clear();return b}function J(b,d,c){let a=r.parse(b,d,c,(e,g,l)=>{let f,m,p=q.reactionDeferred(()=>z.valueOf(e,g),(K,L)=>{e.__accessor__.destroyed||f&&f.uid!==m?a.remove():(f||(f=n.acquireUntracked(K,l,L,e,g),m=f.uid),t(f))});return{remove:r.once(()=>{p.remove();f&&(f.uid!==m||f.removed||(f.removed=!0,t(f)),f=null);a=p=null})}});
return a}function M(b,d,c){const a=r.parse(b,d,c,(e,g,l)=>{let f=!1;return q.reaction(()=>z.valueOf(e,g),(m,p)=>{e.__accessor__.destroyed?a.remove():f||(f=!0,w.equals(p,m)||l.call(e,m,p,g,e),f=!1)})});return a}function C(b,d,c,a=!1){return!b.__accessor__||b.__accessor__.destroyed?{remove(){}}:a?M(b,d,c):J(b,d,c)}function N(b,d,c){let a,e,g=q.reactionDeferred(b,(l,f)=>{a&&a.uid!==e?g.remove():(a||(a=n.acquireTracked(l,d,f,c),e=a.uid),t(a))});return{remove:r.once(()=>{g.remove();a&&(a.uid!==e||a.removed||
(a.removed=!0,t(a)),a=null);g=null})}}function D(b,d,c){let a=!1;return q.reaction(b,(e,g)=>{a||(a=!0,c(g,e)||d(e,g),a=!1)})}let n=function(){function b(){this.uid=x.generateUID();this.removed=!1;this.equals=this.path=this.target=this.getValue=this.callback=this.oldValue=this.type=null}b.acquireUntracked=function(c,a,e,g,l){return this.pool.acquire(0,c,a,e,g,l,w.equals)};b.acquireTracked=function(c,a,e,g){return this.pool.acquire(1,c,a,e,null,null,g)};var d=b.prototype;d.notify=function(c,a){0===
this.type?this.callback.call(this.target,c,a,this.path,this.target):this.callback.call(null,c,a)};d.acquire=function(c,a,e,g,l,f,m){this.uid=x.generateUID();this.removed=!1;this.type=c;this.oldValue=a;this.callback=e;this.getValue=g;this.target=l;this.path=f;this.equals=m};d.release=function(){this.target=this.path=this.oldValue=this.callback=this.getValue=null;this.uid=x.generateUID();this.removed=!0};return b}();n.pool=new F.ReentrantObjectPool(n);const v=new E,h=new Set;let u;const y=new Set;k.afterDispatch=
function(b){y.add(b);return{remove(){y.delete(b)}}};k.default=C;k.dispatch=A;k.dispatchTarget=function(b){const d=Array.from(h);for(let c=0;c<d.length;c++){const a=d[c];a.target===b&&(B(a),h.delete(a))}};k.isValueInUse=function(b){return H.someSet(h,d=>d.oldValue===b)};k.removeTarget=function(b){for(const d of h.values())d.target===b&&(d.removed=!0)};k.syncWatchTracked=D;k.watch=C;k.watchTracked=function(b,d,c=!1,a=w.equals){return c?D(b,d,a):N(b,d,a)};Object.defineProperty(k,"__esModule",{value:!0})});