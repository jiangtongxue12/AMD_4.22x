// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../core/Logger ../../core/maybe ./checkWebGLError ./enums ./Renderbuffer ./Texture ./Util".split(" "),function(y,q,r,z,t,u,p,w){function n(k){return"type"in k&&"texture"===k.type}function x(k,f){void 0!==f.width&&0<=f.width&&void 0!==f.height&&0<=f.height?f.width===k.width&&f.height===k.height||console.error("Renderbuffer dimensions must match the framebuffer's!"):(f.width=k.width,f.height=k.height)}const A=q.getLogger("esri.views.webgl.FrameBufferObject");
q=function(){function k(a,b,c=null,e=null){this._context=a;this._stencilAttachment=this._depthAttachment=this._glName=null;this._colorAttachments=new Map;this._initialized=!1;this._desc={...b};a.instanceCounter.increment(t.ResourceType.Framebuffer,this);if(r.isSome(c))for(Array.isArray(c)||(c=[c]),b=0;b<c.length;++b){var m,d;const g=c[b];let l;n(g)?(l=g.descriptor,this._colorAttachments.set(36064+b,g)):(l=g,this._colorAttachments.set(36064+b,new p(a,g)));0!==(null==(m=this._desc)?void 0:m.colorTarget)&&
2!==(null==(d=this._desc)?void 0:d.colorTarget)&&console.error("Framebuffer is initialized with a texture however the descriptor indicates using a renderbuffer color attachment!");this._validateColorAttachmentPoint(36064+b);this._validateTextureDimensions(l,this._desc)}if(e instanceof u){var h;a=null!=(h=this._desc.depthStencilTarget)?h:3;2===a?this._stencilAttachment=e:1===a||3===a?this._depthAttachment=e:console.error('If a Renderbuffer is provided, "depthStencilTarget" must be one of STENCIL_RENDER_BUFFER, DEPTH_RENDER_BUFFER or DEPTH_STENCIL_RENDER_BUFFER');
x(e.descriptor,this._desc)}else if(r.isSome(e)){this._context.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture as an attachment!");let g;n(e)?(this._depthStencilTexture=e,g=e.descriptor):this._depthStencilTexture=new p(this._context,e);this._validateTextureDimensions(g,this._desc)}}var f=k.prototype;f.dispose=function(){if(this._desc){var a=this._context.getBoundFramebufferObject();this._disposeColorAttachments();
this._disposeDepthStencilAttachments();this._glName&&(this._context.gl.deleteFramebuffer(this._glName),this._glName=null);this._context.bindFramebuffer(a);this._context.instanceCounter.decrement(t.ResourceType.Framebuffer,this);this._desc=null}};f.getColorTexture=function(a){return(a=this._colorAttachments.get(a))&&n(a)?a:null};f.framebufferTexture2D=function(a,b,c=36064,e=3553,m=0){b.framebufferTexture2D(b.FRAMEBUFFER,c,e,a,m)};f.attachColorTexture=function(a,b=36064){a&&(this._validateColorAttachmentPoint(b),
this._validateTextureDimensions(a.descriptor,this._desc),this._disposeColorAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this.framebufferTexture2D(a.glName,this._context.gl,b)),this._colorAttachments.set(b,a))};f.detachColorTexture=function(a=36064){const b=this._colorAttachments.get(a);if(n(b))return this._initialized&&(this._context.bindFramebuffer(this),this.framebufferTexture2D(null,this._context.gl,a)),this._colorAttachments.delete(a),b};f.attachDepthStencilTexture=function(a){if(!r.isNone(a)){var b=
a.descriptor;34041!==b.pixelFormat&&console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!");34042!==b.dataType&&console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!");this._context.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture!");this._validateTextureDimensions(b,this._desc);this._desc.depthStencilTarget&&4!==this._desc.depthStencilTarget&&(this._desc.depthStencilTarget=
4);this._disposeDepthStencilAttachments();this._initialized&&(this._context.bindFramebuffer(this),this.framebufferTexture2D(a.glName,this._context.gl,t.DepthStencilAttachment));this._depthStencilTexture=a}};f.detachDepthStencilTexture=function(){const a=this._depthStencilTexture;a&&this._initialized&&(this._context.bindFramebuffer(this),this.framebufferTexture2D(null,this._context.gl,t.DepthStencilAttachment));this._depthStencilTexture=null;return a};f.attachDepthStencilBuffer=function(a){if(!r.isNone(a)){var b=
a.descriptor;34041!==b.internalFormat&&33189!==b.internalFormat&&console.error("Depth/Stencil buffer must have correct internalFormat");x(b,this._desc);this._disposeDepthStencilAttachments();this._desc.depthStencilTarget=34041===b.internalFormat?3:1;this._initialized&&(this._context.bindFramebuffer(this),b=this._context.gl,b.framebufferRenderbuffer(b.FRAMEBUFFER,1===this._desc.depthStencilTarget?b.DEPTH_ATTACHMENT:b.DEPTH_STENCIL_ATTACHMENT,b.RENDERBUFFER,a.glName));this._depthAttachment=a}};f.detachDepthStencilBuffer=
function(){const a=this._context.gl,b=this._depthAttachment;b&&this._initialized&&(this._context.bindFramebuffer(this),a.framebufferRenderbuffer(a.FRAMEBUFFER,1===this._desc.depthStencilTarget?a.DEPTH_ATTACHMENT:a.DEPTH_STENCIL_ATTACHMENT,a.RENDERBUFFER,null));this._depthAttachment=null;return b};f.detachAll=function(){this.detachColorTexture();this.detachDepthStencilBuffer();this.detachDepthStencilTexture()};f.copyToTexture=function(a,b,c,e,m,d,h){(0>a||0>b||0>m||0>d)&&console.error("Offsets cannot be negative!");
(0>=c||0>=e)&&console.error("Copy width and height must be greater than zero!");var g=this._desc;const l=h.descriptor;3553!==h.descriptor.target&&console.error("Texture target must be TEXTURE_2D!");(a+c>g.width||b+e>g.height||m+c>l.width||d+e>l.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");g=this._context;h=g.bindTexture(h,p.TEXTURE_UNIT_FOR_UPDATES);g.bindFramebuffer(this);g.gl.copyTexSubImage2D(3553,0,m,d,a,b,c,e);g.bindTexture(h,
p.TEXTURE_UNIT_FOR_UPDATES)};f.readPixels=function(a,b,c,e,m,d,h){(0>=c||0>=e)&&console.error("Copy width and height must be greater than zero!");h||console.error("Target memory is not initialized!");this._context.bindFramebuffer(this);this._context.gl.readPixels(a,b,c,e,m,d,h)};f.resize=function(a,b){const c=this._desc;if(c.width!==a||c.height!==b)if(this._initialized){c.width=a;c.height=b;this._colorAttachments.forEach(e=>{e&&e.resize(a,b)});if(null!=this._depthStencilTexture)this._depthStencilTexture.resize(a,
b);else if(this._depthAttachment||this._stencilAttachment)this._depthAttachment&&this._depthAttachment.resize(a,b),this._stencilAttachment&&this._stencilAttachment.resize(a,b);this._context.getBoundFramebufferObject()===this&&this._context.bindFramebuffer(null);this._initialized=!1}else c.width=a,c.height=b,this._colorAttachments.forEach(e=>{e&&e.resize(a,b)}),this._depthStencilTexture&&this._depthStencilTexture.resize(a,b)};f.initializeAndBind=function(a=3553){var b,c,e,m;const d=this._context.gl;
if(this._initialized)d.bindFramebuffer(d.FRAMEBUFFER,this.glName);else{this._glName&&d.deleteFramebuffer(this._glName);var h=this._context,g=d.createFramebuffer(),l=this._desc,B=null!=(b=l.colorTarget)?b:1;b=null!=(c=l.width)?c:1;c=null!=(e=l.height)?e:1;d.bindFramebuffer(d.FRAMEBUFFER,g);0===this._colorAttachments.size&&(0===B?this._colorAttachments.set(36064,new p(h,{target:2===this.descriptor.colorTarget?34067:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:l.width,height:l.height})):
(e=new u(h,{internalFormat:32854,width:b,height:c}),this._colorAttachments.set(36064,e)));this._colorAttachments.forEach((v,C)=>{v&&(n(v)?this.framebufferTexture2D(v.glName,d,C,a):d.framebufferRenderbuffer(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.RENDERBUFFER,v.glName))});e=null!=(m=l.depthStencilTarget)?m:0;switch(e){case 1:case 3:this._depthAttachment||(this._depthAttachment=new u(h,{internalFormat:1===l.depthStencilTarget?33189:34041,width:b,height:c}));d.framebufferRenderbuffer(d.FRAMEBUFFER,1===e?
d.DEPTH_ATTACHMENT:d.DEPTH_STENCIL_ATTACHMENT,d.RENDERBUFFER,this._depthAttachment.glName);break;case 2:this._stencilAttachment||(this._stencilAttachment=new u(h,{internalFormat:36168,width:b,height:c}));d.framebufferRenderbuffer(d.FRAMEBUFFER,d.STENCIL_ATTACHMENT,d.RENDERBUFFER,this._stencilAttachment.glName);break;case 4:this._depthStencilTexture||(h.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture as an attachment!"),
this._depthStencilTexture=new p(h,{target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,wrapMode:33071,width:b,height:c})),this.framebufferTexture2D(this._depthStencilTexture.glName,d,d.DEPTH_STENCIL_ATTACHMENT,a)}z.webglValidateShadersEnabled()&&d.checkFramebufferStatus(d.FRAMEBUFFER)!==d.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!");this._glName=g;this._initialized=!0}};f._disposeColorAttachments=function(){this._colorAttachments.forEach((a,b)=>{if(n(a))this._initialized&&
(this._context.bindFramebuffer(this),this.framebufferTexture2D(null,this._context.gl,b)),a.dispose();else if(a instanceof WebGLRenderbuffer){const c=this._context.gl;this._initialized&&(this._context.bindFramebuffer(this),c.framebufferRenderbuffer(c.FRAMEBUFFER,b,c.RENDERBUFFER,null));this._context.gl.deleteRenderbuffer(a)}});this._colorAttachments.clear()};f._disposeDepthStencilAttachments=function(){const a=this._context.gl;this._depthAttachment&&(this._initialized&&(this._context.bindFramebuffer(this),
a.framebufferRenderbuffer(a.FRAMEBUFFER,1===this._desc.depthStencilTarget?a.DEPTH_ATTACHMENT:a.DEPTH_STENCIL_ATTACHMENT,a.RENDERBUFFER,null)),this._depthAttachment.dispose(),this._depthAttachment=null);this._stencilAttachment&&(this._initialized&&(this._context.bindFramebuffer(this),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.STENCIL_ATTACHMENT,a.RENDERBUFFER,null)),this._stencilAttachment.dispose(),this._stencilAttachment=null);this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),
this.framebufferTexture2D(null,a,a.DEPTH_STENCIL_ATTACHMENT)),this._depthStencilTexture.dispose(),this._depthStencilTexture=null)};f._validateTextureDimensions=function(a,b){3553!==a.target&&34067!==a.target&&console.error("Texture type must be TEXTURE_2D or TEXTURE_CUBE_MAP!");void 0!==b.width&&0<=b.width&&void 0!==b.height&&0<=b.height?b.width===a.width&&b.height===a.height||console.error("Color attachment texture must match the framebuffer's!"):(b.width=a.width,b.height=a.height)};f._validateColorAttachmentPoint=
function(a){if(-1===k._MAX_COLOR_ATTACHMENTS){const b=this._context.capabilities.drawBuffers;k._MAX_COLOR_ATTACHMENTS=b?this._context.gl.getParameter(b.MAX_COLOR_ATTACHMENTS):1}a-=36064;a+1>k._MAX_COLOR_ATTACHMENTS&&A.error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${a+1}. Implementation supports up to ${k._MAX_COLOR_ATTACHMENTS} color attachments`)};y._createClass(k,[{key:"glName",get:function(){return this._glName}},{key:"descriptor",get:function(){return this._desc}},
{key:"colorTexture",get:function(){const a=this._colorAttachments.get(36064);return a&&n(a)?a:null}},{key:"colorAttachment",get:function(){return this._colorAttachments.get(36064)}},{key:"depthStencilAttachment",get:function(){return this._depthStencilTexture||this._depthAttachment||this._stencilAttachment}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"width",get:function(){return this._desc.width}},{key:"height",get:function(){return this._desc.height}},{key:"gpuMemoryUsage",
get:function(){return w.getGpuMemoryUsage(this.colorAttachment)+w.getGpuMemoryUsage(this.depthStencilAttachment)}}]);return k}();q._MAX_COLOR_ATTACHMENTS=-1;return q});