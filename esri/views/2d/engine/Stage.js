// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/Error ../../../core/events ../../../core/has ../../../core/maybe ../../../core/scheduling ../../../core/watchUtils ../../../chunks/common ../../../chunks/mat2d ../../../chunks/mat2df64 ../../../chunks/mat3f32 ../../../chunks/vec2 ../../../chunks/vec2f64 ../../../symbols/cim/CIMResourceManager ../../webgl/BufferObject ../../webgl/FramebufferObject ../../webgl/checkWebGLError ../../webgl/enums ../../../chunks/builtins ../../webgl/programUtils ../../webgl/Texture ../../webgl/VertexArrayObject ../../webgl/context-util ./Container ./webgl/enums ./webgl/Painter ./webgl/Profiler ./webgl/shaders/StencilPrograms ../support/Timeline ../../support/screenshotUtils ../../webgl/RenderingContext".split(" "),
function(z,q,J,K,D,L,M,N,O,A,P,Q,m,t,R,E,F,G,da,ea,S,fa,T,U,H,u,V,W,I,X,B,Y){G=function(C){function v(a,b){var c=C.call(this)||this;c._trash=new Set;c._clipData=new Float32Array(8);c._upperLeft=t.create();c._upperRight=t.create();c._lowerLeft=t.create();c._lowerRight=t.create();c._mat2=P.create();c._clipRendererInitialized=!1;c._renderRemainingTime=0;c._lastFrameRenderTime=0;c.renderRequested=!1;c.stage=q._assertThisInitialized(c);c._stationary=!0;const {canvas:d=document.createElement("canvas"),
alpha:e=!0,stencil:k=!0,contextOptions:f={}}=b;c._canvas=d;const g=U.createContextOrErrorHTML(d,1,{alpha:e,antialias:!1,depth:!0,stencil:k});c.context=new Y.RenderingContext(L.isSome(g)?g:null,f);c.resourceManager=new R;c.painter=new V(c.context,q._assertThisInitialized(c),c.resourceManager);D("esri-2d-profiler")&&(c._debugOutput=document.createElement("div"),c._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),a.appendChild(c._debugOutput));c._renderParameters=
{drawPhase:0,state:c.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:c.context,painter:c.painter,timeline:b.timeline||new X.Timeline,renderingOptions:b.renderingOptions,requireFBO:!1,profiler:new W.Profiler(c.context,c._debugOutput),dataUploadCounter:0};c._taskHandle=M.addFrameTask({render:l=>c.renderFrame(l)});c._taskHandle.pause();c._lostWebGLContextHandle=K.on(d,"webglcontextlost",()=>{c.emit("webgl-error",
{error:new J("webgl-context-lost")})});d.setAttribute("style","width: 100%; height:100%; display:block;");a.appendChild(d);return c}q._inheritsLoose(v,C);var h=v.prototype;h.destroy=function(){this.removeAllChildren();this._emptyTrash();this._taskHandle.remove();this._boundFBO=this._taskHandle=null;this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null);this._clipVAO&&(this._clipVAO.dispose(),this._clipVBO=this._clipVAO=null);this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=
null);this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null);this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas);this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput);this.highlightOptions=null;this.resourceManager.destroy();this.painter.dispose();this.context.dispose();this._canvas=null};h.trashDisplayObject=function(a){this._trash.add(a);this.requestRender()};h.untrashDisplayObject=
function(a){return this._trash.delete(a)};h.requestRender=function(){this._renderRemainingTime=2E3;this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())};h.renderFrame=function(a){this._renderRemainingTime-=this._lastFrameRenderTime?a.time-this._lastFrameRenderTime:0;0>=this._renderRemainingTime&&this._taskHandle.pause();this._lastFrameRenderTime=a.time;this.renderRequested=!1;this._renderParameters.state=this._state;this._renderParameters.stationary=this.stationary;
this._renderParameters.pixelRatio=window.devicePixelRatio;this._renderParameters.globalOpacity=1;this._renderParameters.time=a.time;this._renderParameters.deltaTime=a.deltaTime;this._renderParameters.effects=null;this.processRender(this._renderParameters);this._emptyTrash();this.emit("post-render")};h._createTransforms=function(){return{dvs:Q.create()}};h.renderChildren=function(a){for(const b of this.children)b.beforeRender(a);this._renderChildren(this.children,a);for(const b of this.children)b.afterRender(a)};
h._renderChildren=function(a,b){const c=this.context;b.profiler.recordStart("drawLayers");b.dataUploadCounter=0;this._beforeRenderChildren(b);b.drawPhase=u.WGLDrawPhase.MAP;this.painter.beforeRenderLayers(c,this.background);for(const d of a)d.processRender(b);this.painter.renderLayers(c);b.drawPhase=u.WGLDrawPhase.HIGHLIGHT;this.painter.beforeRenderLayers(c);for(const d of a)d.processRender(b);this.painter.renderLayers(c);if(this._isLabelDrawPhaseRequired(a)){b.drawPhase=u.WGLDrawPhase.LABEL;this.painter.beforeRenderLayers(c);
for(const d of a)d.processRender(b);this.painter.renderLayers(c)}if(D("esri-tiles-debug")){b.drawPhase=u.WGLDrawPhase.DEBUG;this.painter.beforeRenderLayers(c);for(const d of a)d.processRender(b);this.painter.renderLayers(c)}b.profiler.recordEnd("drawLayers");this._afterRenderChildren()};h._beforeRenderChildren=function(a){const {context:b}=this,{state:c,pixelRatio:d}=a;b.enforceState();b.setClearDepth(1);b.setClearColor(0,0,0,0);b.clear(b.gl.COLOR_BUFFER_BIT|b.gl.DEPTH_BUFFER_BIT);const {size:e,rotation:k}=
c;var f=Math.round(e[0]*d);a=Math.round(e[1]*d);this._boundFBO=b.getBoundFramebufferObject();if(c.spatialReference&&(c.spatialReference._isWrappable?c.spatialReference._isWrappable():c.spatialReference.isWrappable)){var g=O.toRadian(k),l=Math.abs(Math.cos(g)),n=Math.abs(Math.sin(g)),p=Math.round(c.worldScreenWidth);if(Math.round(f*l+a*n)<=p)this._clipFrame=!1;else{this._clipFBO&&this._clipFBO.width===f&&this._clipFBO.height===a||(this._clipFBO=new F(b,{colorTarget:0,depthStencilTarget:3,width:f,height:a}));
var Z=(this.state.padding.left-this.state.padding.right)/2,aa=(this.state.padding.bottom-this.state.padding.top)/2,ba=.5*f,ca=.5*a,w=1/f,x=1/a;p=.5*p*d;var y=.5*(f*n+a*l);f=this._upperLeft;l=this._upperRight;n=this._lowerLeft;var r=this._lowerRight;m.set(f,-p,-y);m.set(l,p,-y);m.set(n,-p,y);m.set(r,p,y);A.identity(this._mat2);A.translate(this._mat2,this._mat2,[ba+Z,ca-aa]);0!==k&&A.rotate(this._mat2,this._mat2,g);m.transformMat2d(f,f,this._mat2);m.transformMat2d(l,l,this._mat2);m.transformMat2d(n,
n,this._mat2);m.transformMat2d(r,r,this._mat2);g=this._clipData;g.set([2*n[0]*w-1,2*(a-n[1])*x-1,2*r[0]*w-1,2*(a-r[1])*x-1,2*f[0]*w-1,2*(a-f[1])*x-1,2*l[0]*w-1,2*(a-l[1])*x-1]);this._clipRendererInitialized||this._initializeClipRenderer(b);this._clipVBO.setData(g);this._boundFBO=b.getBoundFramebufferObject();b.bindFramebuffer(this._clipFBO);b.setDepthWriteEnabled(!0);b.setStencilWriteMask(255);b.setClearColor(0,0,0,0);b.setClearDepth(1);b.setClearStencil(0);b.clear(b.gl.COLOR_BUFFER_BIT|b.gl.DEPTH_BUFFER_BIT|
b.gl.STENCIL_BUFFER_BIT);b.setDepthWriteEnabled(!1);this._clipFrame=!0}}else this._clipFrame=!1};h._afterRenderChildren=function(){const a=this.context;a.logIno();if(this._clipFrame&&this._clipRendererInitialized){a.bindFramebuffer(this._boundFBO);this._boundFBO=null;a.bindVAO(this._clipVAO);a.useProgram(this._clipStencilProgram);a.setDepthWriteEnabled(!1);a.setDepthTestEnabled(!1);a.setStencilTestEnabled(!0);a.setBlendingEnabled(!1);a.setColorMask(!1,!1,!1,!1);a.setStencilOp(7680,7680,7681);a.setStencilWriteMask(255);
a.setStencilFunction(519,1,255);a.drawElements(4,6,5123,0);a.bindVAO();a.setColorMask(!0,!0,!0,!0);if(null!=this.background){const {r:b,g:c,b:d,a:e}=this.background.color;a.setClearColor(e*b/255,e*c/255,e*d/255,e)}else a.setClearColor(0,0,0,0);a.clear(a.gl.COLOR_BUFFER_BIT);a.setBlendingEnabled(!0);a.setStencilFunction(514,1,255);this.painter.blitTexture(a,this._clipFBO.colorTexture,9728,1);a.setStencilTestEnabled(!1)}};h.doRender=function(a){const b=this.context,{state:c,pixelRatio:d}=a;this._resizeCanvas(a);
this.context.enforceState();b.setViewport(0,0,d*c.size[0],d*c.size[1]);b.setDepthWriteEnabled(!0);b.setStencilWriteMask(255);C.prototype.doRender.call(this,a)};h.takeScreenshot=function(){var a=q._asyncToGenerator(function*(b){const {framebufferWidth:c,framebufferHeight:d}={framebufferWidth:Math.round(this._renderParameters.state.size[0]*b.resolutionScale),framebufferHeight:Math.round(this._renderParameters.state.size[1]*b.resolutionScale)};var e=this.context,k=this._state.clone();if(null!=b.rotation){var f=
k.viewpoint;k.viewpoint.rotation=b.rotation;k.viewpoint=f}var g={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:k,pixelRatio:1,time:Date.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1};const l=new F(e,{colorTarget:0,depthStencilTarget:3,width:c,height:d});k=e.getBoundFramebufferObject();f=e.getViewport();e.bindFramebuffer(l);e.setViewport(0,0,c,d);this._renderChildren(b.children,g);g=this._readbackScreenshot({...b.cropArea,y:d-(b.cropArea.y+b.cropArea.height)});
e.bindFramebuffer(k);e.setViewport(f.x,f.y,f.width,f.height);this.requestRender();1===b.outputScale?e=g:(e=new ImageData(Math.round(g.width*b.outputScale),Math.round(g.height*b.outputScale)),B.resampleHermite(g,e,!0));return B.encodeResult(e,{format:b.format,quality:b.quality,rotation:0,disableDecorations:!1},document.createElement("canvas"),{flipY:!0,premultipliedAlpha:!0})});return function(b){return a.apply(this,arguments)}}();h._readbackScreenshot=function(a){const b=this.context.gl,c=B.createEmptyImageData(a.width,
a.height,document.createElement("canvas"));b.readPixels(a.x,a.y,a.width,a.height,6408,5121,new Uint8Array(c.data.buffer));return c};h._resizeCanvas=function(a){const b=this._canvas,c=b.style,{state:{size:d},pixelRatio:e}=a;a=d[0];const k=d[1],f=Math.round(a*e),g=Math.round(k*e);if(b.width!==f||b.height!==g)b.width=f,b.height=g;c.width=a+"px";c.height=k+"px"};h._initializeClipRenderer=function(a){if(this._clipRendererInitialized)return!0;const b=I.stencil.attributes,c=S.createProgram(a,I.stencil);
if(!c)return!1;const d=E.createVertex(a,35040,32);var e=new Uint16Array([0,1,2,2,1,3]);e=E.createIndex(a,35044,e);a=new T(a,b,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:d},e);this._clipStencilProgram=c;this._clipVBO=d;this._clipVAO=a;return this._clipRendererInitialized=!0};h._emptyTrash=function(){for(;0<this._trash.size;){const a=Array.from(this._trash);this._trash.clear();for(const b of a)b.processDetach()}};h._isLabelDrawPhaseRequired=function(a){let b=
!1;for(const c of a){if(!(c instanceof H.Container)){b=b||!1;break}if(c.hasLabels)return!0;b=b||this._isLabelDrawPhaseRequired(c.children)}return b};q._createClass(v,[{key:"background",get:function(){return this._background},set:function(a){this._background=a;this.requestRender()}},{key:"highlightOptions",get:function(){return this._highlightOptions},set:function(a){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null);if(this._highlightOptions=a)this._highlightOptionsHandle=
N.init(this._highlightOptions,"version",()=>{this.painter.setHighlightOptions(a);this.requestRender()})}},{key:"renderingOptions",get:function(){return this._renderingOptions},set:function(a){this._renderingOptions=a;this.requestRender()}},{key:"state",get:function(){return this._state},set:function(a){this._state=a;this.requestRender()}},{key:"stationary",get:function(){return this._stationary},set:function(a){this._stationary!==a&&(this._stationary=a,this.requestRender())}}]);return v}(H.Container);
z.EXTRA_RENDER_TIME=2E3;z.Stage=G;Object.defineProperty(z,"__esModule",{value:!0})});