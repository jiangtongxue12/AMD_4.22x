// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../config ../../../../request ../../../../core/BidiText ../../../../core/Error ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../chunks/vec2 ../../../../chunks/vec2f32 ../../../../symbols/cim/Rasterizer ./definitions ./enums ./fontUtils ./GlyphMosaic ./GlyphSource ./SDFConverter ./SpriteMosaic ./Utils ./animatedFormats/apng ./animatedFormats/gif ./util/Result ./util/symbolUtils ../../../support/QueueProcessor".split(" "),
function(n,J,E,K,p,L,F,r,u,G,M,N,v,w,O,P,Q,R,S,l,z,A,B,T,U){function V(k,f){return C.apply(this,arguments)}function C(){C=n._asyncToGenerator(function*(k,f){k=l.getUrl(k);var e;if(k.includes(";base64,")){f=k.indexOf(";base64,")+8;f=k.substring(f);f=atob(f);k=new Uint8Array(f.length);for(e=0;e<f.length;e++)k[e]=f.charCodeAt(e);e=k.buffer}else try{const {data:a}=yield E(k,{responseType:"array-buffer",...f});e=a}catch(a){if(!r.isAbortError(a))return new p("mapview-invalid-resource",`Could not fetch requested resource at ${k}`)}return e});
return C.apply(this,arguments)}function H(k,f){f=Math.round(u.pt2px(f)*window.devicePixelRatio);return Math.min(k,f*(128<=f?2:4))}const I=M.create(),x=L.getLogger("esri.views.2d.engine.webgl.TextureManager");let W=function(){function k(f,e,a){this.mosaicType=f;this.page=e;this.sdf=a}k.fromMosaic=function(f,e){return new k(f,e.page,e.sdf)};return k}();return function(){function k(e,a){this.resourceManager=a;this._invalidFontsMap=new Map;this._sdfConverter=new R(126);this._bindingInfos=[];this._hashToBindingIndex=
new Map;this._ongoingRasterizations=new Map;this._imageRequestQueue=new U.QueueProcessor({concurrency:10,process:function(){var b=n._asyncToGenerator(function*(c,d){r.throwIfAborted(d);try{return yield E(c,{responseType:"image",signal:d})}catch(g){if(!r.isAbortError(g))throw new p("mapview-invalid-resource",`Could not fetch requested resource at ${c}`,g);throw g;}});return function(c,d){return b.apply(this,arguments)}}()});this._spriteMosaic=new S(e,2048,2048,500);this._glyphSource=new Q(`${J.fontsUrl}/{fontstack}/{range}.pbf`);
this._glyphMosaic=new P(1024,1024,this._glyphSource);this._rasterizer=new N(a)}var f=k.prototype;f.dispose=function(){this._spriteMosaic.dispose();this._glyphMosaic.dispose();this._rasterizer.dispose();this._sdfConverter.dispose();this._sdfConverter=this._glyphMosaic=this._spriteMosaic=null;this._hashToBindingIndex.clear();this._bindingInfos=this._hashToBindingIndex=null;this._ongoingRasterizations.clear();this._ongoingRasterizations=null;this._imageRequestQueue.clear();this._imageRequestQueue=null};
f.rasterizeItem=function(){var e=n._asyncToGenerator(function*(a,b,c,d){if(F.isNone(a))return x.error(new p("mapview-null-resource","Unable to rasterize null resource",void 0)),null;switch(a.type){case "text":case "esriTS":return a=yield this._rasterizeText(a,c,d),a.forEach(g=>this._setTextureBinding(w.MosaicType.GLYPH,g)),{glyphMosaicItems:a};default:if(l.is3D(a))return x.error(new p("mapview-invalid-type",`MapView does not support symbol type: ${a.type}`,a)),null;a=yield this._rasterizeSpriteSymbol(a,
b,d);B.ok(a)&&a&&this._setTextureBinding(w.MosaicType.SPRITE,a);return{spriteMosaicItem:a}}});return function(a,b,c,d){return e.apply(this,arguments)}}();f.bindTextures=function(e,a,b,c=!1){if(0!==b.textureBinding){var d=this._bindingInfos[b.textureBinding-1];b=d.page;c=c?9987:9729;switch(d.mosaicType){case w.MosaicType.SPRITE:{d=this.sprites.getWidth(b);const g=this.sprites.getHeight(b);d=G.set(I,d,g);this._spriteMosaic.bind(e,c,b,v.TEXTURE_BINDING_SPRITE_ATLAS);a.setUniform1i("u_texture",v.TEXTURE_BINDING_SPRITE_ATLAS);
a.setUniform2fv("u_mosaicSize",d);break}case w.MosaicType.GLYPH:d=G.set(I,this.glyphs.width,this.glyphs.height);this._glyphMosaic.bind(e,c,b,v.TEXTURE_BINDING_GLYPH_ATLAS);a.setUniform1i("u_texture",v.TEXTURE_BINDING_GLYPH_ATLAS);a.setUniform2fv("u_mosaicSize",d);break;default:x.error("mapview-texture-manager",`Cannot handle unknown type ${d.mosaicType}`)}}};f._hashMosaic=function(e,a){return 1|e<<1|(a.sdf?1:0)<<2|a.page<<3};f._setTextureBinding=function(e,a){const b=this._hashMosaic(e,a);this._hashToBindingIndex.has(b)||
(e=W.fromMosaic(e,a),this._hashToBindingIndex.set(b,this._bindingInfos.length+1),this._bindingInfos.push(e));a.textureBinding=this._hashToBindingIndex.get(b)};f._rasterizeText=function(){var e=n._asyncToGenerator(function*(a,b,c){let d,g;d="cim"in a?a.fontName:O.getFullyQualifiedFontName(a.font);g=a.text;a=this._invalidFontsMap.has(d);b=b?b:l.charCodes(K.bidiText(g)[0]);try{return yield this._glyphMosaic.getGlyphItems(a?"arial-unicode-ms-regular":d,b,c)}catch(h){return x.error(new p("mapview-invalid-resource",
`Couldn't find font ${d}. Falling back to Arial Unicode MS Regular`,void 0)),this._invalidFontsMap.set(d,!0),this._glyphMosaic.getGlyphItems("arial-unicode-ms-regular",b,c)}});return function(a,b,c){return e.apply(this,arguments)}}();f._rasterizeSpriteSymbol=function(){var e=n._asyncToGenerator(function*(a,b,c){if(l.isSimple(a))return null;b=T.keyFromSymbol(a);if(this._spriteMosaic.has(b))return this._spriteMosaic.getSpriteItem(b);if(l.isSVGResource(a)||l.isImageResource(a))return this._handleAsyncResource(b,
a,c);if(c=this._rasterizer.rasterizeJSONResource(a,1)){const {size:d,image:g,sdf:h,simplePattern:m}=c;return this._addItemToMosaic(b,d,{type:"static",data:g},l.shouldRepeat(a),h,m)}return new p("TextureManager","unrecognized or null rasterized image")});return function(a,b,c){return e.apply(this,arguments)}}();f._handleAsyncResource=function(){var e=n._asyncToGenerator(function*(a,b,c){if(this._ongoingRasterizations.has(a))return this._ongoingRasterizations.get(a);b=l.isSVGResource(b)?this._handleSVG(b,
a,c):this._handleImage(b,a,c);this._ongoingRasterizations.set(a,b);try{yield b,this._ongoingRasterizations.delete(a)}catch{this._ongoingRasterizations.delete(a)}return b});return function(a,b,c){return e.apply(this,arguments)}}();f._handleSVG=function(){var e=n._asyncToGenerator(function*(a,b,c){a=yield this._sdfConverter.draw(a.path,c);return this._addItemToMosaic(b,[126,126],{type:"static",data:new Uint32Array(a.buffer)},!1,!0,!0)});return function(a,b,c){return e.apply(this,arguments)}}();f._handleGIFOrPNG=
function(){var e=n._asyncToGenerator(function*(a,b,c){var d=yield V(a,c);if(B.ok(d)){var g=A.isGIF(d);const h=z.isPNG(d);if(!g&&!h)return new p("mapview-invalid-resource","Image data is neither GIF nor PNG!");let m;try{g&&A.isAnimatedGIF(d)?m=yield A.default.create(d,c):h&&z.isAnimatedPNG(d)&&(m=yield z.default.create(d,c))}catch(q){if(!r.isAbortError(q))return new p("mapview-invalid-resource","Could not fetch requested resource!")}if(m&&B.ok(m))return this._addItemToMosaic(b,[m.width,m.height],{type:"animated",
data:m},l.shouldRepeat(a),!1,!1);c=new Blob([d],{type:g?"image/gif":"image/png"});if((c=yield this._imageFromBlob(c))&&c instanceof HTMLImageElement){d=c.width;g=c.height;"esriPMS"===a.type&&(d=Math.round(H(c.width,l.getPMSResourceSize(a))),g=Math.round(d/c.width*c.height));const {size:q,sdf:y,image:D}=this._rasterizer.rasterizeImageResource(d,g,c,"cim"in a?a.cim.colorSubstitutions:void 0);return this._addItemToMosaic(b,q,{type:"static",data:D},l.shouldRepeat(a),y,!1)}}return new p("mapview-invalid-resource",
"Could not handle resource!")});return function(a,b,c){return e.apply(this,arguments)}}();f._handleImage=function(){var e=n._asyncToGenerator(function*(a,b,c){if(l.isGIF(a)||l.isPNG(a))return this._handleGIFOrPNG(a,b,c);const d=l.getUrl(a);try{let h;const m=this.resourceManager.getResource(d);if(F.isSome(m))h=m;else{const {data:t}=yield this._imageRequestQueue.push(d,{...c});h=t}if(l.isSVGImage(d))if("width"in a&&"height"in a)h.width=u.pt2px(a.width),h.height=u.pt2px(a.height);else if("cim"in a){var g;
const t=a.cim;h.width=u.pt2px(null!=(g=t.width)?g:t.scaleX*t.size);h.height=u.pt2px(t.size)}if(!h.width||!h.height)return null;let q=h.width,y=h.height;"esriPMS"===a.type&&(q=Math.round(H(h.width,l.getPMSResourceSize(a))),y=Math.round(q/h.width*h.height));const {size:D,sdf:X,image:Y}=this._rasterizer.rasterizeImageResource(q,y,h,"cim"in a?a.cim.colorSubstitutions:void 0);return this._addItemToMosaic(b,D,{type:"static",data:Y},l.shouldRepeat(a),X,!1)}catch(h){if(!r.isAbortError(h))return new p("mapview-invalid-resource",
`Could not fetch requested resource at ${d}. ${h.message}`)}});return function(a,b,c){return e.apply(this,arguments)}}();f._imageFromBlob=function(){var e=n._asyncToGenerator(function*(a){a=window.URL.createObjectURL(a);try{const {data:b}=yield this._imageRequestQueue.push(a);window.URL.revokeObjectURL(a);return b}catch(b){window.URL.revokeObjectURL(a);if(!r.isAbortError(b))return new p("mapview-invalid-resource",`Could not fetch requested resource at ${a}`);throw b;}});return function(a){return e.apply(this,
arguments)}}();f._addItemToMosaic=function(e,a,b,c,d,g){return this._spriteMosaic.addSpriteItem(e,a,b,c,d,g)};n._createClass(k,[{key:"sprites",get:function(){return this._spriteMosaic}},{key:"glyphs",get:function(){return this._glyphMosaic}}]);return k}()});