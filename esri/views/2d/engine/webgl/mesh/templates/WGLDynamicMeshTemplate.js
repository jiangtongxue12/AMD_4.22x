// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define(["../../../../../../chunks/_rollupPluginBabelHelpers","../../../../../../core/Logger","../../../../../../symbols/cim/cimAnalyzer","../../../../../../symbols/cim/utils","./WGLMeshTemplate"],function(r,t,u,k,v){const n=t.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");return function(p){function l(d){var a=p.call(this)||this;a._ongoingMaterialRequestMap=new Map;a._materialCache=new Map;a._dynamicPropertyMap=new Map;a._cimLayer=d;return a}r._inheritsLoose(l,p);l.prototype.analyze=
function(d,a,f,g,w){a=a.readLegacyFeature();const m=this._materialCache;var b=this._cimLayer.materialHash;if(!b)return n.error("A Dynamic mesh template must have a material hash value or function!"),Promise.reject(null);const c="function"===typeof b?b(a,f,g):b;if(m.has(c))return d=m.get(c),Promise.resolve(d);if(this._ongoingMaterialRequestMap.has(c))return this._ongoingMaterialRequestMap.get(c);b=this._cimLayer;var e=u.analyzeCIMResource(b.cim,this._cimLayer.materialOverrides);const {type:q,url:x}=
b;e={cim:e,type:q,mosaicHash:c,url:x,size:null,dashTemplate:null,text:null,fontName:null};switch(q){case "marker":e.size=k.evaluateValueOrFunction(b.size,a,f,g);break;case "line":e.dashTemplate=b.dashTemplate;break;case "text":e.text=k.evaluateValueOrFunction(b.text,a,f,g),e.fontName=k.evaluateValueOrFunction(b.fontName,a,f,g)}d=d.getMosaicItem(e,w).then(h=>{this._ongoingMaterialRequestMap.delete(c);m.set(c,h);return h}).catch(h=>{this._ongoingMaterialRequestMap.delete(c);n.error(".analyze()",h.message);
return null});this._ongoingMaterialRequestMap.set(c,d);return d};return l}(v)});