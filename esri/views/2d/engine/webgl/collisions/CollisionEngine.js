// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/maybe ../../../../../core/screenUtils ../definitions ./CollisionGrid ./visualVariableSimpleUtils".split(" "),function(A,y,D,B,x,E){function v(k,h){const d=[];k.forEachTile(b=>d.push(b));d.sort((b,e)=>b.instanceId-e.instanceId);d.forEach(b=>{y.isSome(b.labelMetrics)&&b.isReady&&h(b,b.labelMetrics.getCursor())})}function F(k){return h=>D.pt2px(E.getSizeForValueSimple(h,k))}function G(k){for(const d of k){var h;k=("featureReduction"in d&&"cluster"===(null==(h=d.featureReduction)?
void 0:h.type)&&d.featureReduction).labelingInfo||[];k=[...d.labelingInfo||[],...k];if(d.labelsVisible&&k.length&&k.some(b=>"none"===b.deconflictionStrategy))return!0}return!1}let I=function(){function k(){}var h=k.prototype;h.run=function(d,b,e){const g=[];for(let t=d.length-1;0<=t;t--)a:{var f=g,a=d[t];if("feature"!==a.layer.type&&"csv"!==a.layer.type&&"geojson"!==a.layer.type&&"ogc-feature"!==a.layer.type&&"stream"!==a.layer.type&&"subtype-group"!==a.layer.type&&"wfs"!==a.layer.type)break a;const u=
a.layer.geometryType,w=!G("subtype-group"===a.layer.type?a.layer.sublayers.items:[a.layer]),p={};if("subtype-group"!==a.layer.type){if("heatmap"===a.layer.renderer.type)break a;b:{var c=a.layer.renderer;if(c="visualVariables"in c&&c.visualVariables)for(const q of c)if("size"===q.type){c=F(q);break b}c=null}p[0]=c}c=a.tileRenderer;y.isNone(c)||f.push({tileRenderer:c,vvEvaluators:p,deconflictionEnabled:w,geometryType:u,visible:a.layer.visible&&!a.suspended})}this._transformMetrics(g,b);this._runCollision(g,
b,e)};h._runCollision=function(d,b,e){const [g,f]=b.state.size;b=new x.CollisionBitsetGrid(g*b.pixelRatio,f*b.pixelRatio);for(const {tileRenderer:a,deconflictionEnabled:c,visible:t}of d){const u=a.featuresView.attributeView;c?t?(this._prepare(a),this._collideVisible(b,a,e),this._collideInvisible(b,a)):v(a,(w,p)=>{for(;p.nextId();)u.setLabelMinZoom(p.id,255)}):v(a,(w,p)=>{for(;p.nextId();)u.setLabelMinZoom(p.id,0)})}};h._isFiltered=function(d,b,e){b=b.getFilterFlags(d);d=!e.hasFilter||!!(b&B.FILTER_FLAG_0);
e=!y.isSome(e.featureEffect)||e.featureEffect.excludedLabelsVisible||!!(b&B.EFFECT_FLAG_0);return!(d&&e)};h._prepare=function(d){const b=d.featuresView.attributeView,e=new Set;v(d,(g,f)=>{for(;f.nextId();)e.has(f.id)||(e.add(f.id),this._isFiltered(f.id,b,d.layerView)?b.setLabelMinZoom(f.id,254):0!==b.getLabelMinZoom(f.id)?b.setLabelMinZoom(f.id,255):b.setLabelMinZoom(f.id,0))})};h._collideVisible=function(d,b,e){const g=b.featuresView.attributeView,f=new Set;v(b,(a,c)=>{for(;c.nextId();)if(!f.has(c.id))if(a.key.level!==
e)g.setLabelMinZoom(c.id,254);else if(0===g.getLabelMinZoom(c.id))switch(d.insertMetrics(c)){case x.HAS_COLLISION:g.setLabelMinZoom(c.id,254);f.add(c.id);break;case x.NONE:g.setLabelMinZoom(c.id,0),f.add(c.id)}})};h._collideInvisible=function(d,b){const e=b.featuresView.attributeView,g=new Set;v(b,(f,a)=>{for(;a.nextId();)if(!g.has(a.id)&&255===e.getLabelMinZoom(a.id))switch(d.insertMetrics(a)){case x.HAS_COLLISION:e.setLabelMinZoom(a.id,255);g.add(a.id);break;case x.NONE:e.setLabelMinZoom(a.id,0),
g.add(a.id)}})};h._transformMetrics=function(d,b){for(const {tileRenderer:e,geometryType:g,vvEvaluators:f}of d)v(e,(a,c)=>{const t=e.featuresView.attributeView;a=a.transforms.labelMat2d;a[4]=Math.round(a[4]);a[5]=Math.round(a[5]);const u=a[4],w=a[5],p="polyline"===g;for(;c.next();){const H=c.boundsCount,z=c.anchorX,C=c.anchorY;var q=c.size,r=f[0];if(y.isSome(r)){var l=t.getVVSize(c.id);r=r(l);q=isNaN(r)||null==r||Infinity===r?q:r}r=q/2*c.directionX;q=q/2*c.directionY;for(l=0;l<H;l++){var m=z,n=c.anchorY;
p?(m=m+c.boundsX(l)+r,n=n+c.boundsY(l)+q,b.state.rotation?(m=a[0]*m+a[2]*n+a[4],n=a[1]*m+a[3]*n+a[5]):(m+=u,n+=w),c.setBoundsComputedAnchorX(l,Math.floor(m)),c.setBoundsComputedAnchorY(l,Math.floor(n))):(b.state.rotation?(m=a[0]*z+a[2]*C+a[4],n=a[1]*z+a[3]*C+a[5]):(m+=u,n+=w),m=m+c.boundsX(l)+r,n=n+c.boundsY(l)+q,c.setBoundsComputedAnchorX(l,m),c.setBoundsComputedAnchorY(l,n))}}})};return k}();A.CollisionEngine=I;Object.defineProperty(A,"__esModule",{value:!0})});