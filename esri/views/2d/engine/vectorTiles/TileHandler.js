// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../request ../../../../core/has ../../../../core/promiseUtils ../../../../core/urlUtils ../../../../core/workers/workers ./GlyphMosaic ./GlyphSource ./SpriteMosaic ./decluttering/debugging ../../tiling/TileKey".split(" "),function(n,k,x,p,l,q,y,r,t,u,z,v){let A=function(){function m(b,a,d){this._layer=b;this._styleRepository=a;this.devicePixelRatio=d;this._connection=this._glyphMosaic=this._spriteMosaic=null}var f=m.prototype;f.destroy=
function(){this._connection&&(this._connection.close(),this._connection=null);this._layer=this._styleRepository=null;this._spriteMosaic&&(this._spriteMosaic=null);this._glyphMosaic&&(this._glyphMosaic=null)};f.start=function(){var b=k._asyncToGenerator(function*(a){this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,a);this._spriteSourcePromise.then(e=>{this._spriteMosaic=new u(1024,1024,250);this._spriteMosaic.setSpriteSource(e)});const d=new t(this._layer.currentStyleInfo.glyphsUrl?
q.addQueryParameters(this._layer.currentStyleInfo.glyphsUrl,{...this._layer.customParameters,token:this._layer.apiKey}):null);this._glyphMosaic=new r(1024,1024,d);this._broadcastPromise=y.open("WorkerTileHandler",{client:this,schedule:a.schedule,signal:a.signal}).then(e=>{this._connection=e;return Promise.all(this._connection.broadcast("setStyle",{style:this._layer.currentStyleInfo.style,vectorTileLayerMaxBuffers:p("vectortilelayer-max-buffers")},a))})});return function(a){return b.apply(this,arguments)}}();
f.updateStyle=function(){var b=k._asyncToGenerator(function*(a){yield this._broadcastPromise;return this._broadcastPromise=Promise.all(this._connection.broadcast("updateStyle",a))});return function(a){return b.apply(this,arguments)}}();f.setStyle=function(){var b=k._asyncToGenerator(function*(a,d){yield this._broadcastPromise;this._styleRepository=a;this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,null);this._spriteSourcePromise.then(e=>{this._spriteMosaic=new u(1024,1024,
250);this._spriteMosaic.setSpriteSource(e)});a=new t(this._layer.currentStyleInfo.glyphsUrl?q.addQueryParameters(this._layer.currentStyleInfo.glyphsUrl,{...this._layer.customParameters,token:this._layer.apiKey}):null);this._glyphMosaic=new r(1024,1024,a);return this._broadcastPromise=Promise.all(this._connection.broadcast("setStyle",{style:d,vectorTileLayerMaxBuffers:p("vectortilelayer-max-buffers")}))});return function(a,d){return b.apply(this,arguments)}}();f.fetchTileData=function(b,a){return this._getRefKeys(b,
a).then(d=>{const e=this._layer.sourceNameToSource,c=[];for(const g in e)c.push(g);return this._getSourcesData(c,d,a)})};f.parseTileData=function(b,a){const d=b&&b.data;if(!d)return Promise.resolve(null);const {sourceName2DataAndRefKey:e,transferList:c}=d;return 0===Object.keys(e).length?Promise.resolve(null):this._broadcastPromise.then(()=>this._connection.getAvailableClient().then(g=>g.invoke("createTileAndParse",{key:b.key.id,sourceName2DataAndRefKey:e,styleLayerUIDs:b.styleLayerUIDs},{...a,transferList:c})))};
f.getSprites=function(){var b=k._asyncToGenerator(function*(a){yield this._spriteSourcePromise;return this._spriteMosaic.getSpriteItems(a)});return function(a){return b.apply(this,arguments)}}();f.getGlyphs=function(b){return this._glyphMosaic.getGlyphItems(b.font,b.codePoints)};f.perfReport=function({key:b,milliseconds:a}){z.perfAdd(b,a,"ms")};f._getTilePayload=function(){var b=k._asyncToGenerator(function*(a,d,e){a=v.pool.acquire(a.id);const c=this._layer.sourceNameToSource[d].getSourceTileUrl(a.level,
a.row,a.col);v.pool.release(a);try{return{protobuff:yield this.request(c,e),sourceName:d}}catch(g){if(l.isAbortError(g))throw g;return{protobuff:null,sourceName:d}}});return function(a,d,e){return b.apply(this,arguments)}}();f.request=function(b,a){return x(b,{responseType:"array-buffer",...a}).then(({data:d})=>d)};f._getRefKeys=function(b,a){const d=this._layer.sourceNameToSource,e=[];for(const c in d){const g=d[c].getRefKey(b,a);e.push(g)}return l.eachAlways(e)};f._getSourcesData=function(b,a,d){const e=
[];for(let c=0;c<a.length;c++)if(null==a[c].value||null==b[c])e.push(null);else{const g=this._getTilePayload(a[c].value,b[c],d);e.push(g)}return l.eachAlways(e).then(c=>{const g={},w=[];for(let h=0;h<c.length;h++)c[h].value&&c[h].value&&c[h].value.protobuff&&0<c[h].value.protobuff.byteLength&&(g[c[h].value.sourceName]={refKey:a[h].value.id,protobuff:c[h].value.protobuff},w.push(c[h].value.protobuff));return{sourceName2DataAndRefKey:g,transferList:w}})};k._createClass(m,[{key:"spriteMosaic",get:function(){return this._spriteSourcePromise.then(()=>
this._spriteMosaic)}},{key:"glyphMosaic",get:function(){return this._glyphMosaic}}]);return m}();n.TileHandler=A;Object.defineProperty(n,"__esModule",{value:!0})});