// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../request ../../../core/Handles ../../../core/mathUtils ../../../core/maybe ../../../core/promiseUtils ../../../core/urlUtils ../../../core/watchUtils ../../../chunks/mat3f32 ../../webgl/BufferObject ../../webgl/FramebufferObject ../../../core/has ../../webgl/checkWebGLError ../../webgl/enums ../../../chunks/builtins ../../webgl/Texture ../../webgl/VertexArrayObject ../engine/DisplayObject ../engine/webgl/enums ../engine/webgl/shaders/MagnifierPrograms ../../magnifier/resources".split(" "),
function(q,v,A,w,f,B,C,D,E,F,K,L,M,N,O,r,G,H,I,x,J){return function(y){function p(){var a=y.call(this)||this;a._handles=new A;a._resourcePixelRatio=1;a.visible=!1;return a}q._inheritsLoose(p,y);var l=p.prototype;l.destroy=function(){this._handles.destroy();this._handles=null;this._disposeRenderResources();this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)};l._createTransforms=function(){return{dvs:E.create()}};l.doRender=function(a){const b=a.context;if(!this._resourcesTask)this._reloadResources();
else if(a.drawPhase===I.WGLDrawPhase.MAP&&this._canRender()){this._updateResources(a);var c=this._magnifier;if(!f.isNone(c.position)){var g=a.pixelRatio,h=c.size*g,d=Math.ceil(1/c.factor*h);this._readbackTexture.resize(d,d);var {size:e}=a.state;a=g*e[0];e=g*e[1];var m=.5*d,n=.5*d,k=w.clamp(g*c.position.x,m,a-m-1),z=w.clamp(e-g*c.position.y,n,e-n-1);b.setBlendingEnabled(!0);m=k-m;n=z-n;var t=this._readbackTexture;b.bindTexture(t,0);b.gl.copyTexImage2D(t.descriptor.target,0,t.descriptor.pixelFormat,
m,n,d,d,0);var u=(d=null==(u=this.background)?void 0:u.color)?[d.a*d.r/255,d.a*d.g/255,d.a*d.b/255,d.a]:[1,1,1,1];d=-1+(k+c.offset.x*g)/a*2;g=-1+(z-c.offset.y*g)/e*2;a=h/a*2;h=h/e*2;e=this._program;b.bindVAO(this._vertexArrayObject);b.bindTexture(this._overlayTexture,6);b.bindTexture(this._maskTexture,7);b.useProgram(e);e.setUniform4fv("u_background",u);e.setUniform1i("u_readbackTexture",0);e.setUniform1i("u_overlayTexture",6);e.setUniform1i("u_maskTexture",7);e.setUniform4f("u_drawPos",d,g,a,h);
e.setUniform1i("u_maskEnabled",c.maskEnabled?1:0);e.setUniform1i("u_overlayEnabled",c.overlayEnabled?1:0);b.setStencilTestEnabled(!1);b.setColorMask(!0,!0,!0,!0);b.drawArrays(5,0,4);b.bindVAO()}}};l._canRender=function(){return this.mask&&this.overlay&&null!=this._magnifier};l._reloadResources=function(){var a=this;this._resourcesTask&&this._resourcesTask.abort();const b=f.isSome(this._magnifier)?this._magnifier.maskUrl:null,c=f.isSome(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=
B.createTask(function(){var g=q._asyncToGenerator(function*(h){const d=f.isNone(b)||f.isNone(c)?J.loadMagnifierResources(h):null,e=f.isSome(b)?v(b,{responseType:"image",signal:h}).then(k=>k.data):d.then(k=>k.mask);h=f.isSome(c)?v(c,{responseType:"image",signal:h}).then(k=>k.data):d.then(k=>k.overlay);const [m,n]=yield Promise.all([e,h]);a.mask=m;a.overlay=n;a._disposeRenderResources();a.requestRender()});return function(h){return g.apply(this,arguments)}}())};l._disposeRenderResources=function(){this._readbackTexture=
f.disposeMaybe(this._readbackTexture);this._overlayTexture=f.disposeMaybe(this._overlayTexture);this._maskTexture=f.disposeMaybe(this._maskTexture);this._vertexArrayObject=f.disposeMaybe(this._vertexArrayObject);this._program=f.disposeMaybe(this._program)};l._updateResources=function(a){a.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources();if(!this._readbackTexture){var b=a.context;this._resourcePixelRatio=a.pixelRatio;var c=Math.ceil(this._magnifier.size*a.pixelRatio);this._program=
x.createMagnifierProgram(b);var g=new Uint16Array([0,1,0,0,1,1,1,0]);this._vertexArrayObject=new G(b,x.magnifierProgramTemplate.attributes,{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1,divisor:0}]},{geometry:F.createVertex(b,35044,g)});this.overlay.width=c;this.overlay.height=c;this._overlayTexture=new r(b,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,preMultiplyAlpha:C.isSVG(this.overlay.src)&&a.context.driverTest.svgAlwaysPremultipliesAlpha?
!1:!0},this.overlay);this.mask.width=c;this.mask.height=c;this._maskTexture=new r(b,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.mask);a=1/this._magnifier.factor;this._readbackTexture=new r(b,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:Math.ceil(a*c),height:Math.ceil(a*c)})}};q._createClass(p,[{key:"background",get:function(){return this._background},set:function(a){this._background=
a;this.requestRender()}},{key:"magnifier",get:function(){return this._magnifier},set:function(a){this._magnifier=a;this._handles.removeAll();this._handles.add([D.init(a,"version",()=>{this.visible=a.visible&&f.isSome(a.position)&&0<a.size;this.requestRender()}),a.watch(["mask","overlay"],()=>this._reloadResources()),a.watch("size",()=>{this._disposeRenderResources();this.requestRender()})])}}]);return p}(H.DisplayObject)});