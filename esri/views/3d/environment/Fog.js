// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/mathUtils ../../../core/maybe ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec2 ../../../chunks/vec2f64 ../../../chunks/vec3 ../../../geometry/projectionEllipsoid ./atmosphereUtils ./FogTechnique ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/glUtil3D".split(" "),function(l,q,f,c,m,n,r,t,u,v,w,g,x,y){let z=function(){function h(a,b){this._projectionInverse=n.create();this._viewInverse=n.create();
this._nearFar=t.create();this._darkenHaze=!1;this._hazeMultiplier=1;this._strength=4E-6;this._vao=y.createQuadVAO(a.renderContext.rctx,x.Pos2Tex);this._shaderTechniqueRepository=a.shaderTechniqueRep;a=v.getReferenceEllipsoid(b.spatialReference);this._planetRadius=a.radius;this._atmosphereRadius=a.radius+w.atmosphereHeight}var e=h.prototype;e.destroy=function(){this._distanceFogTechnique=c.releaseMaybe(this._distanceFogTechnique);this._foggyWeatherTechnique=c.releaseMaybe(this._foggyWeatherTechnique);
this._vao=c.disposeMaybe(this._vao)};e.when=function(){return Promise.resolve()};e.render=function(a,b,d){this._darkenHaze=d;this._update(a.camera,b);if(0>=this._fogAmount)return!1;d=a.rctx;const p=a.offscreenRenderingHelper,k=b?this.foggyWeatherTechnique:this.distanceFogTechnique;d.useProgram(k.program);k.bindPipelineState(d);p.renderDepthDetached(()=>{k.program.bindTexture(p.depthTexture,"depthTex");this._renderFog(k.program,a)});return!0};e._renderFog=function(a,b){if(c.isNone(this._vao))return!1;
const d=b.rctx;b.scenelightingData.setLightDirectionUniform(a);a.setUniform3fv("cameraPosition",b.camera.eye);a.setUniformMatrix4fv("projectionInverse",this._projectionInverse);a.setUniformMatrix4fv("viewInverse",this._viewInverse);a.setUniform2fv("nearFar",this._nearFar);a.setUniform1f("atmosphereC",this._atmosphereC);a.setUniform1f("strength",this._strength);a.setUniform1f("fogAmount",this._hazeMultiplier*this._fogAmount);d.bindVAO(this._vao);a.assertCompatibleVertexAttributeLocations(this._vao);
d.drawArrays(5,0,4);return!0};e._update=function(a,b){c.isNone(a)||(m.invert(this._projectionInverse,a.projectionMatrix),m.invert(this._viewInverse,a.viewMatrix),r.set(this._nearFar,a.near,a.far),a=u.length(a.eye),this._atmosphereC=a*a-this._atmosphereRadius*this._atmosphereRadius,this._fogAmount=b?1-f.smoothstep(3E3,6E3,Math.abs(a-this._planetRadius)):1-f.smoothstep(7E3,1E4,Math.abs(a-this._planetRadius)),this._hazeMultiplier=this._darkenHaze?f.lerp(.4,1,f.smoothstep(9500,10500,a-this._planetRadius)):
1)};h.isSupported=function(a){return a.capabilities.depthTexture};q._createClass(h,[{key:"strength",get:function(){return this._strength},set:function(a){this._strength=a}},{key:"foggyWeatherTechnique",get:function(){if(c.isNone(this._foggyWeatherTechnique)){const a=new g.FogTechniqueConfiguration;a.haze=!1;this._foggyWeatherTechnique=this._shaderTechniqueRepository.acquire(g.FogTechnique,a)}return this._foggyWeatherTechnique}},{key:"distanceFogTechnique",get:function(){if(c.isNone(this._distanceFogTechnique)){const a=
new g.FogTechniqueConfiguration;a.haze=!0;this._distanceFogTechnique=this._shaderTechniqueRepository.acquire(g.FogTechnique,a)}return this._distanceFogTechnique}}]);return h}();l.Fog=z;Object.defineProperty(l,"__esModule",{value:!0})});