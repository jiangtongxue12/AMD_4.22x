// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/has ../../../core/mathUtils ../../../core/maybe ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat3 ../../../chunks/mat3f64 ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec3f32 ../../../geometry/projectionEllipsoid ./CloudsTechnique ./NoiseTextureAtlas ../webgl-engine/lib/glUtil3D ../../support/Scheduler ../../webgl/FramebufferObject".split(" "),
function(e,r,d,v,w,l,g,n,K,L,x,y,z,A,B,f,C,t,D,E,F,G){e.CloudsGenerator=function(q){function p(a){a=q.call(this,a)||this;a._frameTask=null;a._techniques=[];a._techniqueConfiguration=new t.CloudsTechniqueConfiguration;a._cubeMapSize=w("esri-mobile")?1024:2048;a._viewMat3=z.create();a._eye=f.zeros();a._didRenderFaces=!1;a._raymarchingStepType=0;a._cloudRadius=0;a._viewMatrix=B.create();const b=u.sunny;a.coverage=l.lerp(b.coverage[1],b.coverage[0],.5);a.density=l.lerp(b.density[1],b.density[0],.5);a.absorption=
l.lerp(b.absorption[1],b.absorption[0],.5);a.cloudSize=l.lerp(b.cloudSize[1],b.cloudSize[0],.5);a.detailSize=l.lerp(b.detailSize[1],b.detailSize[0],.5);a.smoothness=l.lerp(b.smoothness[1],b.smoothness[0],.5);a.cloudHeight=l.lerp(b.cloudHeight[1],b.cloudHeight[0],.5);a.raymarchingStepType=b.raymarchingStepType;return a}r._inheritsLoose(p,q);var h=p.prototype;h._getTechnique=function(a){const b=this._techniques[a];if(b)return b;this._techniqueConfiguration.steps=a;this._techniques[a]=new t.CloudsTechnique({rctx:this.rctx,
viewingMode:this.view.state.viewingMode},this._techniqueConfiguration);return this._techniques[a]};h.initialize=function(){this._vao=E.createQuadVAO(this.rctx);this._cloudRadius=.5*C.getReferenceEllipsoid(this.view.spatialReference).radius;this.resetRenderFlags();this._frameTask=this.view.resourceController.scheduler.registerTask(F.TaskPriority.CLOUDS_GENERATOR,this)};h.destroy=function(){this._frameTask=g.removeMaybe(this._frameTask);this._techniques.forEach(a=>g.releaseMaybe(a));this._techniques=
null;this._frameBufferCube=g.disposeMaybe(this._frameBufferCube);this._vao=g.disposeMaybe(this._vao);this._noiseTexture=g.destroyMaybe(this._noiseTexture)};h._ensureNoiseTexture=function(){g.isNone(this._noiseTexture)&&(this._noiseTexture=new D.NoiseTextureAtlas(this.rctx,this.view),this._noiseTexture.render(this.rctx));return this._noiseTexture};h.resetRenderFlags=function(){this._didRenderFaces=!1};h.remap=function(a,b,k,m,c){return m+(a-b)*(c-m)/(k-b)};h.runTask=function(a){if(0===this.coverage||
g.isNone(this._vao))this._didRenderFaces=!0;else{var b=this._ensureNoiseTexture().textureAtlas;if(g.isNone(b))this._didRenderFaces=!0;else{var k=this.rctx.getViewport();this.rctx.setViewport(0,0,this._cubeMapSize,this._cubeMapSize);this.rctx.bindFramebuffer(this.frameBufferCube,!1,34069);var m=this._getTechnique(this._raymarchingStepType),c=m.program;this.rctx.useProgram(c);c.bindTexture(b,"cloudShapeTexture");c.setUniform1f("cloudRadius",this._cloudRadius);c.setUniform1f("halfCubeMapSize",.5*this._cubeMapSize);
c.setUniform1f("power",this._power);c.setUniform1f("sigmaE",this._sigmaE);c.setUniform1f("density",this._density);c.setUniform1f("cloudSize",this._cloudSize);c.setUniform1f("detailSize",this._detailSize);c.setUniform1f("smoothness",this._smoothness);c.setUniform1f("cloudHeight",this._cloudHeight);c.setUniform1f("coverage",this._coverage);this.rctx.bindVAO(this._vao);c.assertCompatibleVertexAttributeLocations(this._vao);m.bindPipelineState(this.rctx);for(b=0;5>b;b++)A.targetTo(this._viewMatrix,this._eye,
H[b],I[b]),y.fromMat4(this._viewMat3,this._viewMatrix),c.setUniformMatrix3fv("viewMatrix",this._viewMat3),this.frameBufferCube.framebufferTexture2D(this.frameBufferCube.colorAttachment.glName,this.rctx.gl,36064,34069+b),this.rctx.gl.drawArrays(this.rctx.gl.TRIANGLE_STRIP,0,4),this.rctx.gl.flush();this.rctx.setViewport(k.x,k.y,k.width,k.height);this.requestRender();this._didRenderFaces=!0;a.madeProgress()}}};r._createClass(p,[{key:"coverage",get:function(){return this._coverage},set:function(a){this._coverage=
a;this.resetRenderFlags()}},{key:"density",set:function(a){this._density=this.remap(a,0,1,0,.3);this.resetRenderFlags()}},{key:"cloudSize",set:function(a){this._cloudSize=this.remap(Math.max(.01,1-a),0,1,0,.02);this.resetRenderFlags()}},{key:"detailSize",set:function(a){this._detailSize=this.remap(Math.max(.01,1-a),0,1,0,.2);this.resetRenderFlags()}},{key:"smoothness",set:function(a){this._smoothness=this.remap(1-a,0,1,0,.5);this.resetRenderFlags()}},{key:"absorption",get:function(){return this._sigmaE-
1},set:function(a){this._sigmaE=1+a;this._power=this.remap(a,0,1,35,120);this.resetRenderFlags()}},{key:"cloudHeight",get:function(){return this._cloudHeight},set:function(a){this._cloudHeight=this.remap(a,0,1,0,1500);this.resetRenderFlags()}},{key:"raymarchingStepType",set:function(a){this._raymarchingStepType=a;this.resetRenderFlags()}},{key:"frameBufferCube",get:function(){g.isNone(this._frameBufferCube)&&(this._frameBufferCube=new G(this.rctx,{colorTarget:2,width:this._cubeMapSize,height:this._cubeMapSize},
{target:34067,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1,width:this._cubeMapSize,height:this._cubeMapSize}));return this._frameBufferCube}},{key:"cubeMap",get:function(){return this._frameBufferCube}},{key:"running",get:function(){return!this._didRenderFaces}},{key:"test",get:function(){return{coverage:this._coverage,density:this.remap(this._density,0,.3,0,1),absorption:this._sigmaE-1,cloudSize:1-this.remap(this._cloudSize,0,.02,0,1),detailSize:1-this.remap(this._detailSize,
0,.2,0,1),smoothness:1-this.remap(this._smoothness,0,.5,0,1),cloudHeight:this.remap(this._cloudHeight,0,1500,0,1)}}}]);return p}(v);d.__decorate([n.property({constructOnly:!0})],e.CloudsGenerator.prototype,"rctx",void 0);d.__decorate([n.property({constructOnly:!0})],e.CloudsGenerator.prototype,"view",void 0);d.__decorate([n.property({constructOnly:!0})],e.CloudsGenerator.prototype,"requestRender",void 0);d.__decorate([n.property()],e.CloudsGenerator.prototype,"_frameTask",void 0);d.__decorate([n.property()],
e.CloudsGenerator.prototype,"_didRenderFaces",void 0);d.__decorate([n.property({readOnly:!0})],e.CloudsGenerator.prototype,"running",null);e.CloudsGenerator=d.__decorate([x.subclass("esri.views.3d.environment.CloudsGenerator")],e.CloudsGenerator);const H=[f.fromValues(1,0,0),f.fromValues(-1,0,0),f.fromValues(0,1,0),f.fromValues(0,-1,0),f.fromValues(0,0,1)],I=[f.fromValues(0,1,0),f.fromValues(0,1,0),f.fromValues(0,0,-1),f.fromValues(0,0,1),f.fromValues(0,1,0)];d=function(q,p,h,a,b,k,m,c,J=.5){this.coverage=
q;this.density=p;this.absorption=h;this.cloudSize=a;this.detailSize=b;this.smoothness=k;this.cloudHeight=m;this.raymarchingStepType=c;this.median=J};const u={sunny:new d([.1,.7],[.02,.02],[0,0],[.86,.86],[.8,.8],[.5,.5],[.05,.05],0),cloudy:new d([.24,.7],[.135,.2],[0,0],[.5,.5],[.65,.7],[.3,.3],[1,1],2),rainy:new d([.5,.9],[.2,.5],[.3,.6],[.4,.4],[.7,.7],[.5,.5],[1,1],2),foggy:new d([.8,.8],[.5,.5],[0,0],[.85,.85],[.75,.75],[.8,.8],[.3,.3],1)};e.cloudPresets=u;Object.defineProperty(e,"__esModule",
{value:!0})});