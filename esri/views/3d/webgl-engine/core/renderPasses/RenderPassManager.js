// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../../../../chunks/mat3 ../../../../../chunks/mat3f64 ../../../../../chunks/mat4 ../../../../../chunks/vec2 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../chunks/vec4 ../../../../../chunks/boundedPlane ./AllRenderPasses ./RenderPass ../util/TwoVectorPosition ../../lib/depthRange".split(" "),function(p,u,q,h,v,w,r,f,x,y,z,k,e,A,B){let C=function(){function l(a,b){this.rctx=a;this.shaderTechniqueRepository=
b;this.canRender=!0;this._materialPassParams=new k.MaterialPassesParameters;this._shadowPassParams=new k.ShadowMapPassParameters;this._highlightPassParams=new k.HighlightPassParameters;this._systems=new Set;this._passes={materialOpaque:new e.RenderPass(a,this.shaderTechniqueRepository),materialTransparent:new e.RenderPass(a,this.shaderTechniqueRepository,1),materialIntegratedMesh:new e.RenderPass(a,this.shaderTechniqueRepository),shadowMap:new e.RenderPass(a,this.shaderTechniqueRepository),highlight:new e.RenderPass(a,
this.shaderTechniqueRepository),highlightIntegratedMesh:new e.RenderPass(a,this.shaderTechniqueRepository),highlightShadowMap:new e.RenderPass(a,this.shaderTechniqueRepository),defaultShadowMap:new e.RenderPass(a,this.shaderTechniqueRepository)}}var d=l.prototype;d.register=function(a){this._systems.add(a)};d.prepareRender=function(a){if(0!==this._systems.size){for(const b of Object.values(this._passes))b.prepareSubmit();this._systems.forEach(b=>b.submit(this._passes,{camera:a}));for(const b of Object.values(this._passes))b.finishSubmit();
this.shaderTechniqueRepository.frameUpdate()}};d.render=function(a){if(0===this._systems.size)return!1;this._configure(a);switch(a.slot){case 3:switch(a.pass){case 0:return this._materialPassParams.subPass=0,this._configureMaterialColorPass(a),this._passes.materialOpaque.dispatch(this._materialPassParams);case 2:return this._materialPassParams.subPass=2,this._passes.materialOpaque.dispatch(this._materialPassParams);case 3:return this._materialPassParams.subPass=3,this._passes.materialOpaque.dispatch(this._materialPassParams);
case 5:return this._passes.highlight.dispatch(this._highlightPassParams);case 4:return this._passes.shadowMap.dispatch(this._shadowPassParams);case 7:return this._passes.highlightShadowMap.dispatch(this._shadowPassParams);case 6:return this._passes.defaultShadowMap.dispatch(this._shadowPassParams)}break;case 5:switch(a.pass){case 0:return this._materialPassParams.subPass=0,this._configureMaterialColorPass(a),this._passes.materialTransparent.dispatch(this._materialPassParams);case 1:return this._materialPassParams.subPass=
1,this._configureMaterialColorPass(a),this._passes.materialTransparent.dispatch(this._materialPassParams);case 2:return this._materialPassParams.subPass=2,this._passes.materialTransparent.dispatch(this._materialPassParams);case 3:return this._materialPassParams.subPass=3,this._passes.materialTransparent.dispatch(this._materialPassParams)}break;case 0:switch(a.pass){case 0:return this._materialPassParams.subPass=0,this._configureMaterialColorPass(a),this._materialPassParams.ssrParams=a.ssrParams,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);
case 2:return this._materialPassParams.subPass=2,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case 3:return this._materialPassParams.subPass=3,this._passes.materialIntegratedMesh.dispatch(this._materialPassParams);case 5:return this._passes.highlightIntegratedMesh.dispatch(this._highlightPassParams)}}return!1};d.notifyDirty=function(){this._context.requestRender()};d.slots=function(){return[3,5,0]};d.initializeRenderContext=function(a){this._context=a};d.uninitializeRenderContext=
function(){};d.queryDepthRange=function(a){const b={near:Infinity,far:-Infinity};this._systems.forEach(c=>{c=c.queryShadowCasterDepthRange(a);q.isSome(c)&&B.union(b,c,b)});return b};d._configureMaterialColorPass=function(a){this._materialPassParams.bindShadowMap=b=>{a.shadowMap.bind(b);const c=this._materialPassParams.viewTransform;f.add(g,c.worldFromView_TL,c.worldFromView_TH);a.shadowMap.bindView(b,g)};this._materialPassParams.bindAmbientOcclusion=b=>a.ssaoHelper.bind(b,a.camera);this._materialPassParams.ambientOcclusionEnabled=
!!a.ssaoHelper&&a.ssaoHelper.ready;this._materialPassParams.sceneHasOcludees=a.hasOccludees};d._configure=function(a){this._updateParameters(a,4===a.pass||7===a.pass||6===a.pass?this._shadowPassParams:5===a.pass?this._highlightPassParams:this._materialPassParams)};d._updateParameters=function(a,b){const c=a.camera,m=c.viewInverseTransposeMatrix;f.set(g,m[3],m[7],m[11]);n.set(g);f.copy(b.viewTransform.worldFromView_TH,n.high);f.copy(b.viewTransform.worldFromView_TL,n.low);h.fromMat4(b.viewTransform.viewFromCameraRelative_RS,
c.viewMatrix);w.copy(b.viewTransform.projFromView,c.projectionMatrix);0===b.identifier?(this._materialPassParams.transparent=5===a.slot,this._materialPassParams.integratedMesh=0===a.slot,this._materialPassParams.lighting=a.scenelightingData,h.transpose(t,b.viewTransform.viewFromCameraRelative_RS),h.invert(b.transformNormal_ViewFromGlobal,t),r.set(b.cameraNearFar,c.near,c.far)):1===b.identifier?r.set(b.cameraNearFar,c.near,c.far):2===b.identifier&&(b.highlightDepthTexture=a.highlightDepthTexture,y.copy(b.viewport,
c.fullViewport));if(0===b.identifier||2===b.identifier)b.inverseViewport[0]=1/c.fullViewport[2],b.inverseViewport[1]=1/c.fullViewport[3];z.copyWithoutVerify(a.sliceHelper.plane,b.slicePlane);f.subtract(b.slicePlane.origin,b.slicePlane.origin,g);b.slicePlaneEnabled=a.sliceHelper.isEnabled;this._materialPassParams.slot=a.slot;this._materialPassParams.transparencyPassType=a.transparencyPassType;this._materialPassParams.multipassTerrainParams=a.multipassTerrainParams};u._createClass(l,[{key:"shadowCastingEnabled",
get:function(){return this._materialPassParams.shadowsEnabled},set:function(a){this._materialPassParams.shadowsEnabled=a}},{key:"screenSpaceReflectionsEnabled",get:function(){return q.isSome(this._materialPassParams.ssrParams.ssrEnabled)},set:function(a){this._materialPassParams.ssrParams.ssrEnabled=!!a}},{key:"needsHighlight",get:function(){return 0<this._passes.highlight.count||0<this._passes.highlightIntegratedMesh.count}}]);return l}();const g=x.create(),t=v.create(),n=new A.TwoVectorPosition;
p.RenderPassManager=C;Object.defineProperty(p,"__esModule",{value:!0})});