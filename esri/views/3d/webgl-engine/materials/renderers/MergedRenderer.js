// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/MapUtils ../../../../../core/maybe ../../../../../core/PooledArray ../../../../../chunks/mat4 ../../../../../chunks/mat4f64 ../../../support/buffer/glUtil ../../lib/GLMaterials ../../lib/Util ../WaterMaterial ./Instance ./MergedGeometryBuffer ./MergedGeometryBufferPool ./utils".split(" "),function(C,F,G,u,y,z,A,H,I,x,J,p,K,L,M){function N(l,k){const b=new Map;for(const a of l)D(b,a,!0);for(const a of k)D(b,a,!1);return b}
function D(l,k,b){const a=k.origin;if(!u.isNone(a)){var c=l.get(a.id);null==c&&(c=new O(a.vec3),l.set(a.id,c));b?c.toAdd.push(k):c.toRemove.push(k)}}function P(l,k){let b;if(!l.some(c=>{if(c.to-c.from<k)return!1;b=c;return!0}))return null;const a=b.from;b.from+=k;b.from>=b.to&&l.removeUnordered(b);return a}function E(l){const k=new Map;l.forAll(a=>k.set(a.from,a));let b=!0;for(;b;)b=!1,l.forEach(a=>{const c=k.get(a.to);c&&(a.to=c.to,k.delete(c.from),l.removeUnordered(c),b=!0)})}let U=function(){function l(b,
a,c){this._rctx=b;this._materialRepository=a;this._material=c;this.type="MergedRenderer";this._dataByOrigin=new Map;this._renderCommandData=new y;this._hasOccludees=this._hasHighlights=!1;this._glMaterials=new I.GLMaterials(this._material,this._materialRepository);this._bufferWriter=c.createBufferWriter();this._bufferPool=new L.MergedGeometryBufferPool(b,c.vertexAttributeLocations,H.glLayout(this._bufferWriter.vertexBufferLayout))}var k=l.prototype;k.dispose=function(){this._glMaterials.destroy();
this._dataByOrigin.forEach(b=>b.buffer.dispose());this._dataByOrigin.clear();this._bufferPool.dispose()};k.modify=function(b){this.updateGeometries(b.updates);this.addAndRemoveGeometries(b.adds,b.removes);this.updateRenderCommands()};k.addAndRemoveGeometries=function(b,a){const c=this._bufferWriter,g=c.vertexBufferLayout.stride/4,n=this._dataByOrigin,h=N(b,a);h.forEach((f,d)=>{h.delete(d);var e=f.toAdd.reduce((q,v)=>q+c.elementCount(v.data),0);let m=n.get(d);if(null==m)x.assert(0===f.toRemove.length),
m=new Q(f.origin,new K.MergedGeometryBuffer(this._bufferPool,e*g)),n.set(d,m);else if(0===f.toAdd.length&&m.instances.size===f.toRemove.length){m.buffer.dispose();n.delete(d);return}let r=0;m.instances.forEach(q=>r+=q.to-q.from);d=f.toRemove.reduce((q,v)=>q+c.elementCount(v.data),0);d=(r+e-d)*g;e=R;d<m.buffer.size/2?this.removeAndRebuild(m,f.toRemove,g,d,e):0<f.toRemove.length&&this.remove(m,f.toRemove,g,e);0<f.toAdd.length&&(d=S,x.setMatrixTranslation3(d,-f.origin[0],-f.origin[1],-f.origin[2]),this.add(m,
f.toAdd,g,d,e));const t=m.buffer.vao.vertexBuffers.geometry;E(e);e.forAll(({from:q,to:v})=>{q<v&&(q*=4,t.setSubData(m.buffer.array,q,q,4*v))});e.clear();m.drawCommandsDirty=!0})};k.updateGeometries=function(b){const a=this._bufferWriter,c=a.vertexBufferLayout.stride/4;for(const g of b){b=g.renderGeometry;const n=this._dataByOrigin.get(b.origin.id),h=n&&n.instances.get(b.id);if(!h)break;const f=g.updateType;f&1&&(h.isVisible=b.instanceParameters.visible);if(f&9){const d=b.instanceParameters.visible;
h.hasHighlights=!!b.instanceParameters.highlights&&d}f&16&&(h.hasOccludees=!!b.instanceParameters.occludees);if(f&6){const {array:d,vao:e}=n.buffer;M.calculateTransformRelativeToOrigin(b,B,w);a.write({transformation:B,invTranspTransformation:w},b.data,a.vertexBufferLayout.createView(d.buffer),h.from);x.assert(h.from+a.elementCount(b.data)===h.to,"material VBO layout has changed");e.vertexBuffers.geometry.setSubData(d,h.from*c*4,h.from*c*4,h.to*c*4)}n.drawCommandsDirty=!0}};k.updateRenderCommands=
function(){this._hasOccludees=this._hasHighlights=!1;this._dataByOrigin.forEach(a=>{a.hasHiddenInstances=!1;a.hasHighlights=!1;a.hasOccludees=!1;G.someMap(a.instances,c=>{c.isVisible?(c.hasHighlights&&(this._hasHighlights=!0,a.hasHighlights=!0),c.hasOccludees&&(this._hasOccludees=!0,a.hasOccludees=!0)):a.hasHiddenInstances=!0;return a.hasHiddenInstances&&a.hasHighlights&&a.hasOccludees})});const b=a=>{a.drawCommandsDefault=null;a.drawCommandsHighlight=null;a.drawCommandsOccludees=null;a.drawCommandsShadowHighlightRest=
null;if(0!==a.instances.size)if(a.hasOccludees||a.hasHighlights||a.hasHiddenInstances){var c=p.sortInstancesByRange(a.instances);a.drawCommandsDefault=[];a.drawCommandsHighlight=[];a.drawCommandsOccludees=[];a.drawCommandsShadowHighlightRest=[];for(const g of c)g.isVisible&&(g.hasOccludees?p.addOrMerge(a.drawCommandsOccludees,g):p.addOrMerge(a.drawCommandsDefault,g),g.hasHighlights?p.addOrMerge(a.drawCommandsHighlight,g):p.addOrMerge(a.drawCommandsShadowHighlightRest,g))}else a.drawCommandsDefault=
[{first:0,count:4*a.buffer.size/this._bufferWriter.vertexBufferLayout.stride}]};this._dataByOrigin.forEach(a=>{a.drawCommandsDirty&&(b(a),a.drawCommandsDirty=!1)})};k.updateLogic=function(b){return this._material.update(b)};k.render=function(b,a,c){if(null!=b&&!this._material.requiresSlot(b,a))return!1;const g=5===a||7===a;if(g&&!this._hasHighlights)return!1;const n=6===a,h=!(g||n);this._dataByOrigin.forEach(e=>{if(!g||e.hasHighlights){var m=(g?e.drawCommandsHighlight:n&&(e.hasOccludees||e.hasHighlights||
e.hasHiddenInstances)?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,r=h&&e.drawCommandsOccludees||null;(u.isSome(m)||u.isSome(r))&&this._renderCommandData.push(new T(e.origin,e.buffer,m,r))}});if(0===this._renderCommandData.length)return!1;const f=this._rctx;a=this._glMaterials.load(f,a);if(u.isNone(a))return this._renderCommandData.clear(),!1;const d=a.beginSlot(c);d.bindPipelineState(f,b,!1);f.useProgram(d.program);a.bind(c,d);this._renderCommandData.forAll(({origin:e,buffer:m,
renderCommands:r,occludeeCommands:t})=>{c.origin=e;d.bindDraw(c);d.ensureAttributeLocations(m.vao);f.bindVAO(m.vao);e=d.primitiveType;u.isSome(r)&&this.renderCommands(f,e,r);u.isSome(t)&&(d.bindPipelineState(f,b,!0),this.renderCommands(f,e,t),d.bindPipelineState(f,b,!1))});this._renderCommandData.clear();return!0};k.renderCommands=function(b,a,c){for(let g=0;g<c.length;g++)b.drawArrays(a,c[g].first,c[g].count)};k.removeAndRebuild=function(b,a,c,g,n){for(var h of a)b.instances.delete(h.id);var f=p.sortInstancesByRange(b.instances);
b.instances.clear();a=b.buffer.size;g=b.buffer.alloc(g);h=0;for(const d of f){f=d.from*c;const e=d.to*c;g.copy(h,f,e);d.from=h/c;h+=e-f;d.to=h/c;b.instances.set(d.id,d)}n.push(new p.BufferRange(0,g.hasNewBuffer?b.buffer.array.length:a));g.dispose();b.buffer.erase(h,n.back().to);b.holes.clear()};k.remove=function(b,a,c,g){for(const n of a){a=n.id;const h=b.instances.get(a),f=h.from*c,d=h.to*c;b.buffer.erase(f,d);b.holes.push(new p.BufferRange(h.from,h.to));b.instances.delete(a);g.push(new p.BufferRange(f,
d))}E(b.holes)};k.add=function(b,a,c,g,n){const h=this._bufferWriter;let f=h.vertexBufferLayout.createView(b.buffer.array.buffer);for(const e of a){var d=u.isSome(e.transformation)?z.multiply(B,g,e.transformation):g;z.invert(w,d);const m=z.transpose(w,w);a=h.elementCount(e.data);const r=a*c;let t=P(b.holes,a);u.isNone(t)&&(t=b.buffer.size/c,b.buffer.grow(r),f=h.vertexBufferLayout.createView(b.buffer.array.buffer));h.write({transformation:d,invTranspTransformation:m},e.data,f,t);d=e.instanceParameters.visible;
a=new p.Instance(e.id,t,t+a,d,!!e.instanceParameters.highlights&&d,!!e.instanceParameters.occludees);x.assert(null==b.instances.get(e.id));b.instances.set(e.id,a);n.push(new p.BufferRange(a.from*c,a.to*c))}};F._createClass(l,[{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&this._material instanceof J.WaterMaterial}},
{key:"rendersOccluded",get:function(){return!this.isEmpty&&1!==this._material.renderOccluded}},{key:"test",get:function(){return{material:this._material,glMaterials:this._glMaterials}}}]);return l}(),O=function(l){this.origin=l;this.toAdd=[];this.toRemove=[]},Q=function(l,k){this.origin=l;this.buffer=k;this.instances=new Map;this.holes=new y({deallocator:null});this.drawCommandsDirty=this.hasOccludees=this.hasHighlights=this.hasHiddenInstances=!1},T=function(l,k,b,a){this.origin=l;this.buffer=k;this.renderCommands=
b;this.occludeeCommands=a};const R=new y({deallocator:null}),S=A.create(),B=A.create(),w=A.create();C.MergedRenderer=U;Object.defineProperty(C,"__esModule",{value:!0})});