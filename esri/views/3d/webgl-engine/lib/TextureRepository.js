// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ./TextureTechnique ./Util ../../../support/Scheduler".split(" "),function(f,l,m,x,y,
z,p,t,q,F,G,H,A,u,B,C){const v=z.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository");f.TextureRepository=function(k){function g(b,a,c){var d=k.call(this,{})||this;d._stage=b;d._techniqueRepository=a;d._rctx=c;d._idToRefCountedTexture=new Map;d._loadingCount=0;d._frameUpdates=new Map;d.events=new y;d._frameTask=b.resourceController.scheduler.registerTask(C.TaskPriority.TEXTURE_UNLOAD);return d}l._inheritsLoose(g,k);var e=g.prototype;e.normalizeCtorArgs=function(){return{}};e.dispose=function(){this._frameTask.remove();
this._stage.forEachOfType(4,b=>b.unload())};e.acquire=function(b){const a=this._idToRefCountedTexture.get(b);return a?(a.ref(),Promise.resolve(a)):this._createNewRef(b)};e.update=function(){let b=!1;this._frameUpdates.forEach(a=>{const c=a.texture.frameUpdate(this._rctx,this.textureTechnique,a.previousToken);0<=c&&c!==a.previousToken&&(a.previousToken=c,b=!0)});b&&this.events.emit("changed",0)};e._createNewRef=function(){var b=l._asyncToGenerator(function*(a){const c=this._stage.getObject(a);if(p.isNone(c))return B.assert(void 0!==
c),null;const d=c.events.on("unloaded",()=>{d.remove();this._onTextureUnloaded(a)}),h=new D(a,()=>{this._frameTask.schedule(()=>{h.isUnreferenced&&c.unload()})});this._idToRefCountedTexture.set(a,h);h.ref();p.isSome(c.glTexture)?(this._updateGLTexture(h,c.glTexture),c.requiresFrameUpdates&&this._frameUpdates.set(a,{texture:c,previousToken:-1})):(this._loadingCount++,yield this._stage.schedule(()=>{const r=c.load(this._rctx,()=>this.textureTechnique),w=n=>{this._loadingCount--;this._updateGLTexture(h,
n);c.requiresFrameUpdates&&this._frameUpdates.set(a,{texture:c,previousToken:-1});return h},E=n=>{this._loadingCount--;t.isAbortError(n)||v.error(n)};return t.isPromiseLike(r)?r.then(w,E):w(r)}));return h});return function(a){return b.apply(this,arguments)}}();e._updateGLTexture=function(b,a){b.glTexture=a;this.events.emit("changed",1)};e._onTextureUnloaded=function(b){this._idToRefCountedTexture.delete(b);this._frameUpdates.delete(b)};l._createClass(g,[{key:"updating",get:function(){return 0<this._loadingCount||
this._frameTask.updating}},{key:"textureTechnique",get:function(){p.isNone(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(u.TextureTechnique,new u.TextureTechniqueConfiguration));return this._textureTechnique}}]);return g}(x);m.__decorate([q.property()],f.TextureRepository.prototype,"_loadingCount",void 0);m.__decorate([q.property()],f.TextureRepository.prototype,"_frameTask",void 0);m.__decorate([q.property()],f.TextureRepository.prototype,"updating",null);f.TextureRepository=
m.__decorate([A.subclass("esri.views.3d.webgl-engine.lib.TextureRepository")],f.TextureRepository);let D=function(){function k(e,b){this.id=e;this._release=b;this._refCount=0}var g=k.prototype;g.ref=function(){++this._refCount};g.release=function(){--this._refCount;0<this._refCount||(0===this._refCount?this._release():(v.error("Cannot dereference texture that has no references!"),this._refCount=0))};l._createClass(k,[{key:"isUnreferenced",get:function(){return 0===this._refCount}}]);return k}();Object.defineProperty(f,
"__esModule",{value:!0})});