// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/compilerUtils ../../../../core/Error ../../../../core/Evented ../../../../core/mathUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/typedArrayUtil ../../../../core/urlUtils ../../../../support/requestImageUtils ../../../../support/requestUtils ./BasisUtil ./ContentObject ./DDSUtil ./glUtil3D ./Util ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util ../../../webgl/capabilities/isWebGL2Context".split(" "),
function(x,t,A,B,C,u,k,y,m,w,D,E,v,p,F,G,H,I,q,J,K){p=function(z){function h(a,c){var b=z.call(this)||this;b.data=a;b.type=4;b._glTexture=null;b._powerOfTwoStretchInfo=null;b._loadingPromise=null;b._loadingController=null;b.events=new C;b.params=c||{};b.params.mipmap=!1!==b.params.mipmap;b.params.noUnpackFlip=b.params.noUnpackFlip||!1;b.params.preMultiplyAlpha=b.params.preMultiplyAlpha||!1;b.params.wrap=b.params.wrap||{s:10497,t:10497};b.params.powerOfTwoResizeMode=b.params.powerOfTwoResizeMode||
1;b.estimatedTexMemRequired=h.estimateTexMemRequired(b.data,b.params);b.startPreload();return b}t._inheritsLoose(h,z);var g=h.prototype;g.startPreload=function(){const a=this.data;k.isNone(a)||(a instanceof HTMLVideoElement?this.startPreloadVideoElement(a):a instanceof HTMLImageElement&&this.startPreloadImageElement(a))};g.startPreloadVideoElement=function(a){w.isBlobProtocol(a.src)||"auto"===a.preload&&a.crossOrigin||(a.preload="auto",a.crossOrigin="anonymous",a.src=a.src)};g.startPreloadImageElement=
function(a){w.isDataProtocol(a.src)||w.isBlobProtocol(a.src)||a.crossOrigin||(a.crossOrigin="anonymous",a.src=a.src)};h.getDataDimensions=function(a){return a instanceof HTMLVideoElement?{width:a.videoWidth,height:a.videoHeight}:a};h.estimateTexMemRequired=function(a,c){if(k.isNone(a))return 0;if(m.isArrayBuffer(a)||m.isUint8Array(a))return c.encoding===h.KTX2_ENCODING?v.estimateMemoryKTX2(a,c.mipmap):c.encoding===h.BASIS_ENCODING?v.estimateMemoryBasis(a,c.mipmap):a.byteLength;const {width:b,height:e}=
a instanceof Image||a instanceof ImageData||a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement?h.getDataDimensions(a):c;return(c.mipmap?4/3:1)*b*e*(c.components||4)||0};g.dispose=function(){this.data=void 0};g.createDescriptor=function(a){var c;return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?9987:9729,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:null!=
(c=this.params.maxAnisotropy)?c:this.params.mipmap?a.parameters.maxMaxAnisotropy:1}};g.load=function(a,c){if(k.isSome(this._glTexture))return this._glTexture;if(k.isSome(this._loadingPromise))return this._loadingPromise;const b=this.data;return k.isNone(b)?this._glTexture=new q(a,this.createDescriptor(a),null):"string"===typeof b?this.loadFromURL(a,c,b):b instanceof Image?this.loadFromImageElement(a,c,b):b instanceof HTMLVideoElement?this.loadFromVideoElement(a,c,b):b instanceof ImageData||b instanceof
HTMLCanvasElement?this.loadFromImage(a,b,c):(m.isArrayBuffer(b)||m.isUint8Array(b))&&this.params.encoding===h.DDS_ENCODING?this.loadFromDDSData(a,b):(m.isArrayBuffer(b)||m.isUint8Array(b))&&this.params.encoding===h.KTX2_ENCODING?this.loadFromKTX2(a,b):(m.isArrayBuffer(b)||m.isUint8Array(b))&&this.params.encoding===h.BASIS_ENCODING?this.loadFromBasis(a,b):m.isUint8Array(b)?this.loadFromPixelData(a,b):m.isArrayBuffer(b)?this.loadFromPixelData(a,new Uint8Array(b)):null};g.frameUpdate=function(a,c,b){if(!(this.data instanceof
HTMLVideoElement)||k.isNone(this._glTexture)||2>this.data.readyState||b===this.data.currentTime)return b;if(k.isSome(this._powerOfTwoStretchInfo)){const {framebuffer:e,vao:f,sourceTexture:d}=this._powerOfTwoStretchInfo;d.setData(this.data);this.drawStretchedTexture(a,c,e,f,d,this._glTexture)}else{const {width:e,height:f}=this.data,{width:d,height:l}=this._glTexture.descriptor;e!==d||f!==l?this._glTexture.updateData(0,0,0,Math.min(e,d),Math.min(f,l),this.data):this._glTexture.setData(this.data)}this._glTexture.descriptor.hasMipmap&&
this._glTexture.generateMipmap();return this.data.currentTime};g.loadFromDDSData=function(a,c){return this._glTexture=F.createDDSTexture(a,this.createDescriptor(a),c)};g.loadFromKTX2=function(a,c){return this.loadAsync(()=>v.createTextureKTX2(a,this.createDescriptor(a),c).then(b=>this._glTexture=b))};g.loadFromBasis=function(a,c){return this.loadAsync(()=>v.createTextureBasis(a,this.createDescriptor(a),c).then(b=>this._glTexture=b))};g.loadFromPixelData=function(a,c){H.assert(0<this.params.width&&
0<this.params.height);const b=this.createDescriptor(a);b.pixelFormat=1===this.params.components?6409:3===this.params.components?6407:6408;b.width=this.params.width;b.height=this.params.height;return this._glTexture=new q(a,b,c)};g.loadFromURL=function(a,c,b){var e=this;return this.loadAsync(function(){var f=t._asyncToGenerator(function*(d){d=yield D.requestImage(b,{signal:d});return e.loadFromImage(a,d,c)});return function(d){return f.apply(this,arguments)}}())};g.loadFromImageElement=function(a,
c,b){var e=this;return b.complete?this.loadFromImage(a,b,c):this.loadAsync(function(){var f=t._asyncToGenerator(function*(d){d=yield E.loadImageAsync(b,b.src,!1,d);return e.loadFromImage(a,d,c)});return function(d){return f.apply(this,arguments)}}())};g.loadFromVideoElement=function(a,c,b){return 2<=b.readyState?this.loadFromImage(a,b,c):this.loadFromVideoElementAsync(a,c,b)};g.loadFromVideoElementAsync=function(a,c,b){return this.loadAsync(e=>new Promise((f,d)=>{const l=()=>{b.removeEventListener("loadeddata",
r);b.removeEventListener("error",n);k.removeMaybe(L)},r=()=>{2<=b.readyState&&(l(),f(this.loadFromImage(a,b,c)))},n=M=>{l();d(M||new B("Failed to load video"))};b.addEventListener("loadeddata",r);b.addEventListener("error",n);const L=y.onAbort(e,()=>n(y.createAbortError()))}))};g.loadFromImage=function(a,c,b){const e=h.getDataDimensions(c);this.params.width=e.width;this.params.height=e.height;const f=this.createDescriptor(a);f.pixelFormat=3===this.params.components?6407:6408;if(this.requiresPowerOfTwo(a,
f)&&(!u.isPowerOfTwo(e.width)||!u.isPowerOfTwo(e.height)))return this._glTexture=this.makePowerOfTwoTexture(a,c,e,f,b);f.width=e.width;f.height=e.height;return this._glTexture=new q(a,f,c)};g.loadAsync=function(a){const c=new AbortController;this._loadingController=c;const b=a(c.signal);this._loadingPromise=b;a=()=>{this._loadingController===c&&(this._loadingController=null);this._loadingPromise===b&&(this._loadingPromise=null)};b.then(a,a);return b};g.requiresPowerOfTwo=function(a,c){const b="number"===
typeof c.wrapMode?33071===c.wrapMode:33071===c.wrapMode.s&&33071===c.wrapMode.t;return!K(a.gl)&&(c.hasMipmap||!b)};g.makePowerOfTwoTexture=function(a,c,b,e,f){const {width:d,height:l}=b;b=u.nextHighestPowerOfTwo(d);const r=u.nextHighestPowerOfTwo(l);e.width=b;e.height=r;let n;switch(this.params.powerOfTwoResizeMode){case 2:e.textureCoordinateScaleFactor=[d/b,l/r];n=new q(a,e);n.updateData(0,0,0,d,l,c);break;case 1:case null:case void 0:n=this.stretchToPowerOfTwo(a,c,e,f());break;default:A.neverReached(this.params.powerOfTwoResizeMode)}e.hasMipmap&&
n.generateMipmap();return n};g.stretchToPowerOfTwo=function(a,c,b,e){const f=new q(a,b),d=new I(a,{colorTarget:0,depthStencilTarget:0},f);c=new q(a,{target:3553,pixelFormat:b.pixelFormat,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!!b.flipped,maxAnisotropy:8,preMultiplyAlpha:b.preMultiplyAlpha},c);b=G.createQuadVAO(a);const l=a.getBoundFramebufferObject();this.drawStretchedTexture(a,e,d,b,c,f);this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:b,sourceTexture:c,framebuffer:d}:(b.dispose(!0),
c.dispose(),d.detachColorTexture(),d.dispose());a.bindFramebuffer(l);return f};g.drawStretchedTexture=function(a,c,b,e,f,d){a.bindFramebuffer(b);b=a.getViewport();a.setViewport(0,0,d.descriptor.width,d.descriptor.height);d=c.program;a.useProgram(d);d.setUniform4f("color",1,1,1,1);d.bindTexture(f,"tex");a.bindVAO(e);c.bindPipelineState(a);a.drawArrays(5,0,J.vertexCount(e,"geometry"));a.bindFramebuffer(null);a.setViewport(b.x,b.y,b.width,b.height)};g.unload=function(){if(k.isSome(this._powerOfTwoStretchInfo)){const {framebuffer:a,
vao:c,sourceTexture:b}=this._powerOfTwoStretchInfo;c.dispose(!0);b.dispose();a.dispose();this._powerOfTwoStretchInfo=this._glTexture=null}k.isSome(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null);if(k.isSome(this._loadingController)){const a=this._loadingController;this._loadingPromise=this._loadingController=null;a.abort()}this.events.emit("unloaded")};t._createClass(h,[{key:"width",get:function(){return this.params.width}},{key:"height",get:function(){return this.params.height}},
{key:"glTexture",get:function(){return this._glTexture}},{key:"requiresFrameUpdates",get:function(){return this.data instanceof HTMLVideoElement}}]);return h}(p.ContentObject);p.DDS_ENCODING="image/vnd-ms.dds";p.KTX2_ENCODING="image/ktx2";p.BASIS_ENCODING="image/x.basis";x.Texture=p;Object.defineProperty(x,"__esModule",{value:!0})});