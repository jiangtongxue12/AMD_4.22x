// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/Handles ../../../../core/mathUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../webgl/BufferObject ../../../webgl/FramebufferObject ../../../webgl/checkWebGLError ../../../webgl/enums ../../../../chunks/builtins ../../../webgl/Texture ../../../webgl/VertexArrayObject ./Camera ./depthRange ./glUtil3D ./ShadowCastRenderer ./ShadowMap ./Util ../../../../chunks/ShadowCast.glsl ../shaders/ShadowCastTechnique ../../../support/Scheduler ../../../webgl/Util".split(" "),
function(d,q,g,C,D,E,F,l,u,h,T,U,G,v,H,I,w,J,K,V,L,W,X,Y,Z,aa,x,y,M,r,N,O,P,z,Q,R){var n;d.ShadowAccumulator=n=function(A){function t(a,c,f,k,p,m){var b=A.call(this,{})||this;b._rctx=a;b._stage=f;b._prepareForShadowMapPass=k;b._renderToShadowMap=p;b._requestRender=m;b._progress=0;b._sampleCount=0;b._cachedCamera=new x;b._contentCamera=new x;b._enabled=!1;b._cachedLightDirections=[];b._depthRange=y.ZERO;b._previewing=!1;b._handles=new E;b._cameraForcedForScreenshot=!1;b._shadowMap=new N(a,f.viewingMode);
b._shadowMap.enabled=!0;b._vao=M.createQuadVAO(a);b._fbo=new L(a,{colorTarget:0,depthStencilTarget:0,width:0,height:0},{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0});b._accumulationParams={camera:b._cachedCamera,linearDepthTexture:null,shadowMap:b._shadowMap,inverseView:H.create(),projInfo:K.create(),zScale:I.create()};b._accumulationRenderer=new r.ShadowCastRenderer(c,a,q._assertThisInitialized(b),m);b._handles.add(b._stage.resourceController.scheduler.registerTask(Q.TaskPriority.SHADOW_ACCUMULATOR,
q._assertThisInitialized(b)));b._handles.add(u.react(()=>f.renderView,B=>{b._handles.remove(n.renderViewHandleKey);l.isNone(B)||b._handles.add(B.events.on("force-camera-for-screenshot",()=>b._cameraForcedForScreenshot=!0),n.renderViewHandleKey)},u.syncAndInitial));return b}q._inheritsLoose(t,A);var e=t.prototype;e.normalizeCtorArgs=function(){return{}};e.runTask=function(a){for(this._prepareForShadowMapPass(this._cachedCamera,this._contentCamera);!a.done&&!this._isDoneAccumulating;)this._accumulateShadow(),
a.madeProgress();this._requestRender()};e.accumulateFixedSamples=function(){if(this.isAccumulating&&this._canAccumulate){(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();var a=this._cameraForcedForScreenshot?this._sampleCount:Math.min(n.previewSamples,this._sampleCount-this._progress);for(let c=0;c<a;++c)this._accumulateShadow();this._cameraForcedForScreenshot=!1}};e.render=function(){this._accumulationRenderer.render()};e.dispose=function(){this._stop();this._handles.destroy();
this._accumulationRenderer=l.disposeMaybe(this._accumulationRenderer);this._shadowMap=l.disposeMaybe(this._shadowMap);this._fbo=l.disposeMaybe(this._fbo);this._vao=l.disposeMaybe(this._vao);this._accumulationTechnique=l.disposeMaybe(this._accumulationTechnique);this._sampleCount=this._cachedLightDirections.length=0};e.setOptions=function(a){void 0!==a.enabled&&this._setEnabled(a.enabled);void 0!==a.previewing&&this.setPreviewing(a.previewing);void 0!==a.lightDirections&&this.setLightDirections(a.lightDirections);
this._accumulationRenderer.setOptions(a)};e.setPreviewing=function(a){this._previewing!==a&&(this._previewing=a,this._requestRenderIfEnabled())};e.setLightDirections=function(a){this._lightDirections=a};e.setAccumulationDependencies=function(a,c,f,k){this._accumulationParams.linearDepthTexture=a;this._depthRange=c;this._updateCamera(f);this._contentCamera=k;this.notifyChange("_canAccumulate")};e.readAccumulatedShadow=function(a,c){if(!this._isActive||1>this._progress||0>a||a>this._fbo.width||0>c||
c>this._fbo.height)return 0;const f=S;this._fbo.readPixels(a,c,1,1,6408,5121,f);return f[0]/this._progress};e._start=function(){this._progress=0;this._enabled=!0};e._stop=function(){this._enabled=!1};e._invalidate=function(){this._progress=0;this._requestRenderIfEnabled()};e._clear=function(){this._rctx.bindFramebuffer(this._fbo);this._rctx.setClearColor(0,0,0,0);this._rctx.clearSafe(16384);this._progress=0};e._accumulateShadow=function(){this._renderToShadowMap(this._shadowMap,this._lightDirections[this._progress],
this._cachedCamera,this._depthRange);this._rctx.bindFramebuffer(this._fbo);const a=this.accumulationTechnique;this._rctx.useProgram(a.program);a.bindPipelineState(this._rctx);a.bindPass(this._accumulationParams);this._rctx.bindVAO(this._vao);this._rctx.drawArrays(a.primitiveType,0,R.vertexCount(this._vao,"geometry"));this._progress++};e._updateCamera=function(a){if(!a.equals(this._cachedCamera)){var {fullWidth:c,fullHeight:f,projectionMatrix:k,viewMatrix:p,center:m}=a;this._cachedCamera.copyFrom(a);
this._fbo.resize(c,f);O.inverseProjectionInfo(k,c,f,this._projInfo,this._zScale);v.translate(this._inverseView,p,m);v.invert(this._inverseView,this._inverseView);this._opacityFromElevation=1-F.smoothstep(r.shadowCastDisableElevationMin,r.shadowCastDisableElevationMax,a.relativeElevation)}};e._setEnabled=function(a){a!==this._enabled&&(a?this._start():this._stop())};e._requestRenderIfEnabled=function(){this._enabled&&this._requestRender()};q._createClass(t,[{key:"computedSamples",get:function(){return this._progress}},
{key:"shadowCastTexture",get:function(){return this._fbo.colorTexture}},{key:"isAccumulating",get:function(){return this._isPreviewing||this._isRefining}},{key:"accumulationTechnique",get:function(){if(l.isNone(this._accumulationTechnique)){const a={rctx:this._rctx,viewingMode:this._stage.viewingMode},c=new z.ShadowCastTechniqueConfiguration;c.pass=0;this._accumulationTechnique=new z.ShadowCastTechnique(a,c)}return this._accumulationTechnique}},{key:"_isRefining",get:function(){return this._isActive&&
!this._isDoneAccumulating&&!this._previewing}},{key:"_isPreviewing",get:function(){return this._isActive&&this._previewing}},{key:"_isActive",get:function(){return this._enabled&&0<this._sampleCount}},{key:"_canAccumulate",get:function(){return null!==this._accumulationParams.linearDepthTexture&&this._depthRange!==y.ZERO&&this._opacityFromElevation>r.shadowCastDisabledElevationThreshold}},{key:"_isDoneAccumulating",get:function(){return this._progress>=this._sampleCount}},{key:"_lightDirections",
get:function(){return this._cachedLightDirections},set:function(a){const c=this._cachedLightDirections;if(!D.equals(c,a,w.equals)){var f=a.length;c.length=f;this._sampleCount=Math.min(P.shadowCastMaxSamples,f);for(let k=0;k<f;++k){const p=a[k],m=c[k]||J.create();w.copy(m,p);c[k]=m}this._invalidate()}}},{key:"_projInfo",get:function(){return this._accumulationParams.projInfo}},{key:"_zScale",get:function(){return this._accumulationParams.zScale}},{key:"_inverseView",get:function(){return this._accumulationParams.inverseView}},
{key:"_opacityFromElevation",get:function(){return this._accumulationRenderer.opacityFromElevation},set:function(a){this._accumulationRenderer.opacityFromElevation=a}},{key:"running",get:function(){return this._isRefining&&this._canAccumulate&&0<this._progress}},{key:"test",get:function(){return{lightDirections:this._lightDirections,isDone:()=>this._isDoneAccumulating,isActive:()=>this._isActive}}}]);return t}(C);d.ShadowAccumulator.previewSamples=6;d.ShadowAccumulator.renderViewHandleKey="renderView";
g.__decorate([h.property()],d.ShadowAccumulator.prototype,"_progress",void 0);g.__decorate([h.property()],d.ShadowAccumulator.prototype,"_sampleCount",void 0);g.__decorate([h.property()],d.ShadowAccumulator.prototype,"_enabled",void 0);g.__decorate([h.property()],d.ShadowAccumulator.prototype,"_depthRange",void 0);g.__decorate([h.property()],d.ShadowAccumulator.prototype,"_previewing",void 0);g.__decorate([h.property()],d.ShadowAccumulator.prototype,"_accumulationRenderer",void 0);g.__decorate([h.property()],
d.ShadowAccumulator.prototype,"_isRefining",null);g.__decorate([h.property()],d.ShadowAccumulator.prototype,"_isActive",null);g.__decorate([h.property()],d.ShadowAccumulator.prototype,"_canAccumulate",null);g.__decorate([h.property()],d.ShadowAccumulator.prototype,"_isDoneAccumulating",null);g.__decorate([h.property()],d.ShadowAccumulator.prototype,"_opacityFromElevation",null);g.__decorate([h.property()],d.ShadowAccumulator.prototype,"running",null);d.ShadowAccumulator=n=g.__decorate([G.subclass("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],
d.ShadowAccumulator);const S=new Uint8Array(4);Object.defineProperty(d,"__esModule",{value:!0})});