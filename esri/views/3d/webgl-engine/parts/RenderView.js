// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/scheduling ../../../../core/time ../../../../core/watchUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../support/animationUtils ../collections/Component/ComponentObjectCollection ../core/shaderTechnique/ShaderTechniqueRepository ../lib/AutoDisposable ../lib/CompositingHelper ../lib/depthRangeUtils ../lib/GLMaterialRepository ../lib/MagnifierHelper ../lib/Renderer ../lib/RenderingContext ../lib/TextureRepository ../materials/StippleTextureRepository ../materials/internal/WaterTextureRepository ./requireUtils ./ScreenshotManager ../../../webgl/context-util".split(" "),
function(f,t,g,z,A,x,B,m,C,D,E,n,U,V,F,G,H,I,k,J,K,L,M,N,O,P,Q,R,S,T,u){const y=B.getLogger("esri.views.3d.webgl-engine.parts.View");f.RenderView=function(v){function p(b){var a=v.call(this,{})||this;a.events=new A;a.waterTextureRepository=new R.WaterTextureRepository;a._magnifierHelper=new M.MagnifierHelper;a._needsUpdate=!0;a._needsRender=!0;a._idleSuspend=!0;a._needsWaterReflectionUpdate=!1;a._logicUpdateLast=0;a._container=b.container;a._initializeContext(b);E.init(a.waterTextureRepository,"loadingState",
()=>a.requestRender());a._magnifierHelper.events.on("request-render",()=>a.requestRender());a._stippleTextureRepository=new Q.StippleTextureRepository(a._rctx);a._shaderTechniqueRepository=new I.ShaderTechniqueRepository({rctx:a._rctx,viewingMode:b.viewingMode,stippleTextureRepository:a._stippleTextureRepository,waterTextureRepository:a.waterTextureRepository});a._textureRepository=new P.TextureRepository(b,a._shaderTechniqueRepository,a._rctx);a._textureRepository.events.on("changed",d=>a.requestRender(d));
a._materialRepository=new L.GLMaterialRepository(a._textureRepository,a._shaderTechniqueRepository,()=>a.requestRender(),()=>a.requestRender());a._compositingHelper=new J(a._rctx,a._shaderTechniqueRepository);a._renderer=new N.Renderer(a._materialRepository,a._textureRepository,a._shaderTechniqueRepository,a._rctx,a._compositingHelper,a._magnifierHelper,d=>a.requestRender(d),(d,c)=>b.schedule(d,c),b);a._screenshotManager=new T.ScreenshotManager(a._rctx,(d,c,e)=>a._renderer.render(d,c,c,e),d=>a.requestRender(d),
b.options.screenshot.renderOverlay,d=>a.events.emit("force-camera-for-screenshot",d));a._registerFrameTask(b);return a}t._inheritsLoose(p,v);var h=p.prototype;h.normalizeCtorArgs=function(){return{}};h.dispose=function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas);this._frameTask=m.removeMaybe(this._frameTask);this._shaderTechniqueRepository=m.disposeMaybe(this._shaderTechniqueRepository);v.prototype.dispose.call(this);this._rctx=this._tmpDepthBuffer=null};h.requestRender=
function(b=1){1===b?this._needsUpdate=!0:this._needsRender=!0};h.ensureEdgeView=function(){return this._renderer.ensureEdgeView()};h.updateLightSources=function(b,a,d){this._renderer.updateLightSources(b,a,d);this.requestRender()};h.setRenderParameters=function(b){void 0!==b.idleSuspend&&this._idleSuspend!==!!b.idleSuspend&&(this._idleSuspend=!!b.idleSuspend,this.requestRender());this._renderer.setRenderParameters(b)};h.modify=function(b){this._renderer.modify(b);b.clear()};h.takeScreenshot=function(b){return this._screenshotManager.takeScreenshot(b)};
h.readAccumulatedShadow=function(b){return this._renderer.readAccumulatedShadow(b[0],b[1])};h.getMinimalDepthForArea=function(b,a,d,c,e,l=e){l=c.constrainWindowSize(a,d,e*c.pixelRatio,l*c.pixelRatio);const q=this._ensureDepthBuffer(l);this._renderer.readDepthPixels(c,l[0],l[1],l[2],l[3],q);e=Number.MAX_VALUE;for(let w=0;w<l[2]*l[3];w++){const r=K.textureToDepth(4*w,q,c.nearFar);e>r&&r!==c.nearFar[0]&&r!==c.nearFar[1]&&(e=r)}m.isSome(b)&&(b=b.pickDepth(a*c.pixelRatio,d*c.pixelRatio,c),m.isSome(b)&&
e>b&&b!==c.nearFar[0]&&b!==c.nearFar[1]&&(e=b));return e===Number.MAX_VALUE?void 0:e};h._ensureDepthBuffer=function(b){b=4*b[2]*b[3];if(m.isNone(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<b)this._tmpDepthBuffer=new Uint8Array(b);return this._tmpDepthBuffer};h.reloadShaders=function(){var b=t._asyncToGenerator(function*(){S.removeLoadedShaderModules();yield this._shaderTechniqueRepository.reloadAll();this.requestRender()});return function(){return b.apply(this,arguments)}}();h._registerFrameTask=
function(b){const a=b.state,d={viewCamera:a.camera,frameHasDecorations:!1};this._frameTask=C.addFrameTask({preRender:c=>{b.processSyncLayers();var e=D.Milliseconds(c.time-this._logicUpdateLast);if(e>G.DESIRED_ANIMATION_MS||m.isSome(this.forcedAnimationTime))e={camera:a.camera,dt:e,forcedTime:this.forcedAnimationTime},this._logicUpdateLast=c.time,this._renderer.updateLogic(e)&&this.requestRender(0)},render:()=>{if((this._needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||
this._needsWaterReflectionUpdate)&&0<a.camera.fullWidth&&0<a.camera.fullHeight){const c=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsWaterReflectionUpdate=this._needsUpdate=this._needsRender=!1;this._renderer.render(null,a.camera,a.contentCamera,1);c&&this._renderer.hasWaterReflection&&(this.requestRender(0),this._needsWaterReflectionUpdate=!0)}},update:()=>{d.viewCamera=a.camera;d.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled;this._textureRepository.update();
this._screenshotManager.update(d)}})};h._initializeContext=function(b){const a=b.options;this._canvas=a.canvas;this._canvas||(this._canvas=document.createElement("canvas"));this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const d={alpha:a.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==a.stencil?!0:a.stencil,powerPreference:"high-performance"};let c;const e=x("esri-force-webgl");1===e||2===e?c=u.createContextOrErrorHTML(this._canvas,e,d):(c=u.createContext(this._canvas,
2,d),m.isNone(c)&&(c=u.createContextOrErrorHTML(this._canvas,1,d)));m.isNone(c)?y.error("A WebGL context with the requested version ("+e?e:"automatic) could not be created."):(this._rctx=new O.RenderingContext(c,{disabledExtensions:a.deactivatedWebGLExtensions||{},debugWebGLExtensions:a.debugWebGLExtensions||{},maxAnisotropy:8},(l,q)=>b.resourceController.memoryController.newCache(l,q)),this._loadShaderOnlyExtensions(),!a.alpha&&this._rctx.contextAttributes.alpha&&y.error("WebGL context has alpha channel even though no alpha channel was requested"),
!this._rctx.contextAttributes.alpha&&11<=x("safari")&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas))};h._loadShaderOnlyExtensions=function(){this._rctx.capabilities.enable("standardDerivatives");this._rctx.capabilities.enable("shaderTextureLOD");this._rctx.capabilities.enable("textureFloat")};t._createClass(p,[{key:"performanceInfo",get:function(){const b=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:void 0!==b.getUsedTextureMemory?
b.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==b.getUsedRenderbufferMemory?b.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==b.getUsedVBOMemory?b.getUsedVBOMemory():void 0}}},{key:"updating",get:function(){return this._needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}},{key:"edgeView",get:function(){return this._renderer.edgeView}},{key:"textureRepository",
get:function(){return this._textureRepository}},{key:"compositingHelper",get:function(){return this._compositingHelper}},{key:"magnifier",set:function(b){this._magnifierHelper.magnifier=b}},{key:"renderingContext",get:function(){return this._rctx}},{key:"capabilities",get:function(){return this._rctx.capabilities}},{key:"canvas",get:function(){return this._canvas}},{key:"hasShadowsEnabled",get:function(){return this._renderer.hasShadowsEnabled}},{key:"renderPlugins",get:function(){return this._renderer.renderPlugins}},
{key:"test",get:function(){return{renderer:this._renderer}}},{key:"gpuMemoryUsage",get:function(){return this._renderer.gpuMemoryUsage}},{key:"componentObjectCollection",get:function(){m.isNone(this._componentObjectCollection)&&(this._componentObjectCollection=new H.ComponentObjectCollection(this._renderer.renderPassManager));return this._componentObjectCollection},set:function(b){this._componentObjectCollection=b}}]);return p}(k.AutoDisposableMixin(z));g.__decorate([n.property({type:Boolean,readOnly:!0})],
f.RenderView.prototype,"updating",null);g.__decorate([k.autoDispose()],f.RenderView.prototype,"_rctx",void 0);g.__decorate([k.autoDispose()],f.RenderView.prototype,"_container",void 0);g.__decorate([k.autoDispose()],f.RenderView.prototype,"_canvas",void 0);g.__decorate([k.autoDispose()],f.RenderView.prototype,"_stippleTextureRepository",void 0);g.__decorate([k.autoDispose(),n.property()],f.RenderView.prototype,"waterTextureRepository",void 0);g.__decorate([k.autoDispose(),n.property()],f.RenderView.prototype,
"_magnifierHelper",void 0);g.__decorate([k.autoDispose(),n.property()],f.RenderView.prototype,"_textureRepository",void 0);g.__decorate([k.autoDispose()],f.RenderView.prototype,"_compositingHelper",void 0);g.__decorate([k.autoDispose()],f.RenderView.prototype,"_renderer",void 0);g.__decorate([k.autoDispose()],f.RenderView.prototype,"_screenshotManager",void 0);g.__decorate([k.autoDispose()],f.RenderView.prototype,"componentObjectCollection",null);g.__decorate([k.autoDispose()],f.RenderView.prototype,
"_componentObjectCollection",void 0);g.__decorate([n.property()],f.RenderView.prototype,"_needsUpdate",void 0);g.__decorate([n.property()],f.RenderView.prototype,"_needsWaterReflectionUpdate",void 0);f.RenderView=g.__decorate([F.subclass("esri.views.3d.webgl-engine.parts.RenderView")],f.RenderView);Object.defineProperty(f,"__esModule",{value:!0})});