// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/PooledArray ../../../../chunks/mat4 ../../../../chunks/mat4f32 ../../../../chunks/vec3 ../../../../chunks/vec3f32 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/plane ../../../../geometry/support/ray ./PointHighlights ../../support/orientedBoundingBox ../../webgl-engine/core/shaderLibrary/Slice.glsl ../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl ../../webgl-engine/lib/DefaultVertexAttributeLocations ../../webgl-engine/lib/Intersector ../../webgl-engine/shaders/PointRendererTechnique ../../../webgl/BufferObject ../../../webgl/VertexArrayObject".split(" "),
function(L,Z,x,aa,Q,ba,q,ca,G,da,r,ea,fa,ha,M,ia,ja,ka,la,V,W,ma){function H(k,f,a,b,c){if(a.drawScreenSpace)return a.fixedSize*f*b;c=(c?256:64)*f*b;return a.drawFixedSize?Math.min(a.fixedSize/2,c):0<a.screenMinSize?Math.min(Math.max(a.screenMinSize*f*b,k/2),c):Math.min(k/2,c)}function X(k){return x.isSome(k.component)?k.component:-1}function na(k,f){if(x.isNone(k))return k;k=k.filter(a=>a.id!==f);return 0===k.length?null:k}const oa={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,
normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]};L.PointRenderer=function(){function k(a){this._params=a;this.type=5;this.isGround=!1;this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null};this._highlights=new ha.PointHighlights({forEachNode:b=>this.forEachNode(b),addHighlight:(b,c,d)=>this.addHighlight(b,c,d),removeHighlight:(b,c)=>this.removeHighlight(b,c)});this.canRender=!0;this.layerUid="";this._useFixedSizes=!1;this._scaleFactor=1;this._minSizePx=
0;this._useRealWorldSymbolSizes=!1;this._sizePx=this._size=0;this._slicePlaneEnabled=!1;this._clipBox=r.create(r.POSITIVE_INFINITY);this._techniqueConfig=new V.PointRendererTechniqueConfiguration;this.tempMatrix4=ba.create();this.tempVec3=ca.create();this.nodes=new aa}var f=k.prototype;f.initializeRenderContext=function(a){this._context=a;this._techniqueRep=this._context.shaderTechniqueRep;a.requestRender()};f.uninitializeRenderContext=function(){};f.intersect=function(a,b,c,d){const l=G.create(),
g=G.create(),I=G.create(),u=G.create(),J=ea.create(),h=a.camera.perScreenPixelRatio/2,m=a.camera.near,y=this._getSizeParams();q.subtract(g,d,c);const N=1/q.length(g);q.scale(g,g,N);q.negate(I,g);da.set(J,g[0],g[1],g[2],-q.dot(g,c));let R=function(){this.normal=this.dist=this.point=this.pointId=this.node=null;this.layerUid=""};const z=new R,A=new R,Y=[],O=r.create(),P=r.create(this._clipBox);r.offset(P,-c[0],-c[1],-c[2],P);this.nodes.forAll(e=>{const n=e.splatSize*this._scaleFactor;var t=M.minimumDistancePlane(e.obb,
J),p=M.maximumDistancePlane(e.obb,J);t-=y.drawScreenSpace?0:H(n,t+m,y,h,e.isLeaf);p-=y.drawScreenSpace?0:H(n,p+m,y,h,e.isLeaf);t=null!=z.dist&&null!=A.dist&&z.dist<t*N&&A.dist>p*N;if(!(0>p||t)&&(p=H(n,p+m,y,h,e.isLeaf),M.intersectLine(e.obb,c,g,p))){p*=p;M.toAaBoundingBox(e.obb,O);r.offset(O,-c[0],-c[1],-c[2],O);t=!r.contains(P,O);q.subtract(u,e.origin,c);var pa=e.coordinates.length/3;for(let B=0;B<pa;B++){l[0]=u[0]+e.coordinates[3*B];l[1]=u[1]+e.coordinates[3*B+1];l[2]=u[2]+e.coordinates[3*B+2];
if(t&&!r.containsPoint(P,l))continue;var v=q.dot(l,g),K=q.squaredLength(l)-v*v;if(K>p)continue;var D=v+m;const S=y.drawScreenSpace?0:H(n,D,y,h,e.isLeaf);if(0>v-S)continue;D-=S;D=H(n,D,y,h,e.isLeaf);if(K>D*D)continue;const E=(v-S)*N;v=C=>{var T=B,F=C.point;null==F&&(F=G.create());F[0]=e.origin[0]+e.coordinates[3*T];F[1]=e.origin[1]+e.coordinates[3*T+1];F[2]=e.origin[2]+e.coordinates[3*T+2];C.point=F;C.dist=E;C.normal=I;C.node=e;C.pointId=B;C.layerUid=this.layerUid};(null==z.dist||E<z.dist)&&(null==
b||b(c,d,E))&&v(z);0!==a.options.store&&(null==A.dist||E>A.dist)&&(null==b||b(c,d,E))&&v(A);2!==a.options.store||null!=b&&!b(c,d,E)||(K=new R,v(K),Y.push(K))}}});const qa=e=>{const {layerUid:n,node:t,pointId:p}=e;return{point:e.point,layerUid:n,graphicUid:p,createGraphic:()=>this._params.createGraphic(t,p,e.point)}},U=(e,n)=>{const t=qa(n);e.set(this.type,t,n.dist,n.normal)};if(null!=z.dist){var w=a.results.min;(null==w.dist||z.dist<w.dist)&&U(w,z)}null!=A.dist&&0!==a.options.store&&(w=a.results.max,
(null==w.dist||A.dist>w.dist)&&U(w,A));if(2===a.options.store){w=fa.fromPoints(c,d);for(const e of Y){const n=la.newIntersectorResult(w);U(n,e);a.results.all.push(n)}}};f.render=function(a){if(0===this.nodes.length||0!==a.pass&&2!==a.pass&&5!==a.pass)return!1;const b=this._getSizeParams(),c=this.selectTechnique(a,b),d=c.program;if(null==d)return!1;this.nodes.forAll(h=>{null==h.vao&&this._initNode(a,h)});const l=a.rctx;l.useProgram(d);c.bindPipelineState(l);const g=this._clipBox,I=!r.equals(g,r.POSITIVE_INFINITY,
(h,m)=>h===m);I||(q.set(this.tempVec3,-Infinity,-Infinity,-Infinity),d.setUniform3fv("uClipMin",this.tempVec3),q.set(this.tempVec3,Infinity,Infinity,Infinity),d.setUniform3fv("uClipMax",this.tempVec3));d.setUniformMatrix4fv("uProjectionMatrix",a.camera.projectionMatrix);2===a.pass&&d.setUniform2f("nearFar",a.camera.near,a.camera.far);a.isHighlightPass&&(this._bindParameters.inverseViewport[0]=1/a.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/a.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=
a.highlightDepthTexture,ja.bindOutputHighlight(d,this._bindParameters));const u=a.camera.pixelRatio;b.drawFixedSize&&d.setUniform2f("uPointScale",b.fixedSize*u,a.camera.fullHeight);const J=this._slicePlaneEnabled?a.sliceHelper&&a.sliceHelper.plane:null;this.nodes.forAll(h=>{if(0!==h.coordinates.length&&(!a.isHighlightPass||h.highlights)){d.setUniform2f("uScreenMinMaxSize",b.screenMinSize*u,(h.isLeaf?256:64)*u);b.drawFixedSize||d.setUniform2f("uPointScale",h.splatSize*this._scaleFactor*u,a.camera.fullHeight/
u);var m=h.origin;I&&(q.set(this.tempVec3,g[0]-m[0],g[1]-m[1],g[2]-m[2]),d.setUniform3fv("uClipMin",this.tempVec3),q.set(this.tempVec3,g[3]-m[0],g[4]-m[1],g[5]-m[2]),d.setUniform3fv("uClipMax",this.tempVec3));Q.identity(this.tempMatrix4);Q.translate(this.tempMatrix4,this.tempMatrix4,m);Q.multiply(this.tempMatrix4,a.camera.viewMatrix,this.tempMatrix4);d.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4);ia.bindSliceUniforms(d,c.configuration,J,m);l.bindVAO(h.vao);a.isHighlightPass?this._renderHighlightFragments(l,
h):l.drawArrays(0,0,h.coordinates.length/3)}});return!0};f._renderHighlightFragments=function(a,b){var c=b.highlights;if(!x.isNone(c)){b=x.unwrap(c[0].component);var d=b+1;for(let l=1;l<c.length;l++){const g=x.unwrap(c[l].component);g!==d&&(d-=b,0<d&&a.drawArrays(0,b,d),b=g);d=g+1}c=d-b;0<c&&a.drawArrays(0,b,c)}};f.addNode=function(a){this.nodes.push(a);this._highlights.nodeAdded(a);this._requestRender()};f.removeNode=function(a){let b=null;this.nodes.filterInPlace(c=>c.id===a?(b=c,c.vao=x.disposeMaybe(c.vao),
this._highlights.nodeRemoved(c),!1):!0);this._requestRender();return b};f.forEachNode=function(a){this.nodes.forAll(a)};f.removeAll=function(){this.nodes.forAll(a=>a.vao=x.disposeMaybe(a.vao));this._highlights.removeAll();this.nodes.clear();this._requestRender()};f.highlight=function(a){return this._highlights.add(a)};f.addHighlight=function(a,b,c){var d=a.highlights;x.isNone(d)&&(d=[]);b={component:b,id:c};d.push(b);b=X(b);for(c=d.length-1;0<c&&b<X(d[c-1]);)[d[c-1],d[c]]=[d[c],d[c-1]],--c;a.highlights=
d;this._requestRender()};f.removeHighlight=function(a,b){a.highlights=na(a.highlights,b);this._requestRender()};f._initNode=function(a,b){a=a.rctx;b.vao=new ma(a,ka.Default3D,oa,{positions:W.createVertex(a,35044,b.coordinates),colors:W.createVertex(a,35044,b.rgb)})};f._requestRender=function(){this._context&&this._context.requestRender()};f._getSizeParams=function(){const a=this._useFixedSizes,b=a&&!this._useRealWorldSymbolSizes;return{drawScreenSpace:b,drawFixedSize:a,fixedSize:b?this._sizePx:this._size,
screenMinSize:a?0:this._minSizePx}};f.selectTechnique=function(a,b){this._techniqueConfig.drawScreenSize=b.drawScreenSpace;this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled;this._techniqueConfig.sceneHasOcludees=a.hasOccludees;this._techniqueConfig.output=2===a.pass?1:5===a.pass?4:0;return this._techniqueRep.releaseAndAcquire(V.PointRendererTechnique,this._techniqueConfig,this._technique)};Z._createClass(k,[{key:"needsHighlight",get:function(){return this._highlights.hasHighlights}},
{key:"useFixedSizes",get:function(){return this._useFixedSizes},set:function(a){this._useFixedSizes!==a&&(this._useFixedSizes=a,this._requestRender())}},{key:"scaleFactor",get:function(){return this._scaleFactor},set:function(a){this._scaleFactor!==a&&(this._scaleFactor=a,this._requestRender())}},{key:"minSizePx",get:function(){return this._minSizePx},set:function(a){this._minSizePx!==a&&(this._minSizePx=a,this._requestRender())}},{key:"useRealWorldSymbolSizes",get:function(){return this._useRealWorldSymbolSizes},
set:function(a){this._useRealWorldSymbolSizes!==a&&(this._useRealWorldSymbolSizes=a,this._requestRender())}},{key:"size",get:function(){return this._size},set:function(a){this._size!==a&&(this._size=a,this._requestRender())}},{key:"sizePx",get:function(){return this._sizePx},set:function(a){this._sizePx!==a&&(this._sizePx=a,this._requestRender())}},{key:"clippingBox",set:function(a){r.set(this._clipBox,a||r.POSITIVE_INFINITY)}},{key:"slicePlaneEnabled",get:function(){return this._slicePlaneEnabled},
set:function(a){this._slicePlaneEnabled!==a&&(this._slicePlaneEnabled=a,this._requestRender())}}]);return k}();(function(k){k.isInstanceOfNode=function(f){return f.hasOwnProperty("splatSize")}})(L.PointRenderer||(L.PointRenderer={}));Object.defineProperty(L,"__esModule",{value:!0})});