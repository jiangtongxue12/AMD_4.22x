// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Error ../../../../core/maybe ../../../../chunks/earcut ../../../../chunks/mat3 ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/buffer/BufferView ../../../../chunks/vec32 ../../../../renderers/support/renderingInfoUtils ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./polygonUtils ../support/edgeUtils ../../support/debugFlags ../../support/ElevationProvider ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(ba,ca,ra,J,sa,ta,ua,da,N,B,D,va,R,ea,fa,wa,S,xa,ya,W,ha,ia,za,Aa,Ba,Ca,Da,ja){function Ea(g,l,f,a,b,c,e,n,h,t,p,q,k,r){let w=0;var v=2*a.count;{var d=a.index,y=a.count,x=f.length/3,m=h;B.copy(z,k);const u=0<q?1:-1;d*=3;let A=m;k=3*A;let E=m+y;m=3*E;for(let F=0;F<y;++F)r&&(z[0]=g[d+0],z[1]=g[d+1],z[2]=g[d+2],B.normalize(z,z)),b[k+0]=g[d+0],b[k+1]=g[d+1],b[k+2]=g[d+2],c[k+0]=l[d+0],c[k+1]=l[d+1],c[k+2]=l[d+2],e[k+0]=-u*z[0],e[k+1]=-u*z[1],e[k+2]=-u*z[2],n[A]=0,b[m+0]=g[d+0]+q*z[0],b[m+1]=g[d+
1]+q*z[1],b[m+2]=g[d+2]+q*z[2],c[m+0]=l[d+0],c[m+1]=l[d+1],c[m+2]=l[d+2],e[m+0]=u*z[0],e[m+1]=u*z[1],e[m+2]=u*z[2],n[E]=q,k+=3,m+=3,d+=3,A+=1,E+=1;k=d=0;m=3*v;g=0>q?ka:la;l=0>q?la:ka;for(r=0;r<x;++r)p[k+0]=f[d+g[0]],p[k+1]=f[d+g[1]],p[k+2]=f[d+g[2]],t[m+0]=f[d+l[0]]+y,t[m+1]=f[d+l[1]]+y,t[m+2]=f[d+l[2]]+y,k+=3,m+=3,d+=3}h+=2*a.count;v=0;ma(b,c,n,e,w,a.pathLengths[0],a.count,h,t,v,q);h+=4*a.pathLengths[0];v+=2*a.pathLengths[0];w+=a.pathLengths[0];for(f=1;f<a.pathLengths.length;++f)ma(b,c,n,e,w,a.pathLengths[f],
a.count,h,t,v,q),h+=4*a.pathLengths[f],v+=2*a.pathLengths[f],w+=a.pathLengths[f]}function T(g,l,f,a,b,c,e){a[c]=a[e];e*=3;c*=3;g[c+0]=g[e+0];g[c+1]=g[e+1];g[c+2]=g[e+2];l[c+0]=l[e+0];l[c+1]=l[e+1];l[c+2]=l[e+2];f[c+0]=b[0];f[c+1]=b[1];f[c+2]=b[2]}function ma(g,l,f,a,b,c,e,n,h,t,p){let q=b,k=b+1,r=b+e,w=b+e+1,v=n,d=n+1,y=n+2*c;n=n+2*c+1;0>p&&(q=b+e+1,w=b);t*=3;for(let F=0;F<c;++F){F===c-1&&(0<p?(k=b,w=b+e):(k=b,q=b+e));var x=g,m=q,u=k,A=r,E=O;m*=3;u*=3;A*=3;B.set(X,x[m++],x[m++],x[m++]);B.set(na,x[u++],
x[u++],x[u++]);B.set(oa,x[A++],x[A++],x[A++]);B.subtract(pa,na,X);B.subtract(qa,oa,X);B.cross(E,qa,pa);B.normalize(E,E);T(g,l,a,f,O,v,q);T(g,l,a,f,O,d,k);T(g,l,a,f,O,y,r);T(g,l,a,f,O,n,w);h[t++]=v;h[t++]=y;h[t++]=n;h[t++]=v;h[t++]=n;h[t++]=d;q++;k++;r++;w++;v+=2;d+=2;y+=2;n+=2}}function Fa(g,l,f,a){g=g.stageObject;const b=g.geometryRecords,c=b.length,e="absolute-height"!==l.mode;let n=0;const h=g.transformation,t=da.invert(N.create(),h);for(let q=0;q<c;q+=2){const k=b[q].geometry,r=k.getMutableAttribute("position").data,
w=k.vertexAttributes.get("size").data;var p=k.vertexAttributes.get("mapPos").data;p=new Ba.SamplePosition(p);const v=r.length/3;let d=0,y=!1,x=0;const m=f.spatialReference;for(let u=0;u<v;u++){M[0]=r[d];M[1]=r[d+1];M[2]=r[d+2];S.evaluateElevationInfoAtPoint(p,f,l,a,U);e&&(x+=U.sampledElevation);Aa.TESTS_DISABLE_OPTIMIZATIONS?(B.set(C,p.array[p.offset+0],p.array[p.offset+1],U.z+w[d/3]),a.toRenderCoords(C,m,C)):(B.set(C,r[d+0],r[d+1],r[d+2]),B.transformMat4(C,C,h),a.setAltitude(C,U.z+w[d/3]));B.transformMat4(C,
C,t);r[d]=C[0];r[d+1]=C[1];r[d+2]=C[2];const A=.01/a.unitInMeters;if(Math.abs(M[0]-r[d])>=A||Math.abs(M[1]-r[d+1])>=A||Math.abs(M[2]-r[d+2])>=A)y=!0;p.offset+=3;d+=3}y&&(k.invalidateBoundingInfo(),g.geometryVertexAttrsUpdated(b[q]),b[q+1].geometry.invalidateBoundingInfo(),g.geometryVertexAttrsUpdated(b[q+1]));n+=x/v}return n/c}const Ga=["polygon","extent"];W=function(g){function l(a,b,c,e){a=g.call(this,a,b,c,e)||this;a.ensureDrapedStatus(!1);return a}ca._inheritsLoose(l,g);var f=l.prototype;f.doLoad=
function(){var a=ca._asyncToGenerator(function*(){if(!this._drivenProperties.size){var b=ha.validateSymbolLayerSize(this._getSymbolSize());if(b)throw new ra("graphics3dextrudesymbollayer:invalid-size",b);}b=J.get(this.symbolLayer,"material","color");var c=this._getCombinedOpacityAndColor(b);b=D.fromArray(c);c=c[3];const e=1>c||this.needsDrivenTransparentPass;b={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:b,ambient:b,opacity:c,transparent:e,cullFace:e?0:2,vertexColors:!0,
slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new ja.DefaultMaterial(b);this._bottomMaterial=new ja.DefaultMaterial({...b,cullFace:2});this._context.stage.add(this._material);this._context.stage.add(this._bottomMaterial)});return function(){return a.apply(this,arguments)}}();f.destroy=function(){g.prototype.destroy.call(this);this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))};
f.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometry(b.geometry,Ga,this.symbolLayer.type))return null;const c=this._getVertexOpacityAndColor(a.renderingInfo,255),e=this.setGraphicElevationContext(b,new xa.ElevationContext);return this._createAs3DShape(b,a.renderingInfo,c,e,b.uid)};f.layerOpacityChanged=function(a,b){var c=J.get(this.symbolLayer,"material","color");c=this._getCombinedOpacity(c);const e=1>c||this.needsDrivenTransparentPass;this._material.setParameters({opacity:c,
transparent:e});this._bottomMaterial.setParameters({opacity:c,transparent:e});const n=this._getLayerOpacity();a.forEach(h=>{h=b(h);J.isSome(h)&&h.layerOpacityChanged(n,this._context.isAsync)});return!0};f.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,S.needsElevationUpdates3D)};f.slicePlaneEnabledChanged=function(a,b){this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled});this._bottomMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled});
a.forEach(c=>{c=b(c);J.isSome(c)&&c.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)});return!0};f.physicalBasedRenderingChanged=function(){this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});return!0};f.pixelRatioChanged=function(){return!0};f._getExtrusionSize=function(a){if(a.size&&this._drivenProperties.size){var b;
a=null!=(b=wa.getDriverAxisSizeValue(a.size,2))?b:0}else a=this._getSymbolSize();return a/=this._context.renderCoordsHelper.unitInMeters};f.applyRendererDiff=function(){return 1};f._getSymbolSize=function(){var a;return null!=(a=this.symbolLayer.size)?a:1};f._createAs3DShape=function(a,b,c,e,n){var h=ia.geometryAsPolygon(a.geometry);if(J.isNone(h))return null;a=ia.geometryToRenderInfo(h,this._context.elevationProvider,this._context.renderCoordsHelper,e);this._logGeometryCreationWarnings(a,h.rings,
"rings","ExtrudeSymbol3DLayer");if(0===h.rings.length||!h.rings.some(P=>0<P.length))return null;var t=ha.computeCentroid(h);if(J.isNone(t))return null;var p=[];const q=[],k=[],r=R.create(),w=N.create(),v=D.create(),d=1===this._context.renderCoordsHelper.viewingMode;d||this._context.renderCoordsHelper.worldUpAtPosition(null,v);va.computeTranslationToOriginAndRotation(h.spatialReference,[t.x,t.y,0],w,this._context.renderCoordsHelper.spatialReference);h=N.create();da.invert(h,w);t=ua.create();ta.normalFromMat4(t,
h);const {polygons:y,mapPosition:x,position:m}=a;var u=m.length/3;const A=new Float64Array(18*u),E=new Float64Array(18*u),F=new Float64Array(18*u);u=new Float64Array(6*u);let K=0;for(let P=0;P<y.length;++P){var L=y[P];const Y=L.count;if(this._context.clippingExtent&&(R.empty(r),R.expandWithBuffer(r,L.mapPosition),!R.intersectsClippingArea(r,this._context.clippingExtent)))continue;const V=sa.earcut(L.mapPosition,L.holeIndices,3);if(0===V.length)continue;const Z=new Uint32Array(6*Y+V.length);var Q=
new Uint32Array(V.length),I=6*Y,G=3*A.BYTES_PER_ELEMENT;G=new ea.BufferViewVec3f64(A.buffer,K*G,G,(K+I)*G);var H=3*E.BYTES_PER_ELEMENT;H=new ea.BufferViewVec3f64(E.buffer,K*H,H,(K+I)*H);const aa=new Float64Array(F.buffer,3*K*F.BYTES_PER_ELEMENT,3*I);I=new Float64Array(u.buffer,1*K*u.BYTES_PER_ELEMENT,1*I);const Ha=this._getExtrusionSize(b);Ea(m,x,V,L,G.typedBuffer,aa,H.typedBuffer,I,0,Z,Q,Ha,v,d);fa.transformMat4(G,G,h);fa.transformMat3(H,H,t);K+=6*Y;L=this._createExtrudeGeometry(Z,Z.length-Q.length,
{positions:G.typedBuffer,elevation:aa,normals:H.typedBuffer,heights:I},c);p.push(L);q.push(this._material);k.push(N.IDENTITY);Q=this._createExtrudeGeometry(Q,0,{positions:G.typedBuffer,elevation:aa,normals:H.typedBuffer,heights:I},c);p.push(Q);q.push(this._bottomMaterial);k.push(N.IDENTITY)}if(0===p.length)return null;b=new Da.Object3D({geometries:p,materials:q,transformations:k,metadata:{layerUid:this._context.layer.uid,graphicUid:n,isElevationSource:!0}});b.transformation=w;c=za.createMaterial(this.symbolLayer,
{opacity:this._getLayerOpacity()});c=J.isSome(c)?{baseMaterial:this._material,edgeMaterials:[c],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null;p=new ya.Graphics3DObject3DGraphicLayer(this,b,p,null,null,Fa,e,c);p.alignedSampledElevation=a.sampledElevation;p.needsElevationUpdates=S.needsElevationUpdates3D(e.mode);return p};f._createExtrudeGeometry=function(a,b,c,e){var n=new Uint32Array(a.length);e=[["position",{size:3,data:c.positions,exclusive:!0}],["normal",
{size:3,data:c.normals,exclusive:!0}],["color",{size:4,data:e,exclusive:!0}],["size",{size:1,data:c.heights,exclusive:!0}]];n=[["position",a],["normal",a],["color",n]];c.elevation&&(e.push(["mapPos",{size:3,data:c.elevation}]),n.push(["mapPos",a]));return new Ca.Geometry(e,n,0,b)};return l}(W.Graphics3DSymbolLayer);const O=D.create(),X=D.create(),na=D.create(),oa=D.create(),pa=D.create(),qa=D.create(),M=D.create(),C=D.create(),z=D.create(),U=new S.SampleElevationInfo,la=[0,2,1],ka=[0,1,2];ba.Graphics3DExtrudeSymbolLayer=
W;Object.defineProperty(ba,"__esModule",{value:!0})});