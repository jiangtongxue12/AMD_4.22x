// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/maybe ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ./elevationAlignmentUtils ./graphicUtils ../../support/debugFlags ../../support/ElevationProvider".split(" "),function(v,I,J,C,D,w,y,t,K,x,L){const M=C.create(),f=w.create(),l=w.create(),q=w.create(),m=C.create(),E=w.create(),g=new t.SampleElevationInfo;v.perLodInstanceElevationAligner=function(e,b,h,d){var k=e.graphics3DSymbolLayer.lodRenderer;
if(I.isNone(k))return 0;const n=b.centerPointInElevationSR;t.evaluateElevationInfoAtPoint(n,h,b,d,g);b="absolute-height"!==b.mode?g.sampledElevation:0;k=k.instanceData;e=e.instanceIndex;k.getGlobalTransform(e,m);h=D.set(E,m[12],m[13],m[14]);x.TESTS_DISABLE_OPTIMIZATIONS?(f[0]=n.x,f[1]=n.y,f[2]=g.z,y.computeTranslationToOriginAndRotation(n.spatialReference,f,m,d.spatialReference)&&k.setGlobalTransform(e,m)):d.setAltitudeOfTransformation(g.z,m);d=.01/d.unitInMeters;(x.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(m[12]-
h[0])>=d||Math.abs(m[13]-h[1])>=d||Math.abs(m[14]-h[2])>=d)&&k.setGlobalTransform(e,m);return b};v.perObjectElevationAligner=function(e,b,h,d){e=e.stageObject;const k=b.centerPointInElevationSR;let n=0;e.metadata.usesVerticalDistanceToGround?(t.evaluateElevationInfoAtPoint(k,h,b,d,g),K.updateVertexAttributeAuxpos1w(e,g.verticalDistanceToGround),n=g.sampledElevation):(t.evaluateElevationInfoAtPoint(k,h,b,d,g),"absolute-height"!==b.mode&&(n=g.sampledElevation));b=J.copy(M,e.transformation);h=D.set(E,
b[12],b[13],b[14]);x.TESTS_DISABLE_OPTIMIZATIONS?(f[0]=k.x,f[1]=k.y,f[2]=g.z,y.computeTranslationToOriginAndRotation(k.spatialReference,f,b,d.spatialReference)&&(e.transformation=b)):d.setAltitudeOfTransformation(g.z,b);d=.01/d.unitInMeters;if(Math.abs(b[12]-h[0])>=d||Math.abs(b[13]-h[1])>=d||Math.abs(b[14]-h[2])>=d)e.transformation=b;return n};v.perVertexElevationAligner=function(e,b,h,d){e=e.stageObject;const k=h.spatialReference,n=e.geometryRecords,N="absolute-height"!==b.mode;let F=0;for(const z of n){var r=
z.geometry,a=z.getShaderTransformation();l[0]=a[12];l[1]=a[13];l[2]=a[14];r.invalidateBoundingInfo();var u=r.getMutableAttribute("position");a=u.data;var p=r.vertexAttributes.get("mapPos").data;r=u.size;u=a.length/r;p=new L.SamplePosition(p,k);let c=0,A=!1,G=0;for(let H=0;H<u;H++){q[0]=a[c];q[1]=a[c+1];q[2]=a[c+2];t.evaluateElevationInfoAtPoint(p,h,b,d,g);N&&(G+=g.sampledElevation);if(x.TESTS_DISABLE_OPTIMIZATIONS)a[c]=p.array[p.offset],a[c+1]=p.array[p.offset+1],a[c+2]=g.z,y.projectBuffer(a,k,c,
a,d.spatialReference,c,1),a[c]-=l[0],a[c+1]-=l[1],a[c+2]-=l[2],A=!0;else{f[0]=a[c]+l[0];f[1]=a[c+1]+l[1];f[2]=a[c+2]+l[2];d.setAltitude(f,g.z);a[c]=f[0]-l[0];a[c+1]=f[1]-l[1];a[c+2]=f[2]-l[2];const B=.01/d.unitInMeters;if(Math.abs(q[0]-a[c])>=B||Math.abs(q[1]-a[c+1])>=B||Math.abs(q[2]-a[c+2])>=B)A=!0}c+=r;p.offset+=3}F+=G/u;A&&e.geometryVertexAttrsUpdated(z)}return F/n.length};Object.defineProperty(v,"__esModule",{value:!0})});