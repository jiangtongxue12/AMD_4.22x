// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Handles ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/watchUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../layers/support/FeatureFilter ./QueryEngine ../../../support/floorFilterUtils ../../../support/Scheduler".split(" "),
function(d,m,g,q,r,t,e,u,v,h,C,D,E,w,x,y,z,n){const A=t.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");d.Graphics3DFilterVisibility=function(p){function k(...a){a=p.call(this,...a)||this;a._dirty=!1;a._querying=!1;a._handles=new r;return a}m._inheritsLoose(k,p);var f=k.prototype;f.setup=function(a,c){this._layerView=a;this._core=c;this._objectIdField=a.layer.objectIdField;this._queryEngine=new y.default({layerView:this._layerView,priority:n.TaskPriority.FILTER_VISIBILITY});
this._handles.add(this._layerView.view.resourceController.scheduler.registerTask(n.TaskPriority.FILTER_VISIBILITY,this));this._handles.add(v.on(c.owner,"loadedGraphics","after-changes",b=>this._graphicsChanged(b),()=>this.dirty=!0));this.filterChanged()};f.destroy=function(){this._handles.destroy();this._handles=null;this.clear();this._core=this._layerView=null};f.clear=function(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities(a=>a.clearVisibilityFlag(2)),this._queryResult=
null,this._querying=!1);this.dirty=!1};f._graphicsChanged=function(a){this._queryEngine&&0===(a.type&1)||(this.dirty=!0)};f.updateVisibility=function(a){this.active&&(a.hasVisibilityFlag(2,0)||a.setVisibilityFlag(2,!1,0),this.dirty=!0)};f.filterChanged=function(){const a=this.recomputeFilter();a!==this._filter&&(this._filter=a,this.dirty=!0)};f.recomputeFilter=function(){var a="filter"in this._layerView?this._layerView.filter:null;const c="timeExtent"in this._layerView?this._layerView.timeExtent:
null,b=z.getFloorFilterClause(this._layerView);if(e.isNone(c)&&e.isNone(b))return a;a=e.isSome(a)?a.clone():new x;e.isSome(c)&&(a.timeExtent=e.isSome(a.timeExtent)?a.timeExtent.intersection(c):c);e.isSome(b)&&(a.where=null==a.where||""===a.where?b:`(${a.where}) AND (${b})`);return a};f.runTask=function(a){if(this.active){!this._dirty||this._querying||a.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this._filter).then(b=>{this._queryResult=b;this._querying=!1}).catch(b=>
{if(!u.isAbortError(b)){A.warn("FeatureFilter query failed: "+b,{error:b});const l=new Set;this._core.graphics3DGraphics.forEach(B=>l.add(this._getFeatureId(B.graphic)));this._queryResult=l;this._querying=!1}}),a.madeProgress());var c=this._queryResult;e.isSome(c)&&!a.done&&(this._core.modifyGraphics3DGraphicVisibilities(b=>{if(a.done)return!1;const l=c.has(this._getFeatureId(b.graphic));return b.setVisibilityFlag(2,l,0)?(a.madeProgress(),!0):!1}),a.done||(this._queryResult=null))}else this.clear()};
f._getFeatureId=function(a){return null==a.objectId?a.attributes[this._objectIdField]:a.objectId};m._createClass(k,[{key:"updating",get:function(){return this._dirty||this._querying||e.isSome(this._queryResult)}},{key:"active",get:function(){return this._filter&&0<this._core.graphics3DGraphics.size}},{key:"running",get:function(){return this._dirty&&!this._querying||e.isSome(this._queryResult)}},{key:"dirty",set:function(a){this._dirty=a}}]);return k}(q);g.__decorate([h.property({readOnly:!0})],d.Graphics3DFilterVisibility.prototype,
"updating",null);g.__decorate([h.property({readOnly:!0})],d.Graphics3DFilterVisibility.prototype,"running",null);g.__decorate([h.property()],d.Graphics3DFilterVisibility.prototype,"_dirty",void 0);g.__decorate([h.property()],d.Graphics3DFilterVisibility.prototype,"_querying",void 0);g.__decorate([h.property()],d.Graphics3DFilterVisibility.prototype,"_queryResult",void 0);d.Graphics3DFilterVisibility=g.__decorate([w.subclass("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],d.Graphics3DFilterVisibility);
Object.defineProperty(d,"__esModule",{value:!0})});