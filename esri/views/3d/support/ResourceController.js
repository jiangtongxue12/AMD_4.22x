// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Handles ../../../core/maybe ../../../core/scheduling ../../../core/time ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ./index ./MemoryController ./StreamDataLoader ../../support/Scheduler".split(" "),function(f,n,d,v,w,k,x,y,g,D,E,F,t,u,z,A,p){f.ResourceControllerMain=
function(h){function b(){var l=h.apply(this,arguments)||this;l.updating=!1;return l}n._inheritsLoose(b,h);return b}(v);d.__decorate([g.property({readOnly:!0})],f.ResourceControllerMain.prototype,"updating",void 0);f.ResourceControllerMain=d.__decorate([t.subclass("esri.views.3d.support.ResourceController")],f.ResourceControllerMain);var q;(function(h){let b=function(l){function m(){var a=l.apply(this,arguments)||this;a._scheduler=null;a._memoryController=null;a._streamDataLoader=null;a._cameraChangeTime=
0;a._handles=new w;a._frameTask=null;a._scheduleTask=p.ImmediateTask;a._state=2;return a}n._inheritsLoose(m,l);var e=m.prototype;e.initialize=function(){this._cameraChangeTime=this.now();this._scheduler=p.newScheduler(this.now);this._memoryController=z.newMemoryController(this.view);this._streamDataLoader=new A.default;this._streamDataLoader.setup(u.maxDownloadSlots,u.downloadSlotsPerClient,this._scheduler);this._handles.add([this.view.watch("state.camera",(a,c)=>this._cameraChangedHandler(a,c),!0),
this.view.watch("stationary",()=>this._stationaryChangedHandler()),this._memoryController.events.on("updating-changed",()=>this.notifyChange("updating"))]);this._frameTask=x.addFrameTask({update:a=>this.frame(a)});this._scheduleTask=this._scheduler.registerTask(p.TaskPriority.RESOURCE_CONTROLLER)};e.destroy=function(){this._handles=k.destroyMaybe(this._handles);this._scheduleTask.remove();this._frameTask=k.removeMaybe(this._frameTask);this._streamDataLoader=k.destroyMaybe(this._streamDataLoader);
this._memoryController=k.destroyMaybe(this._memoryController);this._scheduler=k.destroyMaybe(this._scheduler)};e.schedule=function(a,c,r){return this._scheduleTask.schedule(a,c,r)};e.createStreamDataRequester=function(a){const c=this._streamDataLoader;return{request(r,B,C){return c.request(r,B,a,C)},get busy(){return!c.hasDownloadSlots(a)}}};e.frame=function(a){if(!this.view.suspended){if(this.view.stateManager&&(this.view.stateManager.step(y.SecondsFromMilliseconds(a.deltaTime)),!this._scheduler))return;
this._updateState();this._scheduler.state=this._state;this._scheduler.updateBudget(a)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update()}};e._cameraChangedHandler=function(a,c){a&&c&&a.almostEquals(c)||(this._cameraChangeTime=this._scheduler.now,this._updateState(),this._scheduler.state=this._state)};e._stationaryChangedHandler=function(){this.memoryController.resetStableQuality()};e._updateState=function(){this.view.animation?
this._state=0:this.view.interacting?this._state=1:(0===this._state&&(this._cameraChangeTime=0),this._state=300>=this._scheduler.now-this._cameraChangeTime?1:2)};n._createClass(m,[{key:"updating",get:function(){var a,c;return!!(null!=(a=this._memoryController)&&a.updating||null!=(c=this._streamDataLoader)&&c.updating)}},{key:"scheduler",get:function(){return this._scheduler}},{key:"memoryController",get:function(){return this._memoryController}},{key:"test",get:function(){return{getQueueStats:a=>this._streamDataLoader.test.loadQueue.getStatsForType(a),
state:this._state}}}]);return m}(f.ResourceControllerMain);d.__decorate([g.property({constructOnly:!0})],b.prototype,"view",void 0);d.__decorate([g.property({constructOnly:!0})],b.prototype,"now",void 0);d.__decorate([g.property()],b.prototype,"_scheduler",void 0);d.__decorate([g.property()],b.prototype,"_memoryController",void 0);d.__decorate([g.property()],b.prototype,"_streamDataLoader",void 0);d.__decorate([g.property({readOnly:!0})],b.prototype,"updating",null);b=d.__decorate([t.subclass("esri.views.3d.support.ResourceController")],
b);h.ResourceController=b})(q||(q={}));f.newResourceController=function(h,b=()=>performance.now()){return new q.ResourceController({view:h,now:b})};Object.defineProperty(f,"__esModule",{value:!0})});