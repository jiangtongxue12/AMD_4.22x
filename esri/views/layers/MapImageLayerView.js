// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Error ../../core/maybe ../../core/promiseUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../layers/support/commonProperties ../../layers/support/ExportImageParameters ../../renderers/support/clickToleranceUtils ../../support/arcadeOnDemand ./support/popupUtils ../support/floorFilterUtils".split(" "),
function(v,l,h,F,w,G,m,x,O,P,H,I,J,K,L,z,M){x=c=>{c=function(y){function r(){return y.apply(this,arguments)||this}l._inheritsLoose(r,y);var n=r.prototype;n.initialize=function(){this.exportImageParameters=new J.ExportImageParameters({layer:this.layer})};n.destroy=function(){this.exportImageParameters.destroy();this.exportImageParameters=null};n.fetchPopupFeatures=function(){var b=l._asyncToGenerator(function*(p,t){var q=this,{layer:k}=this;if(!p)return Promise.reject(new F("mapimagelayerview:fetchPopupFeatures",
"Nothing to fetch without area",{layer:k}));const A=this.get("view.scale"),B=[],C=function(){var g=l._asyncToGenerator(function*(a){var f=0===a.minScale||A<=a.minScale;const d=0===a.maxScale||A>=a.maxScale;a.visible&&f&&d&&(a.sublayers?a.sublayers.forEach(C):a.popupEnabled&&(f=z.getFetchPopupTemplate(a,{...t,defaultPopupTemplateEnabled:!1}),w.isSome(f)&&B.unshift({sublayer:a,popupTemplate:f})))});return function(a){return g.apply(this,arguments)}}();k=k.sublayers.toArray().reverse().map(C);yield Promise.all(k);
k=B.map(function(){var g=l._asyncToGenerator(function*({sublayer:a,popupTemplate:f}){yield a.load().catch(()=>{});const d=a.createQuery();var u=w.isSome(t)?t.event:null;u=K.calculateTolerance({renderer:a.renderer,event:u});const D=q.createFetchPopupFeaturesQueryGeometry(p,u);d.geometry=D;d.outFields=yield z.getRequiredFields(a,f);if("map-image"===q.layer.type&&"floors"in q.view){var e,E;const N=null==(e=q.view)?void 0:null==(E=e.floors)?void 0:E.clone();e=M.getLayerFloorFilterClause(N,a);w.isSome(e)&&
(d.where=d.where?`(${d.where}) AND (${e})`:e)}e=yield q._loadArcadeModules(f);e&&e.arcadeUtils.hasGeometryOperations(f)||(d.maxAllowableOffset=D.width/u);return(yield a.queryFeatures(d)).features});return function(a){return g.apply(this,arguments)}}());return(yield G.eachAlways(k)).reduce((g,a)=>a.value?[...g,...a.value]:g,[]).filter(g=>null!=g)});return function(p,t){return b.apply(this,arguments)}}();n.canResume=function(){var b;return!y.prototype.canResume.call(this)||null!=(b=this.timeExtent)&&
b.isEmpty?!1:!0};n._loadArcadeModules=function(b){if(b.get("expressionInfos.length")||Array.isArray(b.content)&&b.content.some(p=>"expression"===p.type))return L.loadArcade()};l._createClass(r,[{key:"exportImageVersion",get:function(){var b;null==(b=this.exportImageParameters)?void 0:b.commitProperty("version");this.commitProperty("timeExtent");return(this._get("exportImageVersion")||0)+1}}]);return r}(c);h.__decorate([m.property()],c.prototype,"exportImageParameters",void 0);h.__decorate([m.property({readOnly:!0})],
c.prototype,"exportImageVersion",null);h.__decorate([m.property()],c.prototype,"layer",void 0);h.__decorate([m.property()],c.prototype,"suspended",void 0);h.__decorate([m.property(I.combinedViewLayerTimeExtentProperty)],c.prototype,"timeExtent",void 0);return c=h.__decorate([H.subclass("esri.views.layers.MapImageLayerView")],c)};v.MapImageLayerView=x;v.default=x;Object.defineProperty(v,"__esModule",{value:!0})});