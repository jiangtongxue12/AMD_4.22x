// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("exports ../../core/Error ../../core/maybe ../../geometry/Extent ../../geometry/Point ../../geometry/projectionEllipsoid ../../geometry/support/WKIDUnitConversion ../ogc/xmlUtils ./TileInfo".split(" "),function(y,O,P,G,H,Q,B,I,R){function p(b,a){for(let d=0;d<a.childNodes.length;d++){const c=a.childNodes[d];if(c.nodeType===Node.ELEMENT_NODE&&c.nodeName===b)return c}return null}function v(b,a){const d=[];for(let c=0;c<a.childNodes.length;c++){const e=a.childNodes[c];e.nodeType===Node.ELEMENT_NODE&&
e.nodeName===b&&d.push(e)}return d}function w(b,a){const d=[];for(let c=0;c<a.childNodes.length;c++){const e=a.childNodes[c];e.nodeType===Node.ELEMENT_NODE&&e.nodeName===b&&d.push(e)}return d.map(c=>c.textContent)}function n(b,a){b.split("\x3e").forEach(d=>{a&&(a=p(d,a))});return a&&a.textContent}function z(b,a,d,c){let e;Array.prototype.slice.call(c.childNodes).some(f=>{if(-1<f.nodeName.indexOf(b)){var h=p(a,f);h=h&&h.textContent;if(h===d||d.split(":")&&d.split(":")[1]===h)return e=f,!0}return!1});
return e}function J(b,a){var d;const c=[];var e=null==(d=b.layerMap)?void 0:d.get(a);if(e){d=v("ResourceURL",e);e=v("Dimension",e);if(e.length){var f=n("Identifier",e[0]);var h=w("Default",e[0])||w("Value",e[0])}if(1<e.length){var g=n("Identifier",e[1]);var q=w("Default",e[1])||w("Value",e[1])}b.dimensionMap.set(a,{dimensions:h,dimensions2:q});d.forEach(m=>{let k=m.getAttribute("template");if("tile"===m.getAttribute("resourceType")){if(f&&h.length)if(-1<k.indexOf("{"+f+"}"))k=k.replace("{"+f+"}",
"{dimensionValue}");else{var l=k.toLowerCase().indexOf("{"+f.toLowerCase()+"}");-1<l&&(k=k.substring(0,l)+"{dimensionValue}"+k.substring(l+f.length+2))}g&&q.length&&(-1<k.indexOf("{"+g+"}")?k=k.replace("{"+g+"}","{dimensionValue2}"):(l=k.toLowerCase().indexOf("{"+g.toLowerCase()+"}"),-1<l&&(k=k.substring(0,l)+"{dimensionValue2}"+k.substring(l+g.length+2))));c.push({template:k,format:m.getAttribute("format"),resourceType:"tile"})}});return c}}function K(b,a,d){b=J(b,a);a=b.filter(c=>c.format===d);
return a.length?a:b}function S(b){const a=[];I.visitXML(b,{BoundingBox:d=>{const c=d.getAttribute("crs").toLowerCase(),e=C(c),f=c.includes("epsg")&&D(e.wkid);let h,g,q,m;I.visitXML(d,{LowerCorner:k=>{[h,g]=k.textContent.split(" ").map(l=>Number.parseFloat(l));f&&([h,g]=[g,h])},UpperCorner:k=>{[q,m]=k.textContent.split(" ").map(l=>Number.parseFloat(l));f&&([q,m]=[m,q])}});a.push({xmin:h,ymin:g,xmax:q,ymax:m,spatialReference:e})}});return a}function T(b,a){return v("Style",b).map(d=>{var c=p("LegendURL",
d),e=p("Keywords",d);e=e&&w("Keyword",e);c=c&&c.getAttribute("xlink:href");a&&(c=c&&c.replace(/^http:/i,"https:"));return{abstract:n("Abstract",d),id:n("Identifier",d),isDefault:"true"===d.getAttribute("isDefault"),keywords:e,legendUrl:c,title:n("Title",d)}})}function U(b,a,d){return v("TileMatrixSetLink",a).map(c=>V(b,c,d))}function V(b,a,d){const c=p("TileMatrixSet",a).textContent;var e=w("TileMatrix",a);const f=d.find(k=>{k=(k=p("Identifier",k))&&k.textContent;return k===c||c.split(":")&&c.split(":")[1]===
k?!0:!1});a=(a=p("TileMatrixSetLimits",a))&&v("TileMatrixLimits",a);const h=new Map;if(null!=a&&a.length)for(var g of a){a=p("TileMatrix",g).textContent;d=+p("MinTileRow",g).textContent;const k=+p("MaxTileRow",g).textContent,l=+p("MinTileCol",g).textContent,x=+p("MaxTileCol",g).textContent;h.set(a,{minCol:l,maxCol:x,minRow:d,maxRow:k})}const q=n("SupportedCRS",f).toLowerCase();g=W(f,q);a=g.spatialReference;d=p("TileMatrix",f);d=[parseInt(n("TileWidth",d),10),parseInt(n("TileHeight",d),10)];const m=
[];e.length?e.forEach((k,l)=>{k=z("TileMatrix","Identifier",k,f);m.push(L(k,q,l,c,h))}):v("TileMatrix",f).forEach((k,l)=>{m.push(L(k,q,l,c,h))});b=X(b,f,g,d,m[0]).toJSON();e=(new R({dpi:96,spatialReference:a,size:d,origin:g,lods:m})).toJSON();return{id:c,fullExtent:b,tileInfo:e}}function C(b){b=b.toLowerCase();let a=parseInt(b.split(":").pop(),10);if(900913===a||3857===a)a=102100;b=b.includes("crs84")||b.includes("crs:84")?4326:b.includes("crs83")||b.includes("crs:83")?4269:b.includes("crs27")||b.includes("crs:27")?
4267:null;P.isSome(b)&&(a=b);return{wkid:a}}function W(b,a){b=p("TileMatrix",b);return M(b,a)}function M(b,a){const d=C(a),[c,e]=n("TopLeftCorner",b).split(" ").map(f=>parseFloat(f));return a.includes("epsg")&&D(d.wkid)?new H({x:e,y:c,spatialReference:d}):new H({x:c,y:e,spatialReference:d})}function X(b,a,d,c,e){var f=p("BoundingBox",a);if(f){var h=n("LowerCorner",f).split(" ");var g=n("UpperCorner",f).split(" ")}h&&1<h.length&&g&&1<g.length?(a=parseFloat(h[0]),c=parseFloat(h[1]),h=parseFloat(g[0]),
g=parseFloat(g[1])):(a=p("TileMatrix",a),h=parseInt(n("MatrixWidth",a),10),f=parseInt(n("MatrixHeight",a),10),a=d.x,g=d.y,h=a+h*c[0]*e.resolution,c=g-f*c[1]*e.resolution);return"1.0.0"===b&&D(d.spatialReference.wkid)?new G(c,a,g,h,d.spatialReference):new G(a,c,h,g,d.spatialReference)}function D(b){return Y.some(([a,d])=>b>=a&&b<=d)}function L(b,a,d,c,e){var f,h=C(a);const g=n("Identifier",b);let q=parseFloat(n("ScaleDenominator",b));c=N(h.wkid,q,c);q*=1.058267716535433;h=+n("MatrixWidth",b);const m=
+n("MatrixHeight",b),{maxCol:k=h-1,maxRow:l=m-1,minCol:x=0,minRow:E=0}=null!=(f=e.get(g))?f:{},{x:F,y:r}=M(b,a);return{cols:[x,k],level:d,levelValue:g,origin:[F,r],scale:q,resolution:c,rows:[E,l]}}function N(b,a,d){b=B.hasOwnProperty(""+b)?B.values[B[b]]:"default028mm"===d?6370997*Math.PI/180:Q.getReferenceEllipsoidFromWKID(b).metersPerDegree;return 7*a/25E3/b}const Y=[[3819,3819],[3821,3824],[3889,3889],[3906,3906],[4001,4025],[4027,4036],[4039,4047],[4052,4055],[4074,4075],[4080,4081],[4120,4176],
[4178,4185],[4188,4216],[4218,4289],[4291,4304],[4306,4319],[4322,4326],[4463,4463],[4470,4470],[4475,4475],[4483,4483],[4490,4490],[4555,4558],[4600,4646],[4657,4765],[4801,4811],[4813,4821],[4823,4824],[4901,4904],[5013,5013],[5132,5132],[5228,5229],[5233,5233],[5246,5246],[5252,5252],[5264,5264],[5324,5340],[5354,5354],[5360,5360],[5365,5365],[5370,5373],[5381,5381],[5393,5393],[5451,5451],[5464,5464],[5467,5467],[5489,5489],[5524,5524],[5527,5527],[5546,5546],[2044,2045],[2081,2083],[2085,2086],
[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3038,3051],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3150,3151],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3389,3390],[3416,3417],[3833,3841],[3844,3850],[3854,3854],[3873,3885],[3907,3910],[4026,4026],[4037,4038],[4417,4417],[4434,4434],[4491,4554],[4839,4839],[5048,5048],
[5105,5130],[5253,5259],[5269,5275],[5343,5349],[5479,5482],[5518,5519],[5520,5520],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]];y.getTileUrlFromResourceUrls=function(b,a,d,c,e,f,h,g){var q,m;c=K(b,a,c);if(!(0<(null==c?void 0:c.length)))return"";const {dimensionMap:k}=
b;b=null==(q=k.get(a).dimensions)?void 0:q[0];a=null==(m=k.get(a).dimensions2)?void 0:m[0];return c[h%c.length].template.replace(/\{Style\}/gi,e).replace(/\{TileMatrixSet\}/gi,d).replace(/\{TileMatrix\}/gi,f).replace(/\{TileRow\}/gi,""+h).replace(/\{TileCol\}/gi,""+g).replace(/\{dimensionValue\}/gi,b).replace(/\{dimensionValue2\}/gi,a)};y.getTileUrlTemplateFromResourceUrls=function(b,a,d,c){const {dimensionMap:e}=b;b=J(b,a);let f="";if(b&&0<b.length){const h=e.get(a).dimensions&&e.get(a).dimensions[0];
a=e.get(a).dimensions2&&e.get(a).dimensions2[0];f=b[0].template;f.indexOf(".xxx")===f.length-4&&(f=f.slice(0,f.length-4));f=f.replace(/\{Style\}/gi,c);f=f.replace(/\{TileMatrixSet\}/gi,d);f=f.replace(/\{TileMatrix\}/gi,"{level}");f=f.replace(/\{TileRow\}/gi,"{row}");f=f.replace(/\{TileCol\}/gi,"{col}");f=f.replace(/\{dimensionValue\}/gi,h);f=f.replace(/\{dimensionValue2\}/gi,a)}return f};y.getTileUrlTemplates=K;y.parseCapabilities=function(b,a){var d,c;b=b.replace(/ows:/gi,"");var e=(new DOMParser).parseFromString(b,
"text/xml").documentElement;const f=new Map;b=new Map;var h=p("Contents",e);if(!h)throw new O("wmtslayer:wmts-capabilities-xml-is-not-valid");var g=p("OperationsMetadata",e);g=null==g?void 0:g.querySelector("[name\x3d'GetTile']");g=(g=null==g?void 0:g.getElementsByTagName("Get"))&&Array.prototype.slice.call(g);const q=null!=(d=-1<(null==a?void 0:null==(c=a.url)?void 0:c.indexOf("https")))?d:!1;let m=a.serviceMode,k,l=a&&a.url,x;g&&g.length&&g.some(r=>{const t=p("Constraint",r);if(!t||z("AllowedValues",
"Value",m,t))return l=r.attributes[0].nodeValue,!0;if(!t||z("AllowedValues","Value","RESTful",t)||z("AllowedValues","Value","REST",t))x=r.attributes[0].nodeValue;else if(!t||z("AllowedValues","Value","KVP",t))k=r.attributes[0].nodeValue;return!1});l||(x?(l=x,m="RESTful"):k?(l=k,m="KVP"):l=(a=p("ServiceMetadataURL",e))&&a.getAttribute("xlink:href"));a=l.indexOf("1.0.0/");-1===a&&"RESTful"===m?l+="/":-1<a&&(l=l.substring(0,a));"KVP"===m&&(l+=-1<a?"":"?");q&&(l=l.replace(/^http:/i,"https:"));const E=
n("ServiceIdentification\x3eServiceTypeVersion",e);e=n("ServiceIdentification\x3eAccessConstraints",e);a=v("Layer",h);const F=v("TileMatrixSet",h);h=a.map(r=>{var t=n("Identifier",r);f.set(t,r);{const Z=n("Abstract",r),aa=w("Format",r);var u=p("WGS84BoundingBox",r);var A=u?n("LowerCorner",u).split(" "):["-180","-90"];u=u?n("UpperCorner",u).split(" "):["180","90"];A={xmin:parseFloat(A[0]),ymin:parseFloat(A[1]),xmax:parseFloat(u[0]),ymax:parseFloat(u[1]),spatialReference:{wkid:4326}};u=S(r);const ba=
T(r,q),ca=n("Title",r);r=U(E,r,F);t={id:t,fullExtent:A,fullExtents:u,description:Z,formats:aa,styles:ba,title:ca,tileMatrixSets:r}}return t});return{copyright:e,dimensionMap:b,layerMap:f,layers:h,serviceMode:m,tileUrl:l}};y.parseResourceInfo=function(b){b.layers.forEach(a=>{a.tileMatrixSets.forEach(d=>{const c=d.tileInfo;96!==c.dpi&&(c.lods.forEach(e=>{e.scale=96*e.scale/c.dpi;e.resolution=N(c.spatialReference.wkid,90.71428571428571*e.scale/96,d.id)}),c.dpi=96)})});return b};Object.defineProperty(y,
"__esModule",{value:!0})});