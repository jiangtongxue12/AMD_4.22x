// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ../featureConversionUtils ./AttributesBuilder ./attributeSupport ./projectionSupport ./timeSupport ./utils ../../support/fieldUtils ../../../statistics/utils ../../../support/arcadeOnDemand".split(" "),function(D,G,P,I,S,J,T,N,U,E,Q,A,V){function W(y,l,b,a,c,e){c-=b;e-=a;y=Math.min(1,Math.max(0,((y-b)*c+(l-a)*e)/(c*c+e*e)));return{x:b+c*
y,y:a+e*y}}function X(y,l){return y?l?4:3:l?3:2}return function(){function y(b,a,c){this.items=b;this.queryGeometry=a;this.definitionExpression=c.definitionExpression;this.geometryType=c.geometryType;this.hasM=c.hasM;this.hasZ=c.hasZ;this.objectIdField=c.objectIdField;this.spatialReference=c.spatialReference;this.fieldsIndex=c.fieldsIndex;this.timeInfo=c.timeInfo;this.featureAdapter=c.featureAdapter;this.aggregateAdapter=c.aggregateAdapter}var l=y.prototype;l.createQueryResponseForCount=function(b){const a=
new J(b,this.featureAdapter,this.fieldsIndex);if(!b.outStatistics)return a.countDistinctValues(this.items);const {groupByFieldsForStatistics:c,having:e}=b;if(null==c||!c.length)return 1;const d=new Map,f=new Map,k=new Set;b=b.outStatistics;for(const h of b){({statisticType:b}=h);b="exceedslimit"!==b?h.onStatisticField:void 0;if(!f.has(b)){var g=[];for(const m of c){const n=this._getAttributeValues(a,m,d);g.push(n)}f.set(b,this._calculateUniqueValues(g,a.returnDistinctValues))}b=f.get(b);for(const m in b){const {data:n,
items:p}=b[m];g=n.join(",");e&&!a.validateItems(p,e)||k.add(g)}}return k.size};l.createQueryResponse=function(b){let a;a=b.outStatistics?b.outStatistics.some(c=>"exceedslimit"===c.statisticType)?this._createExceedsLimitQueryResponse(b):this._createStatisticsQueryResponse(b):this._createFeatureQueryResponse(b);b.returnQueryGeometry&&(I.isValid(b.outSR)&&!I.equals(this.queryGeometry.spatialReference,b.outSR)?a.queryGeometry=E.cleanFromGeometryEngine({spatialReference:b.outSR,...N.project(this.queryGeometry,
this.queryGeometry.spatialReference,b.outSR)}):a.queryGeometry=E.cleanFromGeometryEngine({spatialReference:b.outSR,...this.queryGeometry}));return a};l.createSnappingResponse=function(b,a){const c=this.featureAdapter,e=X(this.hasZ,this.hasM),{x:d,y:f}=b.point,k="number"===typeof b.distance?b.distance:b.distance.x,g="number"===typeof b.distance?b.distance:b.distance.y,h={candidates:[]},m="esriGeometryPolygon"===this.geometryType;a=this.getPointCreator(b.point,this.spatialReference,a);for(const w of this.items){var n=
c.getGeometry(w);if(G.isNone(n))continue;const {coords:r,lengths:x}=n;if(b.types&1){n=0;for(var p=0;p<x.length;p++){var q=x[p];for(var u=0;u<q;u++,n+=e){var z=r[n],v=r[n+1];if(u!==q-1){const B=r[n+e],C=r[n+e+1],{x:H,y:K}=W(d,f,z,v,B,C);var t=(d-H)/k;const F=(f-K)/g;t=t*t+F*F;1>=t&&h.candidates.push({type:"edge",objectId:c.getObjectId(w),distance:Math.sqrt(t),target:a(H,K),start:a(z,v),end:a(B,C)})}}}}if(b.types&2)for(n=m?r.length-e:r.length,p=0;p<n;p+=e)q=r[p],u=r[p+1],z=(d-q)/k,v=(f-u)/g,z=z*z+v*
v,1>=z&&h.candidates.push({type:"vertex",objectId:c.getObjectId(w),distance:Math.sqrt(z),target:a(q,u)})}h.candidates.sort((w,r)=>w.distance-r.distance);return h};l.getPointCreator=function(b,a,c){const e=G.isSome(c)&&!I.equals(a,c)?d=>N.project(d,a,c):d=>d;return null!=b.z&&null!=b.m?(d,f)=>e({x:d,y:f,z:b.z,m:b.m}):null!=b.z?(d,f)=>e({x:d,y:f,z:b.z}):null!=b.m?(d,f)=>e({x:d,y:f,m:b.m}):(d,f)=>e({x:d,y:f})};l.executeAttributesQuery=function(b){var a=T.getWhereClause(b.where,this.fieldsIndex);if(!a)return Promise.resolve(this);
if(a.isStandardized){let c=0;const e=[];for(const d of this.items)a.testFeature(d,this.featureAdapter)&&(e[c++]=d);a=new y(e,this.queryGeometry,this);a.definitionExpression=b.where;return Promise.resolve(a)}return Promise.reject(new TypeError("Where clause is not standardized"))};l.executeAggregateIdsQuery=function(b){if(!b.aggregateIds||!b.aggregateIds.length||G.isNone(this.aggregateAdapter))return Promise.resolve(this);const a=new Set;for(const e of b.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(e).forEach(d=>
a.add(d));const c=this.featureAdapter.getObjectId;return Promise.resolve(new y(this.items.filter(e=>a.has(c(e))),this.queryGeometry,this))};l.executeObjectIdsQuery=function(b){if(!b.objectIds||!b.objectIds.length)return Promise.resolve(this);const a=new Set(b.objectIds),c=this.featureAdapter.getObjectId;return Promise.resolve(new y(this.items.filter(e=>a.has(c(e))),this.queryGeometry,this))};l.executeTimeQuery=function(b){b=U.getTimeOperator(this.timeInfo,b.timeExtent,this.featureAdapter);if(!G.isSome(b))return Promise.resolve(this);
b=this.items.filter(b);return Promise.resolve(new y(b,this.queryGeometry,this))};l.filterLatest=function(){const {trackIdField:b,startTimeField:a,endTimeField:c}=this.timeInfo;var e=c||a;const d=new Map,f=this.featureAdapter.getAttribute;for(const k of this.items){const g=f(k,b),h=f(k,e),m=d.get(g);(!m||h>f(m,e))&&d.set(g,k)}e=Array.from(d.values());return Promise.resolve(new y(e,this.queryGeometry,this))};l.project=function(){var b=D._asyncToGenerator(function*(a){if(!a||I.equals(this.spatialReference,
a))return this;const c=this.featureAdapter,e=(yield N.projectMany(this.items.map(d=>E.getGeometry(this.geometryType,this.hasZ,this.hasM,c.getGeometry(d))),this.spatialReference,a)).map((d,f)=>c.cloneWithGeometry(this.items[f],S.convertFromGeometry(d,this.hasZ,this.hasM)));return new y(e,this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:a,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,
featureAdapter:this.featureAdapter})});return function(a){return b.apply(this,arguments)}}();l.createSummaryStatisticsResponse=function(){var b=D._asyncToGenerator(function*(a,c){const {field:e,valueExpression:d,normalizationField:f,normalizationType:k,normalizationTotal:g,minValue:h,maxValue:m,scale:n}=c;c=this.fieldsIndex.isDateField(e);a=yield this._getDataValues(a,{field:e,valueExpression:d,normalizationField:f,normalizationType:k,normalizationTotal:g,scale:n});const p=A.isNullCountSupported({normalizationType:k,
normalizationField:f,minValue:h,maxValue:m}),q=this.fieldsIndex.get(e),u={value:.5,fieldType:null==q?void 0:q.type};a=Q.isStringField(q)?A.calculateStringStatistics({values:a,supportsNullCount:p,percentileParams:u}):A.calculateStatistics({values:a,minValue:h,maxValue:m,useSampleStdDev:!k,supportsNullCount:p,percentileParams:u});return A.processSummaryStatisticsResult(a,c)});return function(a,c){return b.apply(this,arguments)}}();l.createUniqueValuesResponse=function(){var b=D._asyncToGenerator(function*(a,
c){const {field:e,valueExpression:d,domain:f,returnAllCodedValues:k,scale:g}=c;a=yield this._getDataValues(a,{field:e,valueExpression:d,scale:g});a=A.calculateUniqueValuesCount(a);return A.createUVResult(a,f,k)});return function(a,c){return b.apply(this,arguments)}}();l.createClassBreaksResponse=function(){var b=D._asyncToGenerator(function*(a,c){const {field:e,valueExpression:d,normalizationField:f,normalizationType:k,normalizationTotal:g,classificationMethod:h,standardDeviationInterval:m,minValue:n,
maxValue:p,numClasses:q,scale:u}=c;a=yield this._getDataValues(a,{field:e,valueExpression:d,normalizationField:f,normalizationType:k,normalizationTotal:g,scale:u});a=A.calculateClassBreaks(a,{field:e,normalizationField:f,normalizationType:k,normalizationTotal:g,classificationMethod:h,standardDeviationInterval:m,minValue:n,maxValue:p,numClasses:q});return A.resolveCBResult(a,h)});return function(a,c){return b.apply(this,arguments)}}();l.createHistogramResponse=function(){var b=D._asyncToGenerator(function*(a,
c){const {field:e,valueExpression:d,normalizationField:f,normalizationType:k,normalizationTotal:g,classificationMethod:h,standardDeviationInterval:m,minValue:n,maxValue:p,numBins:q,scale:u}=c;a=yield this._getDataValues(a,{field:e,valueExpression:d,normalizationField:f,normalizationType:k,normalizationTotal:g,scale:u});return A.calculateHistogram(a,{field:e,normalizationField:f,normalizationType:k,normalizationTotal:g,classificationMethod:h,standardDeviationInterval:m,minValue:n,maxValue:p,numBins:q})});
return function(a,c){return b.apply(this,arguments)}}();l._sortFeatures=function(b,a,c){if(1<b.length&&a&&a.length)for(const e of a.reverse()){a=e.split(" ");const d=a[0],f=this.fieldsIndex.get(d);a=a[1]&&"desc"===a[1].toLowerCase();const k=A.getAttributeComparator(null==f?void 0:f.type,a);b.sort((g,h)=>{g=c(g,d,f);h=c(h,d,f);return k(g,h)})}};l._createFeatureQueryResponse=function(b){const a=this.items,{geometryType:c,hasM:e,hasZ:d,objectIdField:f,spatialReference:k}=this,{outFields:g,outSR:h,quantizationParameters:m,
resultRecordCount:n,resultOffset:p,returnZ:q,returnM:u}=b,z=null!=n?a.length>(p||0)+n:!1,v=g&&(g.includes("*")?[...this.fieldsIndex.fields]:g.map(t=>this.fieldsIndex.get(t)));return{exceededTransferLimit:z,features:this._createFeatures(b,a),fields:v,geometryType:c,hasM:e&&u,hasZ:d&&q,objectIdFieldName:f,spatialReference:E.cleanFromGeometryEngine(h?h:k),transform:m&&P.toQuantizationTransform(m)||null}};l._createFeatures=function(b,a){const c=new J(b,this.featureAdapter,this.fieldsIndex),{hasM:e,hasZ:d}=
this,{orderByFields:f,quantizationParameters:k,returnGeometry:g,returnCentroid:h,maxAllowableOffset:m,resultOffset:n,resultRecordCount:p,returnZ:q=!1,returnM:u=!1}=b,z=d&&q,v=e&&u;b=[];var t=0;a=[...a];this._sortFeatures(a,f,(x,B,C)=>c.getFieldValue(x,B,C));if(g||h){var w=P.toQuantizationTransform(k);if(g&&!h)for(var r of a)b[t++]={attributes:c.getAttributes(r),geometry:E.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(r),m,w,z,v)};else if(!g&&h)for(const x of a)b[t++]=
{attributes:c.getAttributes(x),centroid:E.transformCentroid(this,this.featureAdapter.getCentroid(x,this),w)};else for(const x of a)b[t++]={attributes:c.getAttributes(x),centroid:E.transformCentroid(this,this.featureAdapter.getCentroid(x,this),w),geometry:E.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(x),m,w,z,v)}}else for(w of a)(r=c.getAttributes(w))&&(b[t++]={attributes:r});t=n||0;null!=p&&(b=b.slice(t,Math.min(b.length,t+p)));return b};l._createExceedsLimitQueryResponse=
function(b){var a=!1;let c=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY;a=Number.POSITIVE_INFINITY;for(const d of b.outStatistics)if("exceedslimit"===d.statisticType){c=null!=d.maxPointCount?d.maxPointCount:Number.POSITIVE_INFINITY;e=null!=d.maxRecordCount?d.maxRecordCount:Number.POSITIVE_INFINITY;a=null!=d.maxVertexCount?d.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)a=this.items.length>c;else if(this.items.length>e)a=!0;else{b=this.hasZ?this.hasM?
4:3:this.hasM?3:2;const d=this.featureAdapter;a=this.items.reduce((f,k)=>{k=d.getGeometry(k);return f+(G.isSome(k)&&k.coords.length||0)},0)/b>a}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(a)}}]}};l._createStatisticsQueryResponse=function(b){var a={attributes:{}};const c=[],e=new Map,d=new Map,f=new Map,k=new Map,g=new J(b,this.featureAdapter,this.fieldsIndex);
var h=b.outStatistics;const {groupByFieldsForStatistics:m,having:n,orderByFields:p}=b;b=m&&m.length;const q=!!b,u=q&&m[0],z=q&&!this.fieldsIndex.get(u);for(const x of h){const {outStatisticFieldName:B,statisticType:C}=x;h=x;var v="exceedslimit"!==C?x.onStatisticField:void 0;const H="percentile_disc"===C||"percentile_cont"===C,K=q&&1===b&&(v===u||z)&&"count"===C;if(q){if(!f.has(v)){var t=[];for(const F of m){var w=this._getAttributeValues(g,F,e);t.push(w)}f.set(v,this._calculateUniqueValues(t,g.returnDistinctValues))}t=
f.get(v);for(const F in t){const {count:Y,data:R,items:Z,itemPositions:aa}=t[F];w=R.join(",");if(!n||g.validateItems(Z,n)){const O=k.get(w)||{attributes:{}};var r=null;if(K)r=Y;else{const L=this._getAttributeValues(g,v,e);r=aa.map(M=>L[M]);r=H&&"statisticParameters"in h?this._getPercentileValue(h,r):this._getStatisticValue(h,r,null,g.returnDistinctValues)}O.attributes[B]=r;m.forEach((L,M)=>O.attributes[this.fieldsIndex.get(L)?L:`EXPR_${M+1}`]=R[M]);k.set(w,O)}}}else v=this._getAttributeValues(g,v,
e),a.attributes[B]=H&&"statisticParameters"in h?this._getPercentileValue(h,v):this._getStatisticValue(h,v,d,g.returnDistinctValues);c.push({name:B,alias:B,type:"esriFieldTypeDouble"})}a=q?Array.from(k.values()):[a];this._sortFeatures(a,p,(x,B)=>x.attributes[B]);return{fields:c,features:a}};l._getStatisticValue=function(b,a,c,e){const {onStatisticField:d,statisticType:f}=b;b=null;b=null!=c&&c.has(d)?c.get(d):Q.isStringField(this.fieldsIndex.get(d))?A.calculateStringStatistics({values:a,returnDistinct:e}):
A.calculateStatistics({values:a,minValue:null,maxValue:null,useSampleStdDev:!0});c&&c.set(d,b);return b["var"===f?"variance":f]};l._getPercentileValue=function(b,a){const {onStatisticField:c,statisticParameters:e,statisticType:d}=b,{value:f,orderBy:k}=e;b=this.fieldsIndex.get(c);return A.calculatePercentile(a,{value:f,orderBy:k,fieldType:null==b?void 0:b.type,isDiscrete:"percentile_disc"===d})};l._getAttributeValues=function(b,a,c){if(c.has(a))return c.get(a);const e=this.fieldsIndex.get(a),d=this.items.map(f=>
b.getFieldValue(f,a,e));c.set(a,d);return d};l._getAttributeNormalizedValues=function(b,a){return this.items.map(c=>b.getNormalizedValue(c,{field:a.field,fieldInfo:this.fieldsIndex.get(a.field),normalizationField:a.normalizationField,normalizationFieldInfo:this.fieldsIndex.get(a.normalizationField),normalizationType:a.normalizationType,normalizationTotal:a.normalizationTotal}))};l._getAttributeExpressionValues=function(){var b=D._asyncToGenerator(function*(a,c,e){const {arcadeUtils:d}=yield V.loadArcade(),
f=d.createFunction(c),k=e&&d.getViewInfo(e);return this.items.map(g=>a.getExpressionValue(g,{compiledFunc:f,viewInfo:k},d))});return function(a,c,e){return b.apply(this,arguments)}}();l._calculateUniqueValues=function(b,a){const c={},e=this.items,d=e.length;for(let f=0;f<d;f++){const k=e[f],g=[];for(const m of b)g.push(m[f]);const h=g.join(",");a?null==c[h]&&(c[h]={count:1,data:g,items:[k],itemPositions:[f]}):null==c[h]?c[h]={count:1,data:g,items:[k],itemPositions:[f]}:(c[h].count++,c[h].items.push(k),
c[h].itemPositions.push(f))}return c};l._getDataValues=function(){var b=D._asyncToGenerator(function*(a,c){const e=new J(a,this.featureAdapter,this.fieldsIndex),{valueExpression:d,field:f,normalizationField:k,normalizationType:g,normalizationTotal:h,scale:m}=c;a=d?{viewingMode:"map",scale:m,spatialReference:a.outSR||this.spatialReference}:null;return d?this._getAttributeExpressionValues(e,d,a):this._getAttributeNormalizedValues(e,{field:f,normalizationField:k,normalizationType:g,normalizationTotal:h})});
return function(a,c){return b.apply(this,arguments)}}();D._createClass(y,[{key:"size",get:function(){return this.items.length}}]);return y}()});