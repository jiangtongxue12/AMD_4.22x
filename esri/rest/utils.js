// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define(["exports","../core/maybe","../core/urlUtils","../geometry/support/scaleUtils","../views/support/floorFilterUtils"],function(l,r,t,u,m){function p(c,e,g){const a={};for(const f in c)if("declaredClass"!==f){var b=c[f];if(null!=b&&"function"!==typeof b)if(Array.isArray(b)){a[f]=[];for(let h=0;h<b.length;h++)a[f][h]=p(b[h])}else"object"===typeof b?b.toJSON?(b=b.toJSON(g&&g[f]),a[f]=e?b:JSON.stringify(b)):a[f]=e?b:JSON.stringify(b):a[f]=b}return a}function v({floors:c,visibleSublayers:e}){const g=
!(null==c||!c.length);e=e.filter(a=>null!=a.definitionExpression||g&&null!=a.floorInfo);return e.length?e.map(a=>{var b=m.getLayerFloorFilterClause(c,a);b=r.isSome(b)?m.combineFloorsDefinitionExpression(b,a):a.definitionExpression;a={id:a.id,definitionExpression:null};b&&(a.definitionExpression=b);return a}):null}l.asValidOptions=function(c,e){return e?{...e,query:{...c,...e.query}}:{query:c}};l.encode=p;l.parseUrl=function(c){return"string"===typeof c?t.urlToObject(c):c};l.toDynamicLayersJSON=function({mapExtent:c,
floors:e,width:g,sublayers:a,layerIds:b}){const f={};g={extent:c,width:g,spatialReference:null==c?void 0:c.spatialReference};c=a;b&&b.length&&a&&(c=a.filter(d=>b.includes(d.id)));const h=u.getScale(g),n=[],q=d=>{const k=0===h,w=0===d.minScale||h<=d.minScale,x=0===d.maxScale||h>=d.maxScale;d.visible&&(k||w&&x)&&(d.sublayers?d.sublayers.forEach(q):n.unshift(d))};c&&c.forEach(q);c&&c.length&&(a=n.map(d=>{const k=m.getLayerFloorFilterClause(e,d);return d.toExportImageJSON(k)}),(g=a.some(d=>"mapLayer"===
d.source.type?d.source.mapLayerId!==d.id:"dataLayer"===d.source.type))?(a=JSON.stringify(a),"[]"===a&&(a="[{}]"),f.dynamicLayers=a):g||(b&&b.length?f.layerIds=b:(a=c.map(({id:d})=>d),a.length&&(f.layerIds=a)),(a=v({floors:e,visibleSublayers:n}))&&a.length&&(a=a.reduce((d,k)=>{k.definitionExpression&&(d[k.id]=k.definitionExpression);return d},{}),Object.keys(a).length&&(f.layerDefs=JSON.stringify(a)))));return f};Object.defineProperty(l,"__esModule",{value:!0})});