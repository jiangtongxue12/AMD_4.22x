// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Color ../../core/Accessor ../../core/has ../../core/Handles ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/screenUtils ../../core/timeUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../chunks/vec3f64 ../../views/3d/support/earthUtils ../../views/3d/support/sunUtils ./DiscreteOptions ./DurationOptions ./ShadowTooltipViewModel ./ThresholdOptions ../support/traversalUtils".split(" "),
function(t,d,v,c,O,E,g,w,l,y,q,e,P,Q,F,G,H,I,z,A,J,B,K){function u({renderView:m,parameters:n}){g.isSome(m)&&g.isSome(n)&&m.setRenderParameters({shadowCastOptions:n})}function x(m){if(m.suspended)return!1;switch(m.type){case "analysis-3d":case "building-scene-3d":case "csv-3d":case "elevation-3d":case "feature-3d":case "geojson-3d":case "graphics-3d":case "integrated-mesh-3d":case "ogc-feature-3d":case "scene-layer-3d":case "scene-layer-graphics-3d":case "stream-3d":case "wms-3d":return!0;case "base-dynamic-3d":case "imagery-3d":case "imagery-tile-3d":case "map-image-3d":case "point-cloud-3d":case "tile-3d":case "vector-tile-3d":case "voxel-3d":case "wfs-3d":case "wmts-3d":case "voxel-3d":return!1;
case "group":return m.layerViews.toArray().some(n=>x(n));default:return!1}}const C=[],L=G.create(),D=[],M=q.convertTime(1,"hours","milliseconds");c=function(m){function n(a){var b=m.call(this,a)||this;b.view=null;b.tooltip=new J.ShadowTooltipViewModel({getDuration:(f,k)=>b.getDuration(f,k)});b.startTimeOfDay=q.convertTime(10,"hours","milliseconds");b.endTimeOfDay=q.convertTime(16,"hours","milliseconds");b.visualizationType="threshold";b.thresholdOptions=new B;b.durationOptions=new A;b.discreteOptions=
new z;b._running=!0;b._handles=new E;b._stopPreviewingTask=null;b._forcePreview=null;b._autoRestoreForcePreviewEnabled=!0;b._utcOffset=null;b.date=new Date;return b}t._inheritsLoose(n,m);var r=n.prototype;r.initialize=function(){var a=this;this._handles.add([l.react(()=>({view:this.view,tooltipEnabled:this._tooltipEnabled}),({view:b,tooltipEnabled:f})=>{this.tooltip.view=b;this.tooltip.enabled=f},l.syncAndInitial),l.react(()=>this._forcePreviewDependencies,()=>{g.abortMaybe(this._stopPreviewingTask);
this._forcePreview=!0;this._autoRestoreForcePreviewEnabled&&(this._stopPreviewingTask=w.createTask(function(){var b=t._asyncToGenerator(function*(f){yield w.after(500,f);w.throwIfAborted(f);a._forcePreview=!1});return function(f){return b.apply(this,arguments)}}()))},l.syncAndInitial),l.react(()=>({renderView:this.renderView,parameters:this._visualizationParameters}),u,l.syncAndInitial),l.react(()=>({renderView:this.renderView,parameters:{lightDirections:this._lightDirections}}),u,l.syncAndInitial),
l.react(()=>({renderView:this.renderView,parameters:{enabled:this._running}}),u,l.syncAndInitial),l.react(()=>({renderView:this.renderView,parameters:{previewing:this._previewing}}),u,l.syncAndInitial)])};r.destroy=function(){this.stop();this._handles=g.destroyMaybe(this._handles);g.destroyMaybe(this.tooltip)};r.start=function(){this._running=!0};r.stop=function(){this._running=!1};r.setRunning=function(a){this._running=a};r.getDuration=function(){var a=t._asyncToGenerator(function*(b,f){const {view:k,
renderView:p}=this;if(g.isNone(k)||g.isNone(p))return 0;b=k.state.camera.screenToRender(y.createScreenPointArray(b.x,b.y),y.createRenderScreenPointArray());b=p.readAccumulatedShadow(b);f=this._sampleCount;return 0===f?0:this._duration/f*f*b});return function(b,f){return a.apply(this,arguments)}}();t._createClass(n,[{key:"state",get:function(){return g.isSome(this.view)&&this.view.ready&&g.isSome(this._referencePosition)?"ready":"disabled"}},{key:"date",set:function(a){a=new Date(a);a.setHours(0,0,
0,0);this._set("date",a)}},{key:"utcOffset",get:function(){return g.unwrapOr(this._utcOffset,this._utcOffsetAuto)},set:function(a){this._utcOffset=a}},{key:"testData",get:function(){return{setAutoRestoreForcedPreviewEnabled:a=>{this._autoRestoreForcePreviewEnabled=a},setForcedPreview:a=>{this._forcePreview=a},isPreviewing:()=>this._previewing}}},{key:"_previewing",get:function(){const {view:a}=this;return g.isNone(a)||g.isNone(a.allLayerViews)?!0:this._forcePreview||!a.stationary||a.allLayerViews.some(b=>
x(b)&&b.updating)}},{key:"_utcOffsetAuto",get:function(){return g.mapOr(this._referencePosition,0,a=>H.longitudeToTimezone(a[0],!1))}},{key:"_dateUTCOffset",get:function(){let a=this.date;a=q.offsetDateUTC(a,-a.getTimezoneOffset(),"minutes");return a=q.offsetDateUTC(a,-this.utcOffset,"hours")}},{key:"_startDateTimeUTC",get:function(){return q.offsetDateUTC(this._dateUTCOffset,this.startTimeOfDay)}},{key:"_endDateTimeUTC",get:function(){return q.offsetDateUTC(this._dateUTCOffset,this.endTimeOfDay)}},
{key:"_referencePosition",get:function(){return g.applySome(this.view,a=>g.applySome(a.environmentManager,b=>b.referencePositionWGS84Comparable))}},{key:"_interval",get:function(){const a=0<this._duration?Math.floor(this._duration/255):255,b=this.discreteOptions.interval;switch(this.visualizationType){case "threshold":case "duration":return a;case "discrete":return 0<b?b:a}}},{key:"_sampleCount",get:function(){return this._lightDirections.length}},{key:"_duration",get:function(){return this.endTimeOfDay-
this.startTimeOfDay}},{key:"_lightDirections",get:function(){var {view:a}=this;if(g.isNone(a))return C;var b="global"===a.viewingMode?L:this._referencePosition;if(g.isNone(b))return C;a=I.computeDirectionsOverTime(this._startDateTimeUTC,this._endDateTimeUTC,this._interval,b,a.state.viewingMode);b=a.length;D.length=0;const f=K.breadthFirstBinaryPartitioning(0,b,D),k=Array(b);for(let p=0;p<b;++p)k[p]=a[f[p]];return k}},{key:"_tooltipEnabled",get:function(){return"ready"===this.state&&"discrete"!==this.visualizationType&&
this._running&&!this._previewing}},{key:"_visualizationParameters",get:function(){if(!this._running)return null;switch(this.visualizationType){case "threshold":return this._thresholdVisualizationParameters;case "duration":return this._durationVisualizationParameters;case "discrete":return this._discreteVisualizationParameters}}},{key:"_thresholdVisualizationParameters",get:function(){const {value:a,color:b}=this.thresholdOptions,f=this._duration;return{visualization:1,color:v.toUnitRGBA(b),threshold:0<
f?a/this._duration:0}}},{key:"_durationVisualizationParameters",get:function(){const {color:a,mode:b}=this.durationOptions;var f=this._duration;f=0<f&&"hourly"===b?M/f:0;return{color:v.toUnitRGBA(a),visualization:0,bandsEnabled:0<f,bandSize:f}}},{key:"_discreteVisualizationParameters",get:function(){return{color:v.toUnitRGBA(this.discreteOptions.color),visualization:0,bandsEnabled:!1,bandSize:0}}},{key:"_forcePreviewDependencies",get:function(){var {view:a}=this;if(g.isNone(a))return null;const b=
a.slicePlane;var f=a.allLayerViews.toArray().filter(x),k=f.map(h=>h.layer).filter(g.isSome);a=f.map(h=>h.visible);const p=k.map(h=>h.visible),N=k.map(h=>h.opacity);k=k.filter(function(h){return"definitionExpression"in h}).map(h=>h.definitionExpression);f=f.filter(function(h){return"filter"in h}).map(h=>h.filter);return{slicePlane:b,startDateUTC:this._startDateTimeUTC,endDateUTC:this._endDateTimeUTC,layerViewVisibilities:a,layerVisibilities:p,layerOpacities:N,filters:f,definitionExpressions:k}}},{key:"renderView",
get:function(){var {view:a}=this;if(g.isNone(a))return null;a=a._stage;return g.isNone(a)?null:a.renderView}}]);return n}(c);d.__decorate([e.property()],c.prototype,"state",null);d.__decorate([e.property()],c.prototype,"view",void 0);d.__decorate([e.property()],c.prototype,"tooltip",void 0);d.__decorate([e.property({nonNullable:!0})],c.prototype,"date",null);d.__decorate([e.property({nonNullable:!0})],c.prototype,"utcOffset",null);d.__decorate([e.property({nonNullable:!0})],c.prototype,"startTimeOfDay",
void 0);d.__decorate([e.property({nonNullable:!0})],c.prototype,"endTimeOfDay",void 0);d.__decorate([e.property({nonNullable:!0})],c.prototype,"visualizationType",void 0);d.__decorate([e.property({type:B,nonNullable:!0})],c.prototype,"thresholdOptions",void 0);d.__decorate([e.property({type:A,nonNullable:!0})],c.prototype,"durationOptions",void 0);d.__decorate([e.property({type:z,nonNullable:!0})],c.prototype,"discreteOptions",void 0);d.__decorate([e.property()],c.prototype,"_running",void 0);d.__decorate([e.property()],
c.prototype,"_handles",void 0);d.__decorate([e.property()],c.prototype,"_stopPreviewingTask",void 0);d.__decorate([e.property()],c.prototype,"_forcePreview",void 0);d.__decorate([e.property()],c.prototype,"_autoRestoreForcePreviewEnabled",void 0);d.__decorate([e.property()],c.prototype,"_previewing",null);d.__decorate([e.property()],c.prototype,"_utcOffset",void 0);d.__decorate([e.property()],c.prototype,"_utcOffsetAuto",null);d.__decorate([e.property()],c.prototype,"_dateUTCOffset",null);d.__decorate([e.property()],
c.prototype,"_startDateTimeUTC",null);d.__decorate([e.property()],c.prototype,"_endDateTimeUTC",null);d.__decorate([e.property()],c.prototype,"_referencePosition",null);d.__decorate([e.property()],c.prototype,"_interval",null);d.__decorate([e.property()],c.prototype,"_sampleCount",null);d.__decorate([e.property()],c.prototype,"_duration",null);d.__decorate([e.property()],c.prototype,"_lightDirections",null);d.__decorate([e.property()],c.prototype,"_tooltipEnabled",null);d.__decorate([e.property()],
c.prototype,"_visualizationParameters",null);d.__decorate([e.property()],c.prototype,"_thresholdVisualizationParameters",null);d.__decorate([e.property()],c.prototype,"_durationVisualizationParameters",null);d.__decorate([e.property()],c.prototype,"_discreteVisualizationParameters",null);d.__decorate([e.property()],c.prototype,"_forcePreviewDependencies",null);d.__decorate([e.property()],c.prototype,"renderView",null);return c=d.__decorate([F.subclass("esri.widgets.ShadowCast.ShadowCastViewModel")],
c)});