// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../TimeExtent ../../TimeInterval ../../core/Collection ../../core/deprecate ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/timeUtils ../../core/watchUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../webdoc/Widgets ../../webdoc/widgets/TimeSlider ./utils".split(" "),
function(u,h,m,K,F,G,f,L,M,c,B,N,v,k,R,S,H,O,P,Q,z){function C(g){return c.isSome(g)&&void 0!==g.count}function A(g){return c.isSome(g)&&void 0!==g.interval}function I(g){return c.isSome(g)&&void 0!==g.dates}var D;const E=M.getLogger("esri.widgets.Popup.PopupViewModel");f=D=function(g){function x(a){a=g.call(this,a)||this;a._animationController=null;a._loadingWebDocument=!1;a._timerId=null;a._updateTimeSliderTask=null;a.actions=new F;a.view=null;return a}u._inheritsLoose(x,g);var l=x.prototype;l.initialize=
function(){var a=this;this.handles.add([v.init(this,"effectiveStops",()=>{c.isNone(this.timeExtent)&&this._set("timeExtent",this._getDefaultTimeExtent())}),v.init(this,"view.map",b=>{c.isSome(this._updateTimeSliderTask)&&(this._updateTimeSliderTask.abort(),this._updateTimeSliderTask=null);this._updateTimeSliderTask=B.createTask(function(){var d=u._asyncToGenerator(function*(e){a._loadingWebDocument=!0;yield a._updateTimeSliderFromMap(b,e);a._loadingWebDocument=!1});return function(e){return d.apply(this,
arguments)}}())}),v.init(this,"view",(b,d)=>{this._unregisterWidget(d);this._registerWidget(b)},!0),v.init(this,"timeExtent",b=>{if(!c.isNone(this.view)){var d=this.view.timeExtent;(c.isNone(b)||b.isAllTime)&&(c.isNone(d)||d.isAllTime)||c.isSome(b)&&c.isSome(d)&&b.equals(d)||(this.view.timeExtent=c.unwrap(b))}}),v.watch(this,"view.timeExtent",b=>{(c.isNone(b)||b.isAllTime)&&(c.isNone(this.timeExtent)||this.timeExtent.isAllTime)||c.isSome(b)&&c.isSome(this.timeExtent)&&b.equals(this.timeExtent)||(this.timeExtent=
b)})])};l.destroy=function(){c.isSome(this._timerId)&&(clearInterval(this._timerId),this._timerId=null);this._unregisterWidget(this.view);this.view=null;c.isSome(this._animationController)&&(this._animationController.abort(),this._animationController=null);c.isSome(this._updateTimeSliderTask)&&(this._updateTimeSliderTask.abort(),this._updateTimeSliderTask=null)};x.getPropertiesFromWebMap=function(){var a=u._asyncToGenerator(function*(b,d){var e,n;if(!b||"esri.WebMap"!==b.declaredClass)return null;
yield b.load({signal:d});var p=null==b?void 0:null==(e=b.widgets)?void 0:e.timeSlider;if(!p)return null;b=yield z.getFullTimeExtentFromWebDocument(b,d);d=p.loop;e=z.getModeFromTimeSlider(p);const r=null!=(n=p.stopDelay)?n:2E3;n=z.getStopsFromTimeSlider(p);p=z.getTimeExtentFromTimeSlider(p,e);return{fullTimeExtent:b,loop:d,mode:e,playRate:r,stops:n,timeExtent:p}});return function(b,d){return a.apply(this,arguments)}}();l.next=function(){this._step({forward:!0,allowRestart:!1})};l.play=function(){this._startAnimation()};
l.previous=function(){this._step({forward:!1,allowRestart:!1})};l.stop=function(){this._stopAnimation()};l.triggerAction=function(a){this.emit("trigger-action",{action:a})};l.updateWebDocument=function(a){if("esri.WebMap"===a.declaredClass){const b=new Q({currentTimeExtent:this.timeExtent,fullTimeExtent:this.fullTimeExtent,loop:this.loop,numStops:C(this.stops)?this.stops.count:null,numThumbs:"time-window"===this.mode?2:1,stopDelay:this.playRate,stopInterval:A(this.stops)?this.stops.interval:null,
stops:I(this.stops)?this.stops.dates:null});a.widgets?a.widgets.timeSlider=b:a.widgets=new P({timeSlider:b})}};l.valuesToTimeExtent=function(a){if(c.isNone(a))return null;var b=a.sort((d,e)=>d-e).map(d=>new Date(d));a=0<b.length?b[0]:null;b=1<b.length?b[1]:null;switch(this.mode){case "time-window":return new m({start:a,end:b});case "instant":return new m({start:a,end:a});case "cumulative-from-start":return new m({start:null,end:a});case "cumulative-from-end":return new m({start:a,end:null});default:return m.allTime}};
l._animate=function(){var a=u._asyncToGenerator(function*(){try{yield Promise.all([B.after(this.playRate,null,c.isSome(this._animationController)&&this._animationController.signal),c.isSome(this.view)&&v.whenFalseOnce(this.view,"updating",c.isSome(this._animationController)&&this._animationController.signal)])}catch(b){B.isAbortError(b)||E.error(b);this._animationController=null;return}this._step({forward:!0,allowRestart:!1});c.isNone(this._animationController)||this._animate()});return function(){return a.apply(this,
arguments)}}();l._divideTimeExtentByCount=function(a,b=10){if(!a||!b)return[];const {start:d,end:e}=a;if(c.isNone(d)||c.isNone(e))return[];if(1E4<b)return this._divideTimeExtentByCount(a);a=[];const n=d.getTime(),p=e.getTime()-n;for(let r=0;r<=b;r++)a.push(new Date(n+r/b*p));return a};l._divideTimeExtentByInterval=function(a,b,d=1E4){if(!a||!b)return[];const {start:e,end:n}=a;if(c.isNone(e)||c.isNone(n))return[];const p=n.getTime()-e.getTime(),r=b.toMilliseconds();if(p/r>d)return this._divideTimeExtentByCount(a);
a=[];const {value:y,unit:q}=b;for(b=e;b.getTime()<=n.getTime();)a.push(new Date(b.getTime())),b=N.offsetDate(b,y,q);return a};l._getDefaultTimeExtent=function(){const {effectiveStops:a,mode:b}=this;if(c.isNone(a)||!b)return null;switch(b){case "time-window":return 1<a.length?new m({start:a[0],end:a[1]}):null;case "cumulative-from-start":return 0<a.length?new m({start:null,end:a[0]}):null;case "cumulative-from-end":return 0<a.length?new m({start:a[0],end:null}):null;case "instant":return 0<a.length?
new m({start:a[0],end:a[0]}):null;default:return null}};l._registerWidget=function(a){c.isSome(a)&&(a.persistableViewModels.some(b=>b===this)||a.persistableViewModels.add(this))};l._startAnimation=function(){this._stopAnimation();this._animationController=new AbortController;this._step({forward:!0,allowRestart:!0});this._animate()};l._step=function(a){const {forward:b,allowRestart:d}=a;({effectiveStops:a}=this);if(!c.isNone(this.timeExtentValues)&&!c.isNone(a)){var e=a.map(q=>q.getTime());a=this.timeExtentValues.map(q=>
{var w=e.indexOf(q);if(-1!==w)return w;w=e.reduce((t,J)=>Math.abs(J-q)<Math.abs(t-q)?J:t);return e.indexOf(w)});var n=a.map(q=>q+=b?1:-1),p=n.some(q=>0>q||q>e.length-1),{loop:r,state:y}=this;if(p)if(r||d){const q=Math.min(...a),w=Math.max(...a);a=(b?a.map(t=>t-q):a.map(t=>t+(e.length-1-w))).map(t=>e[t]);this.timeExtent=this.valuesToTimeExtent(a)}else"playing"===y&&this.stop();else a=n.map(q=>e[q]),this.timeExtent=this.valuesToTimeExtent(a)}};l._stopAnimation=function(){c.isSome(this._animationController)&&
(this._animationController.abort(),this._animationController=null)};l._unregisterWidget=function(a){c.isSome(a)&&a.persistableViewModels.remove(this)};l._updateTimeSliderFromMap=function(){var a=u._asyncToGenerator(function*(b,d){b=yield D.getPropertiesFromWebMap(b,d);if(!c.isNone(b))for(const e in b)this._isOverridden(e)||(this[e]=b[e])});return function(b,d){return a.apply(this,arguments)}}();u._createClass(x,[{key:"effectiveStops",get:function(){const {fullTimeExtent:a,stops:b}=this;if(I(b)){var {dates:d}=
b;if(null==d||0===d.length)return null;d=d.sort((r,y)=>r.getTime()-y.getTime());if(c.isNone(a))return d;const {start:n,end:p}=a;return c.isNone(n)||c.isNone(p)?d:d.filter(r=>!(r.getTime()<n.getTime()||r.getTime()>p.getTime()))}if(C(b)){var e=null!=(d=b.timeExtent)?d:c.unwrap(a);return this._divideTimeExtentByCount(e,b.count)}return A(b)?(d=null!=(e=b.timeExtent)?e:c.unwrap(a),this._divideTimeExtentByInterval(d,b.interval)):[]}},{key:"fullTimeExtent",set:function(a){this._override("fullTimeExtent",
a)}},{key:"loop",set:function(a){this._override("loop",a)}},{key:"mode",set:function(a){this._override("mode",a)}},{key:"playRate",set:function(a){0>=a||36E5<a||("playing"===this.state&&this._startAnimation(),this._override("playRate",a))}},{key:"state",get:function(){return c.isNone(this.fullTimeExtent)||this._loadingWebDocument?"disabled":c.isSome(this._animationController)?"playing":"ready"}},{key:"stops",set:function(a){this._override("stops",a)}},{key:"timeExtent",set:function(a){this._override("timeExtent",
a)}},{key:"timeExtentValues",get:function(){const {mode:a,timeExtent:b}=this;if(c.isNone(b)||b.isAllTime||b.isEmpty)return null;const {start:d,end:e}=b;switch(a){case "cumulative-from-end":case "instant":return c.isSome(d)?[d.getTime()]:null;case "cumulative-from-start":return c.isSome(e)?[e.getTime()]:null;case "time-window":return c.isSome(d)&&c.isSome(e)?[d.getTime(),e.getTime()]:null}}},{key:"values",get:function(){G.deprecatedProperty(E,"values",{replacement:"timeExtent",version:"4.20"});const {mode:a,
timeExtent:b}=this;if(c.isNone(b))return null;if(b.isAllTime)return"time-window"===a?[null,null]:[null];if(b.isEmpty)return"time-window"===a?[void 0,void 0]:[void 0];const {start:d,end:e}=b;switch(a){case "time-window":return[d,e];case "instant":case "cumulative-from-end":return[d];case "cumulative-from-start":return[e]}},set:function(a){G.deprecatedProperty(E,"values",{replacement:"timeExtent",version:"4.20"});if(c.isNone(a))this.timeExtent=null;else{var b=a[0];if(c.isNone(b))this.timeExtent=new m({start:b,
end:b});else switch(a=1<a.length&&a[1],this.mode){case "time-window":this.timeExtent=new m({start:b,end:a});break;case "instant":this.timeExtent=new m({start:b,end:b});break;case "cumulative-from-end":this.timeExtent=new m({start:b,end:null});break;case "cumulative-from-start":this.timeExtent=new m({start:null,end:b})}}}}]);return x}(L.HandleOwnerMixin(f.EventedAccessor));h.__decorate([k.property()],f.prototype,"_animationController",void 0);h.__decorate([k.property()],f.prototype,"_loadingWebDocument",
void 0);h.__decorate([k.property({type:F})],f.prototype,"actions",void 0);h.__decorate([k.property({readOnly:!0})],f.prototype,"effectiveStops",null);h.__decorate([k.property({type:m,value:null})],f.prototype,"fullTimeExtent",null);h.__decorate([k.property({nonNullable:!0,value:!1})],f.prototype,"loop",null);h.__decorate([k.property({nonNullable:!0,value:"time-window"})],f.prototype,"mode",null);h.__decorate([k.property({nonNullable:!0,value:1E3})],f.prototype,"playRate",null);h.__decorate([k.property({readOnly:!0})],
f.prototype,"state",null);h.__decorate([k.property({cast:g=>{if(c.isNone(g))return null;A(g)&&(g.interval=H.ensureType(K,g.interval));if(A(g)||C(g))g.timeExtent=H.ensureType(m,g.timeExtent);return g},value:{count:10}})],f.prototype,"stops",null);h.__decorate([k.property({type:m,value:null})],f.prototype,"timeExtent",null);h.__decorate([k.property({readOnly:!0})],f.prototype,"timeExtentValues",null);h.__decorate([k.property({value:null})],f.prototype,"values",null);h.__decorate([k.property()],f.prototype,
"view",void 0);h.__decorate([k.property()],f.prototype,"next",null);h.__decorate([k.property()],f.prototype,"play",null);h.__decorate([k.property()],f.prototype,"previous",null);h.__decorate([k.property()],f.prototype,"stop",null);h.__decorate([k.property()],f.prototype,"updateWebDocument",null);return f=D=h.__decorate([O.subclass("esri.widgets.Popup.PopupViewModel")],f)});