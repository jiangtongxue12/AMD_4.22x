// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/handleUtils ../../core/maybe ../../core/promiseUtils ../../core/watchUtils ../../core/Logger ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/set ../../core/accessorSupport/decorators/subclass ../../views/support/layerViewUtils ./Edits ./UpdateWorkflowData ./Workflow ./workflowUtils".split(" "),function(l,H,B,C,x,I,y,P,Q,R,S,J,K,L,M,N,u){var z;y=z=function(D){function v(b){b=
D.call(this,b)||this;b.type="update";return b}l._inheritsLoose(v,D);v.create=function(b,p,a){b=new z({data:new M({edits:new L.Edits,viewModel:b}),onCommit:function(){var h=l._asyncToGenerator(function*(d){const f=d.edits.feature,c=f.sourceLayer,e=f.clone();if(!d.edits.attributesModified){const {objectIdField:g}=c;e.attributes={[g]:f.getAttribute(g)}}d.edits.geometryModified||(e.geometry=null);yield a(c,{updateFeatures:[e]})});return function(d){return h.apply(this,arguments)}}()});b._set("steps",
this._createWorkflowSteps(b,p));return b};var E=v.prototype;E.highlight=function(b){var {data:{viewModel:{view:p}}}=this;p=b&&p.allLayerViews.items.find(({layer:a})=>a===b.layer);K.highlightsSupported(p)&&this.handles.add(p.highlight(b),"candidate-highlight")};E.unhighlight=function(){this.handles.remove("candidate-highlight")};v._createWorkflowSteps=function(b,p="awaiting-feature-to-update"){const {data:a,handles:h}=b;return u.createWorkflowSteps(["awaiting-feature-to-update","awaiting-update-feature-candidate",
"editing-existing-feature","adding-attachment","editing-attachment"],p,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",setUp(){var d=this;return l._asyncToGenerator(function*(){const {spinnerViewModel:f,view:c}=a.viewModel;let e=null;h.add({remove(){e&&(e.abort(),e=null)}},d.id);a.edits.feature=null;const g=c.on("immediate-click",n=>{f.location=n.mapPoint;f.visible=!0;e&&e.abort();const {editableItems:m}=a.viewModel;e=new AbortController;(new Promise((q,t)=>{x.onAbort(e.signal,
()=>t(x.createAbortError()));q(u.fetchCandidates(m,c,n,e.signal))})).then(q=>{x.throwIfAborted(e);a.candidates=q.reduce((t,r)=>r.error?t:[...t,...r.value],[]);a.viewModel.spinnerViewModel.visible=1===a.candidates.length;0!==a.candidates.length&&(1===a.candidates.length?(a.edits.feature=a.candidates[0],a.viewModel.activeWorkflow.go("editing-existing-feature").catch(()=>{}).then(()=>a.viewModel.spinnerViewModel.visible=!1)):a.viewModel.activeWorkflow.next())})});h.add(g,d.id)})()},tearDown(){var d=
this;return l._asyncToGenerator(function*(){h.remove(d.id)})()}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",setUp(){var d=this;return l._asyncToGenerator(function*(){const {edits:f}=a;f.feature=null;h.add(I.watch(f,"feature",c=>{b.unhighlight();b.highlight(c)}),d.id)})()},tearDown(){var d=this;return l._asyncToGenerator(function*(){b.unhighlight();h.remove(d.id)})()}}),"editing-existing-feature":()=>({id:"editing-existing-feature",setUp(){var d=this;return l._asyncToGenerator(function*(){const f=
a.edits.feature,c=a.viewModel;a.editableItem=c.editableItems.find(k=>k.layer===f.layer);const e=new AbortController;h.add({remove:()=>e.abort()},d.id);var g=c.view.whenLayerView(f.layer),n=u.fetchFullFeature(f,c.view,e.signal);g=yield g;const m=yield n;if(!x.isAborted(e)){a.edits.updateGeometry(m.geometry);a.edits.updateAttributes(m.attributes);a.edits.trackChanges();c.attachmentsViewModel.set({graphic:m,mode:"view"});n=m.sourceLayer;var q=u.findLayerInfo(c.layerInfos,n),t=null==q?void 0:q.formTemplate;
c.featureFormViewModel.set({feature:m,fieldConfig:t?null:null==q?void 0:q.fieldConfig,formTemplate:t});var r="createInteractiveEditSession"in g?g.createInteractiveEditSession(f):null;g=[c.featureFormViewModel.on("value-change",k=>{a.edits.updateAttributes(c.featureFormViewModel.getValues());m.attributes=a.edits.feature.attributes;r&&r.setAttribute(k.fieldName,k.value)}),c.attachmentsViewModel.watch("mode",k=>{"add"===k&&a.viewModel.activeWorkflow.go("adding-attachment");"edit"===k&&a.viewModel.activeWorkflow.go("editing-attachment")})];
r&&(g.push(B.makeHandle(()=>r.rollback())),h.add(B.makeHandle(()=>r.commit()),b._handleKeys.afterCommit));({supportsGeometryUpdate:n}=n.capabilities.editing);if(n){c.sketchViewModel.allowDeleteKey=!1;const k=u.getVisualVariableAttributes(m),{interactive:F,visual:G}=yield u.setUpGeometryUpdate(m,k,c.sketchViewModel,c.view,({geometry:O,attributes:A})=>{if(C.isSome(k.rotation)){var {field:w}=k.rotation;c.featureFormViewModel.setValue(w,A[w])}C.isSome(k.size)&&({field:w}=k.size,c.featureFormViewModel.setValue(w,
A[w]));a.edits.updateAttributes(A);a.edits.updateGeometry(O)});g.push(F,G);h.add(F,b._handleKeys.beforeCommit);h.add(G,b._handleKeys.afterCommit)}else b.highlight(m);h.add(g,d.id)}})()},tearDown(){var d=this;return l._asyncToGenerator(function*(){b.unhighlight();h.remove(d.id)})()}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",setUp(){return l._asyncToGenerator(function*(){})()},tearDown(){return l._asyncToGenerator(function*(){})()}}),"editing-attachment":()=>
({id:"editing-attachment",parent:"editing-existing-feature",setUp(){return l._asyncToGenerator(function*(){})()},tearDown(){return l._asyncToGenerator(function*(){})()}})})};return v}(N);return y=z=H.__decorate([J.subclass("esri.widgets.Editor.UpdateWorkflow")],y)});