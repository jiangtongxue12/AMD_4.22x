// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.22/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/colorUtils ../../core/JSONSupport ../../core/Logger ../../core/maybe ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/has ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../layers/support/RasterInfo ../../layers/support/rasterFunctions/pixelUtils ../../layers/support/rasterFunctions/surfaceUtils ./colorRampUtils".split(" "),function(I,B,J,y,K,v,C,
P,Q,R,L,M,q,D,E){function N(w,z){const {attributeTable:m,bandCount:b}=w;return!v.isSome(m)||1<b||z&&null==m.fields.find(a=>a.name.toLowerCase()===z.toLowerCase())?!1:!0}function O(w){const {bandCount:z,colormap:m}=w;return v.isSome(m)&&m.length&&1===z}function F(w){return q.isValidPixelBlock(w)&&0!==w.validPixelCount}const G=K.getLogger("esri.renderers.support.RasterSymbolizer"),H={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,
2147483647],f32:[-3.4*1E39,3.4*1E39],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]};y=function(w){function z(b){return w.call(this,b)||this}I._inheritsLoose(z,w);var m=z.prototype;m.bind=function(){const {rendererJSON:b}=this;if(!b)return{success:!1};this.lookup={rendererJSON:{}};let a;switch(b.type){case "uniqueValue":a={success:this._updateUVRenderer(b)};break;case "rasterColormap":a={success:this._updateColormapRenderer(b)};break;case "rasterStretch":a={success:this._updateStretchRenderer(b)};break;
case "classBreaks":a={success:this._updateClassBreaksRenderer(b)};break;case "rasterShadedRelief":a={success:this._updateShadedReliefRenderer(b)};break;case "vectorField":a={success:this._updateVectorFieldRenderer()};break;case "animatedFlow":a=this._updateAnimatedFlowRenderer()}return a};m.symbolize=function(b){let a=b&&b.pixelBlock;if(!F(a))return a;if(b.simpleStretchParams&&"rasterStretch"===this.rendererJSON.type)return this.simpleStretch(a,b.simpleStretchParams);try{3<a.pixels.length&&(a=q.extractBands(a,
[0,1,2]));let d;switch(this.rendererJSON.type){case "uniqueValue":case "rasterColormap":d=this._symbolize_colormap(a);break;case "classBreaks":d=this._symbolize_classBreaks(a);break;case "rasterStretch":d=this._symbolize_stretch(a,b.bandIds);break;case "rasterShadedRelief":({extent:b}=b),d=this._symbolize_shadedRelief(a,{isGCS:b.spatialReference.isGeographic,resolution:{x:(b.xmax-b.xmin)/a.width,y:(b.ymax-b.ymin)/a.height}})}return d}catch(d){return G.error("symbolize",d.message),a}};m.simpleStretch=
function(b,a){if(!F(b))return b;try{return 3<b.pixels.length&&(b=q.extractBands(b,[0,1,2])),q.stretch(b,a)}catch(d){return G.error("symbolize",d.message),b}};m.generateWebGLParameters=function(b){if(-1<["uniqueValue","rasterColormap","classBreaks"].indexOf(this.rendererJSON.type)){var a;const {indexedColormap:g,offset:h}=(null==(a=this.lookup)?void 0:a.colormapLut)||{};return{colormap:g,colormapOffset:h,type:"lut"}}const {pixelBlock:d,isGCS:k,resolution:c,bandIds:e}=b;({rendererJSON:b}=this);return"rasterStretch"===
b.type?this.generateStretchWebGLParams(d,b,e):"rasterShadedRelief"===b.type?this.generateShadedReliefWebGLParams(b,k,c):"vectorField"===b.type?this._generateVectorFieldWebGLParams(b):null};m._isLUTChanged=function(b){if(!this.lookup||!this.lookup.rendererJSON)return!0;if("colorRamp"in this.rendererJSON){const a=this.rendererJSON.colorRamp;if(b)return JSON.stringify(a)!==JSON.stringify(this.lookup.rendererJSON.colorRamp);({...this.rendererJSON});({...this.lookup.rendererJSON})}return JSON.stringify(this.rendererJSON)!==
JSON.stringify(this.lookup.rendererJSON)};m._symbolize_colormap=function(b){return this._isLUTChanged()&&!this.bind().success?b:q.colorize(b,this.lookup.colormapLut)};m._symbolize_classBreaks=function(b){const a=-1<["u8","u16","s8","s16"].indexOf(this.rasterInfo.pixelType);return this._isLUTChanged()&&!this.bind().success?b:a?q.colorize(b,this.lookup.colormapLut):q.remapColor(b,this.lookup.remapLut)};m._symbolize_stretch=function(b,a){const {pixelType:d,bandCount:k}=this.rasterInfo,c=this.rendererJSON,
e=-1<["u8","u16","s8","s16"].indexOf(d);let g;var {dra:h}=c;var f=c.useGamma?c.gamma:null;if("histogramEqualization"===c.stretchType){var l=h?null:this.lookup.histogramLut;a=this.getStretchCutoff(c,b,a,!l);f=q.stretch(b,{...a,gamma:f});f=q.lookupPixels(f,{lut:h?a.histogramLut:l,offset:0})}else if(e){var r;if(h)h=this.getStretchCutoff(c,b,a),g=q.createStretchLUT({pixelType:d,...h,gamma:f});else{if(this._isLUTChanged()&&!this.bind().success)return b;g=this.lookup?this.lookup.stretchLut:null}if(!g)return b;
1<k&&(null==a?void 0:a.length)===(null==(l=v.unwrap(b))?void 0:l.pixels.length)&&(null==(r=g)?void 0:r.lut.length)===k&&(g={lut:a.map(n=>g.lut[n]),offset:g.offset});f=q.lookupPixels(b,g)}else h=this.getStretchCutoff(c,b,a),f=q.stretch(b,{...h,gamma:f});if(c.colorRamp){if(this._isLUTChanged(!0)&&!this.bind().success)return b;f=q.colorize(f,this.lookup.colormapLut)}return f};m._symbolize_shadedRelief=function(b,a){var d,k,c=this.rendererJSON;a=D.hillshade(b,{...c,...a});if(!c.colorRamp||this._isLUTChanged(!0)&&
!this.bind().success)return a;c=this.lookup?this.lookup.hsvMap:null;if(!c)return a;const e=null!=(d=null==(k=v.unwrap(this.rasterInfo.statistics))?void 0:k[0])?d:{min:0,max:8E3};D.tintHillshade(a,b,c,e);return a};m._updateVectorFieldRenderer=function(){const {bandCount:b,dataType:a}=this.rasterInfo;return 2===b&&("vector-magdir"===a||"vector-uv"===a)};m._updateAnimatedFlowRenderer=function(){const {bandCount:b,dataType:a}=this.rasterInfo;return 2!==b||"vector-magdir"!==a&&"vector-uv"!==a?{success:!1,
error:`Unsupported data type "${a}"; AnimatedFlowRenderer only supports "vector-magdir" and "vector-uv".`}:{success:!0}};m._updateUVRenderer=function(b){const {bandCount:a,attributeTable:d,pixelType:k}=this.rasterInfo,c=b.field1;if(!c)return!1;const e=b.defaultSymbol;var g=1===a&&["u8","s8"].includes(k);if(!N(this.rasterInfo,c)&&!g)return!1;const h=[];if(d){const f=d.fields.filter(l=>"value"===l.name.toLowerCase())[0];if(!f)return!1;d.features.forEach(l=>{var r,n=b.uniqueValueInfos.filter(t=>String(t.value)===
String(l.attributes[c]))[0];(n=null==n?void 0:null==(r=n.symbol)?void 0:r.color)?h.push([l.attributes[f.name]].concat(n)):e&&h.push([l.attributes[f.name]].concat(e.color))})}else{if("value"!==c.toLowerCase())return!1;b.uniqueValueInfos.forEach(f=>{var l;const r=null==f?void 0:null==(l=f.symbol)?void 0:l.color;r?h.push([parseInt(""+f.value,10)].concat(r)):e&&h.push([parseInt(""+f.value,10)].concat(e.color))})}if(0===h.length)return!1;g=q.createColormapLUT({colormap:h});this.lookup={rendererJSON:b,
colormapLut:g};return this.canRenderInWebGL=!0};m._updateColormapRenderer=function(b){if(!O(this.rasterInfo))return!1;var a=b.colormapInfos.map(d=>[d.value].concat(d.color)).sort((d,k)=>d[0]-k[0]);if(!a||0===a.length)return!1;a=q.createColormapLUT({colormap:a});this.lookup={rendererJSON:b,colormapLut:a};return this.canRenderInWebGL=!0};m._updateShadedReliefRenderer=function(b){if("elevation"!==this.rasterInfo.dataType)return!1;if(b.colorRamp){var a=E.convertColorRampToColormap(b.colorRamp,256,!0);
a=q.createColormapLUT({colormap:a});const d=[],k=a.indexedColormap;for(let c=0;c<k.length;c+=4){const e=J.toHSV({r:k[c],g:k[c+1],b:k[c+2]});d.push([e.h/60,e.s/100,255*e.v/100])}this.lookup={rendererJSON:b,colormapLut:a,hsvMap:d}}else this.lookup=null;return this.canRenderInWebGL=!0};m._updateClassBreaksRenderer=function(b){var a=-1<["u8","u16","s8","s16"].indexOf(this.rasterInfo.pixelType),d=b.classBreakInfos;if(null==d||!d.length)return!1;d=d.sort((h,f)=>h.classMaxValue-f.classMaxValue);const k=
d[d.length-1];var c=b.minValue;if(!a){a=[];for(var e=0;e<d.length;e++){var g;a.push({value:null!=(g=d[e].classMinValue)?g:c,mappedColor:d[e].symbol.color});c=d[e].classMaxValue}a.push({value:k.classMaxValue,mappedColor:k.symbol.color});this.lookup={rendererJSON:b,remapLut:a};this.canRenderInWebGL=!1;return!0}g=[];c=Math.floor(b.minValue);for(a=0;a<d.length;a++){for(e=d[a];c<e.classMaxValue;c++)g.push([c].concat(e.symbol.color));c=Math.ceil(e.classMaxValue)}k.classMaxValue===c&&g.push([k.classMaxValue].concat(k.symbol.color));
d=q.createColormapLUT({colormap:g,fillUnspecified:!1});this.lookup={rendererJSON:b,colormapLut:d};return this.canRenderInWebGL=!0};m._isHistogramRequired=function(b){return"percentClip"===b||"histogramEqualization"===b};m._isValidRasterStatistics=function(b){return v.isSome(b)&&0<b.length&&null!=b[0].min&&null!=b[0].max};m._updateStretchRenderer=function(b){var a;let {stretchType:d,dra:k}=b;if(!("none"===d||null!=(a=b.statistics)&&a.length||this._isValidRasterStatistics(this.rasterInfo.statistics)||
k))return!1;var c=v.unwrap(b.histograms||this.rasterInfo.histograms);!this._isHistogramRequired(b.stretchType)||null!=c&&c.length||k||(d="minMax");const {gamma:e,useGamma:g,colorRamp:h}=b;a=this.rasterInfo.pixelType;const f=!k&&-1<["u8","u16","s8","s16"].indexOf(a);"histogramEqualization"===d?(a=c.map(l=>q.createHistogramEqualizationLUT(l)),this.lookup={rendererJSON:b,histogramLut:a}):f&&(c=this.getStretchCutoff(b),a=q.createStretchLUT({pixelType:a,...c,gamma:g?e:null}),this.lookup={rendererJSON:b,
stretchLut:a});h&&(a=E.convertColorRampToColormap(h,256,!0),this.lookup||(this.lookup={rendererJSON:b}),this.lookup.colormapLut=q.createColormapLUT({colormap:a}),this.lookup.rendererJSON=b);return this.canRenderInWebGL=!0};m.getStretchCutoff=function(b,a=null,d,k){var c,e,g,h=b.stretchType;if(b.dra)if("minMax"===h&&v.isSome(a)&&a.statistics)a=a.statistics.map(x=>[x.minValue,x.maxValue,0,0]);else{var f=q.estimateStatisticsHistograms(a);a=v.isSome(f)?f.statistics:null;f=v.isSome(f)?f.histograms:null}else{var l;
a=0<(null==(l=b.statistics)?void 0:l.length)?b.statistics:v.unwrap(this.rasterInfo.statistics);f=b.histograms||v.unwrap(this.rasterInfo.histograms)}!this._isHistogramRequired(h)||null!=(c=f)&&c.length||(h="minMax");l=(null==(e=a)?void 0:e.length)||(null==(g=f)?void 0:g.length)||this.rasterInfo.bandCount;e=[];g=[];let r;let n,t,p;a&&!Array.isArray(a[0])&&(a=a.map(x=>[x.min,x.max,x.avg,x.stddev]));switch(h){case "none":a=H[this.rasterInfo.pixelType]||H.f32;for(c=0;c<l;c++)e[c]=a[0],g[c]=a[1];break;
case "minMax":for(c=0;c<l;c++)e[c]=a[c][0],g[c]=a[c][1];break;case "standardDeviation":for(c=0;c<l;c++)e[c]=a[c][2]-b.numberOfStandardDeviations*a[c][3],g[c]=a[c][2]+b.numberOfStandardDeviations*a[c][3],e[c]<a[c][0]&&(e[c]=a[c][0]),g[c]>a[c][1]&&(g[c]=a[c][1]);break;case "histogramEqualization":for(c=0;c<l;c++)e[c]=f[c].min,g[c]=f[c].max;break;case "percentClip":for(c=0;c<f.length;c++){a=f[c];n=new Uint32Array(a.size);var u=a.counts;r=0;l=(a.max-a.min)/a.size;t=-.5===a.min&&1===l?.5:0;for(p=0;p<a.size;p++)r+=
u[p],n[p]=r;u=(b.minPercent||0)*r/100;for(p=0;p<a.size;p++)if(n[p]>u){e[c]=a.min+l*(p+t);break}u=(1-(b.maxPercent||0)/100)*r;for(p=a.size-2;0<=p;p--)if(n[p]<u){g[c]=a.min+l*(p+2-t);break}}break;default:for(c=0;c<l;c++)e[c]=a[c][0],g[c]=a[c][1]}let A;"histogramEqualization"===h?(h=f[0].size||256,b=0,k&&(A=f.map(x=>q.createHistogramEqualizationLUT(x)))):(h=b.max||255,b=b.min||0);return this.getSelectedBandCutoffs({minCutOff:e,maxCutOff:g,outMax:h,outMin:b,histogramLut:A},d)};m.getSelectedBandCutoffs=
function(b,a){if(null==a||0===a.length)return b;const d=Math.max.apply(null,a),{minCutOff:k,maxCutOff:c,outMin:e,outMax:g,histogramLut:h}=b;return k.length===a.length||k.length<=d?b:{minCutOff:a.map(f=>k[f]),maxCutOff:a.map(f=>c[f]),histogramLut:h?a.map(f=>h[f]):null,outMin:e,outMax:g}};m.generateStretchWebGLParams=function(b,a,d){let k=null,c=null;var e=this.lookup&&this.lookup.colormapLut;a.colorRamp&&e&&(k=e.indexedColormap,c=e.offset);"histogramEqualization"===a.stretchType&&(a={...a,stretchType:"minMax"});
({gamma:e}=a);const g=!!(a.useGamma&&e&&e.some(u=>1!==u)),{minCutOff:h,maxCutOff:f,outMin:l,outMax:r}=this.getStretchCutoff(a,b,d);var n=0;v.isSome(b)&&(n=b.getPlaneCount(),2===n&&(b=b.clone(),b.statistics=[b.statistics[0]],b.pixels=[b.pixels[0]]));b=Math.min(3,(null==d?void 0:d.length)||n||this.rasterInfo.bandCount);d=new Float32Array(b);n=k||g?1:255;let t;for(t=0;t<b;t++)d[t]=(r-l)/(f[t]-h[t])/n;const p=new Float32Array(b);if(g)for(t=0;t<b;t++)p[t]=1<e[t]?2<e[t]?6.5+(e[t]-2)**2.5:6.5+100*(2-e[t])**
4:1;return{bandCount:b,outMin:l/n,outMax:r/n,minCutOff:h,maxCutOff:f,factor:d,useGamma:g,gamma:g?e:[1,1,1],gammaCorrection:g?p:[1,1,1],colormap:k,colormapOffset:c,stretchType:a.stretchType,type:"stretch"}};m.generateShadedReliefWebGLParams=function(b,a,d){var k,c,e;let g=null,h=null;const f=this.lookup&&this.lookup.colormapLut;b.colorRamp&&f&&(g=f.indexedColormap,h=f.offset);a=D.calculateHillshadeParams({...b,isGCS:a,resolution:d});d=null==(k=v.unwrap(this.rasterInfo.statistics))?void 0:k[0];return{...a,
minValue:null!=(c=null==d?void 0:d.min)?c:0,maxValue:null!=(e=null==d?void 0:d.max)?e:8E3,hillshadeType:"traditional"===b.hillshadeType?0:1,type:"hillshade",colormap:g,colormapOffset:h}};m._generateVectorFieldWebGLParams=function(b){var a,d,k,c,e,g;const {style:h,inputUnit:f,outputUnit:l,visualVariables:r,symbolTileSize:n,flowRepresentation:t}=b;let p;var u=null!=(a=null==r?void 0:r.find(A=>"sizeInfo"===A.type))?a:{type:"sizeInfo",field:"Magnitude",maxDataValue:null==(d=this.rasterInfo.statistics)?
void 0:d[0].max,maxSize:.8*n,minDataValue:null==(k=this.rasterInfo.statistics)?void 0:k[0].min,minSize:.2*n};a=u?u.minDataValue:null==(c=this.rasterInfo.statistics)?void 0:c[0].min;d=u?u.maxDataValue:null==(e=this.rasterInfo.statistics)?void 0:e[0].max;e=v.isSome(u.maxSize)&&v.isSome(u.minSize)?[u.minSize/n,u.maxSize/n]:[.2,.8];if("wind_speed"===h||"simple_scalar"===h)e[0]=e[1]=(e[0]+e[1])/2;c=v.isSome(a)&&v.isSome(d)?[a,d]:null;if("classified_arrow"===h)if(v.isSome(a)&&v.isSome(d)&&v.isSome(u))for(p=
[],a=(u.maxDataValue-u.minDataValue)/5,d=0;6>d;d++)p.push(u.minDataValue+a*d);else p=[0,1E-6,3.5,7,10.5,14];u="flow_to"===t===("ocean_current_kn"===h||"ocean_current_m"===h)?0:Math.PI;a=null==r?void 0:r.find(A=>"rotationInfo"===A.type);b=(null==(g=this.rasterInfo.storageInfo)?0:g.tileInfo)&&"vector-uv"===this.rasterInfo.dataType?"geographic":(null==a?void 0:a.rotationType)||b.rotationType;return{breakValues:p,dataRange:c,inputUnit:f,outputUnit:l,symbolTileSize:n,symbolPercentRange:e,style:h||"single_arrow",
rotation:u,rotationType:b,type:"vectorField"}};return z}(y.JSONSupport);B.__decorate([C.property({json:{write:!0}})],y.prototype,"rendererJSON",void 0);B.__decorate([C.property({type:M,json:{write:!0}})],y.prototype,"rasterInfo",void 0);B.__decorate([C.property({json:{write:!0}})],y.prototype,"lookup",void 0);B.__decorate([C.property()],y.prototype,"canRenderInWebGL",void 0);return y=B.__decorate([L.subclass("esri.renderers.support.RasterSymbolizer")],y)});